<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Tarefou-se!</title>

    <!-- Firebase (versão compat para uso simples em HTML) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
        }

        h1, h2, h3 {
            margin: 0 0 10px;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* LOGIN */
        #loginView {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 60px;
            background: #f4f5f7 url("capivara-login.png") center center / cover no-repeat fixed;
        }

        .login-card {
            background: #ffffff;
            padding: 32px 36px;
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(0,0,0,0.08);
            width: 360px;
        }

        .login-card h1 {
            font-size: 32px;
            font-weight: 800;
            text-align: left;
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #d0d7de;
            font-size: 14px;
            outline: none;
            background-color: #ffffff;
        }

        input[type="checkbox"] {
            transform: scale(1.05);
            margin-right: 8px;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.15);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            background: #1a73e8;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        button:hover {
            background: #185abc;
        }

        button:disabled {
            opacity: 0.7;
            cursor: default;
        }

        button:focus,
        a:focus {
            outline: 2px solid #1a73e8;
            outline-offset: 2px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .small-text {
            font-size: 12px;
            color: #666;
        }

        .error {
            color: #b00020;
            font-size: 13px;
            margin-bottom: 8px;
        }

        /* APP */
        #appView {
            display: none;
            min-height: 100vh;
        }

        header {
            background: #343a40;
            color: #fff;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
        }

        header .logo {
            font-weight: bold;
            font-size: 18px;
        }

        nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        nav a {
            margin-right: 0;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
        }

        nav a:hover {
            background: #495057;
        }

        nav a.active {
            background: #495057;
            font-weight: bold;
        }

        .user-info {
            font-size: 13px;
        }

        main {
            padding: 15px 20px 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr 1.2fr;
            gap: 20px;
        }

        .card {
            background: #fff;
            padding: 12px 14px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

        .card h2 {
            margin-bottom: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: #e9ecef;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 13px;
            color: #333;
            font-weight: 700;
        }

        .card h3 {
            font-size: 16px;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            border-bottom: 1px solid #ddd;
            padding: 6px 4px;
            text-align: left;
        }

        th {
            background: #f8f9fa;
            cursor: default;
        }

        td a {
            word-break: break-all;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
        }

        .tag-Alta { background: #dc3545; }
        .tag-Média { background: #ffc107; color:#000; }
        .tag-Baixa { background: #28a745; }

        .tag-Aberto { background: #17a2b8; }
        .tag-Em-andamento { background: #6f42c1; }
        .tag-Concluído { background: #28a745; }
        .tag-Pendente { background: #fd7e14; color: #000; }

        .actions button {
            font-size: 11px;
            padding: 4px 8px;
            margin-right: 4px;
            margin-top: 2px;
        }

        .calendar-container {
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .calendar-header span {
            font-weight: bold;
        }

        .calendar {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            padding: 10px;
        }

        .calendar table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .calendar th, .calendar td {
            width: 14.28%;
            text-align: center;
            padding: 6px 0;
            border-bottom: none;
            border-right: none;
        }

        .calendar th {
            font-weight: bold;
        }

        .calendar td {
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }

        .calendar td:hover {
            background: #e9ecef;
        }

        .calendar .today {
            border: 1px solid #007bff;
        }

        .calendar .selected {
            background: #007bff;
            color: #fff;
        }

        .calendar .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #000;
            margin: 2px auto 0;
        }

        .flex-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .flex-1 {
            flex: 1;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #f1f3f5;
        }

        .copyable {
            cursor: pointer;
            text-decoration: underline dotted;
        }

        #passwordsTable table tbody tr:hover,
        #companiesTable table tbody tr:hover,
        #tasksTable table tbody tr:hover,
        #usersTable table tbody tr:hover,
        #dayTasksList table tbody tr:hover {
            background: #f1f3f5;
        }

        .copy-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            z-index: 9999;
        }

        .copy-toast.show {
            opacity: 1;
        }

        /* MAPA / FLUXOGRAMA */
        .map-toolbar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .map-canvas {
            position: relative;
            height: 520px;
            border: 1px dashed #ccc;
            border-radius: 6px;
            background: #fafafa;
            overflow: auto;
            cursor: grab;
        }

        .map-canvas svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            transform-origin: 0 0;
            overflow: visible;
        }

        .map-nodes-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }

        .map-node {
            position: absolute;
            min-width: 120px;
            max-width: 260px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: #fff;
            border: 2px solid #4c6fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            cursor: move;
            user-select: none;
            font-weight: 600;
            color: #2d2d2d;
            transition: transform 0.08s ease;
            word-break: break-word;
            white-space: normal;
        }

        .map-node.readonly {
            cursor: default;
            border-style: dashed;
            background: #f7f7f7;
        }

        .map-node:active {
            transform: scale(1.01);
        }

        .map-panel {
            display: grid;
            grid-template-columns: minmax(320px, 360px) 1fr;
            gap: 12px;
            align-items: start;
        }

        .map-panel.readonly {
            grid-template-columns: 1fr;
        }

        .map-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .map-visual {
            width: 100%;
        }

        .map-edge-list {
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }

        @media (max-width: 900px) {
            .map-panel {
                grid-template-columns: 1fr;
            }
            .map-node {
                min-width: 100px;
                max-width: 220px;
                padding: 8px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 640px) {
            .map-node {
                min-width: 90px;
                max-width: 200px;
                padding: 6px 8px;
                font-size: 12px;
            }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal {
            background: #fff;
            width: 420px;
            max-width: 90%;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        }

        .modal h3 {
            margin-bottom: 8px;
        }

        .modal .options {
            margin: 12px 0;
        }

        .modal .options label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .modal .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
            main {
                padding: 10px;
            }
            #loginView {
                justify-content: center;
                padding: 20px;
            }
            .login-card {
                width: 100%;
                max-width: 380px;
            }
        }

        .status-dropdown {
            position: fixed;
            min-width: 160px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            background: #fff;
            z-index: 20000;
            padding: 6px;
            overflow: hidden;
            color: #222 !important;
        }

        .status-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            color: #222 !important;
            outline: none;
        }

        .status-dropdown button:hover {
            background: #f1f3f5;
        }

        .status-dropdown button span {
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView">
    <div class="login-card">
        <h1>Tarefou-se!</h1>
        <form id="loginForm">
            <div class="error" id="loginError" style="display:none;"></div>
            <label for="loginUser">E-mail</label>
            <input type="email" id="loginUser" required>
            <label for="loginPass">Senha</label>
            <input type="password" id="loginPass" required>
            <button type="submit" id="loginButton" style="width:100%; margin-top:8px;">Entrar</button>
        </form>
        <p id="loginHint" class="small-text" style="margin-top:8px;">
            Acesso via <strong>e-mail e senha</strong> cadastrados no Firebase Authentication.<br>
            Peça ao Gestor para criar seu usuário e definir seu perfil em "Usuários".
        </p>
    </div>
</div>

<!-- APP -->
<div id="appView">
    <header>
        <div class="logo">Tarefou-se!</div>
        <nav>
            <a id="nav-dashboard" onclick="showSection('dashboardSection')" class="active">Dashboard</a>
            <a id="nav-companies" onclick="showSection('companiesSection')">Empresas</a>
            <a id="nav-tasks" onclick="showSection('tasksSection')">Tarefas</a>
            <a id="nav-maps" onclick="showSection('mapsSection')">Mapa</a>
            <a id="nav-passwords" onclick="showSection('passwordsSection')">Senhas</a>
            <a id="nav-users" onclick="showSection('usersSection')">Usuários</a>
        </nav>
        <div class="user-info">
            Logado como: <span id="currentUserInfo"></span>
            &nbsp;|&nbsp;
            <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
    </header>

    <main>
        <!-- DASHBOARD -->
        <section id="dashboardSection" class="section active">
            <div class="grid">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn-secondary" onclick="changeMonth(-1)" aria-label="Mês anterior">&lt;</button>
                        <span id="monthLabel"></span>
                        <button class="btn-secondary" onclick="changeMonth(1)" aria-label="Próximo mês">&gt;</button>
                    </div>
                    <div class="calendar" id="calendar"></div>

                    <div class="card" style="margin-top:10px;">
                        <h2>Tarefas em andamento</h2>
                        <div id="inProgressList" class="small-text">
                            Nenhuma tarefa em andamento.
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h2>Cadastro de tarefas</h2>
                        <form id="taskForm">
                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskTitle">Título</label>
                                    <input type="text" id="taskTitle" required>
                                </div>
                                <div style="width:160px;">
                                    <label for="taskDate">Data</label>
                                    <input type="date" id="taskDate" required>
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskUser">Responsável</label>
                                    <select id="taskUser" required></select>
                                </div>
                                <div class="flex-1">
                                    <label for="taskCompany">Empresa relacionada</label>
                                    <select id="taskCompany" required></select>
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskStatus">Status</label>
                                    <select id="taskStatus" required>
                                        <option value="Aberto">Aberto</option>
                                        <option value="Em andamento">Em andamento</option>
                                        <option value="Concluído">Concluído</option>
                                        <option value="Pendente">Pendente</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="taskPriority">Prioridade</label>
                                    <select id="taskPriority" required>
                                        <option value="Alta">Alta</option>
                                        <option value="Média">Média</option>
                                        <option value="Baixa">Baixa</option>
                                    </select>
                                </div>
                            </div>

                            <label for="taskRecurrence">Recorrência</label>
                            <select id="taskRecurrence">
                                <option value="Nenhuma">Nenhuma</option>
                                <option value="Diária">Diária (seg a sex)</option>
                                <option value="Semanal">Semanal (seg a sex)</option>
                                <option value="Mensal">Mensal (seg a sex)</option>
                            </select>

                            <label for="taskDescription">Descrição</label>
                            <textarea id="taskDescription"></textarea>

                            <button type="submit" id="taskSubmitBtn">Salvar tarefa</button>
                            <button type="button" id="taskCancelBtn" class="btn-secondary"
                                    style="display:none; margin-left:8px;"
                                    onclick="cancelTaskEdit()">
                                Voltar
                            </button>
                            <button type="button" id="taskDeleteBtn" class="btn-secondary"
                                    style="display:none; margin-left:8px;"
                                    onclick="deleteCurrentEditingTask()">
                                Excluir tarefa
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <div class="flex-row" style="align-items:center; justify-content:space-between; gap:8px;">
                            <h2 id="dayTasksTitle" style="margin-bottom:0;">Tarefas do dia</h2>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div id="dayTasksFilterContainer" class="small-text" style="display:none; margin-right:8px;">
                                    <label for="dayTasksResponsibleFilter" style="margin-right:4px;">Responsável:</label>
                                    <select id="dayTasksResponsibleFilter" onchange="setDayTasksResponsibleFilter(this.value)">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div id="dayTasksCompanyFilterContainer" class="small-text" style="display:none; margin-right:8px;">
                                    <label for="dayTasksCompanyFilter" style="margin-right:4px;">Empresa:</label>
                                    <select id="dayTasksCompanyFilter" onchange="setDayTasksCompanyFilter(this.value)">
                                        <option value="">Todas</option>
                                    </select>
                                </div>
                                <div class="small-text" style="display:flex; align-items:center;">
                                    <input type="checkbox" id="dayTasksShowCompleted" style="margin-right:4px;">
                                    <label for="dayTasksShowCompleted">Mostrar concluídas</label>
                                </div>
                            </div>
                        </div>
                        <div id="dayTasksList" class="small-text" style="margin-top:8px;">
                            Selecione um dia no calendário para ver as tarefas.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- EMPRESAS -->
        <section id="companiesSection" class="section">
            <div class="card">
                <h2>Cadastro de empresas</h2>
                <form id="companyForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="companyName">Nome da empresa</label>
                            <input type="text" id="companyName" required>
                        </div>
                        <div style="width:220px;">
                            <label for="companyCNPJ">CNPJ/CPF</label>
                            <input type="text" id="companyCNPJ" placeholder="00.000.000/0000-00">
                        </div>
                    </div>

                    <div class="flex-row" style="align-items:flex-end;">
                        <div class="flex-1">
                            <label for="companyRegime">Regime Tributário</label>
                            <select id="companyRegime">
                                <option value="">-- Selecionar --</option>
                                <option value="Simples Nacional">Simples Nacional</option>
                                <option value="Lucro Presumido">Lucro Presumido</option>
                                <option value="Lucro Real">Lucro Real</option>
                                <option value="MEI">MEI</option>
                                <option value="Livro Caixa">Livro Caixa</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="companyOperator">Operador responsável</label>
                            <select id="companyOperator">
                                <option value="">-- Selecionar --</option>
                            </select>
                        </div>
                        <div class="flex-1" style="display:flex; align-items:flex-end; justify-content:flex-end; gap:12px;">
                            <div style="display:flex; align-items:center; margin-right:auto;">
                                <input type="checkbox" id="companyActiveBPO">
                                <label for="companyActiveBPO" style="margin:0;">Cliente ativo BPO</label>
                            </div>
                            <button type="submit" id="companySubmitBtn">Adicionar empresa</button>
                            <button type="button"
                                    id="companyCancelBtn"
                                    class="btn-secondary"
                                    style="display:none;"
                                    onclick="cancelCompanyEdit()">
                                Voltar
                            </button>
                        </div>
                    </div>

                    <div class="flex-row" style="align-items:center;">
                        <div class="flex-1">
                            <label for="companyBPOStart">Data de início do serviço BPO</label>
                            <input type="date" id="companyBPOStart">
                        </div>
                        <div style="width:220px; align-self:flex-end;">
                            <span class="small-text">Preencha apenas se já houver início do BPO.</span>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>
                    Empresas cadastradas
                    <span id="companiesCount" class="count-badge">0</span>
                    <span id="companiesActiveCount" class="count-badge" style="margin-left:8px; background:#28a745; color:#fff;">
                        0
                    </span>
                </h2>
                <div class="small-text" style="margin-top:4px;">
                    Ativos: Grupo 1 (Simples/Presumido/Real/MEI):
                    <span id="companiesActiveGroup1Count">0</span>
                    |
                    Grupo 2 (Livro Caixa):
                    <span id="companiesActiveGroup2Count">0</span>
                </div>
                <div id="companiesTable"></div>
            </div>
        </section>

        <!-- TAREFAS (apenas Gestor) -->
        <section id="tasksSection" class="section">
            <div class="card">
                <h2>Todas as tarefas</h2>

                <div class="flex-row" style="margin-bottom:10px; flex-wrap:wrap; align-items:flex-end;">
                    <div class="flex-1">
                        <label for="filterStartDate">Data inicial</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="flex-1">
                        <label for="filterEndDate">Data final</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div class="flex-1">
                        <label for="filterResponsible">Responsável</label>
                        <select id="filterResponsible">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="filterCompany">Empresa</label>
                        <select id="filterCompany">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <button type="button" onclick="applyTaskDateFilter()">Filtrar</button>
                        <button type="button" class="btn-secondary" onclick="clearTaskDateFilter()">Limpar</button>
                        <button type="button" onclick="exportTasksToExcel()">Baixar Excel</button>
                    </div>
                </div>

                <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
                    <button id="deleteSelectedBtn" type="button" class="btn-secondary" onclick="deleteSelectedTasks()" style="display:none;">
                        Excluir selecionadas
                    </button>
                </div>

                <div id="tasksTable"></div>
            </div>
        </section>

        <!-- MAPA -->
        <section id="mapsSection" class="section">
            <div class="card">
                <h2>Mapa de processos</h2>
                <p class="small-text">
                    Apenas Gestores podem criar ou editar fluxogramas. Operadores podem apenas visualizar.
                </p>
                <div class="map-toolbar">
                    <div style="min-width:240px;">
                        <label for="mapSelect">Fluxograma</label>
                        <select id="mapSelect" onchange="handleMapSelectChange()"></select>
                    </div>
                    <div class="map-edit-only" style="flex:1; min-width:260px;">
                        <label for="mapNameInput">Nome do fluxograma</label>
                        <input type="text" id="mapNameInput" placeholder="Nome do fluxograma">
                    </div>
                    <div class="map-edit-only" style="display:flex; gap:8px; align-items:flex-end;">
                        <button type="button" onclick="createMap()">Criar</button>
                        <button type="button" class="btn-secondary" onclick="renameCurrentMap()">Editar</button>
                        <button type="button" class="btn-secondary" id="mapDeleteBtn" onclick="deleteCurrentMap()">Excluir</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Editor de fluxograma</h3>
                <p class="small-text">Adicione nós, conecte-os e arraste para posicionar.</p>
                <div class="map-panel">
                    <div class="map-column map-edit-only">
                        <div style="margin-bottom:12px;">
                            <label for="mapNodeLabel">Nome do nó</label>
                            <input type="text" id="mapNodeLabel" placeholder="Ex: Receber documentos">
                            <div style="margin-top:8px;">
                                <button type="button" onclick="saveMapNode()">Salvar</button>
                                <button type="button" class="btn-secondary" onclick="resetMapNodeForm()">Limpar</button>
                                <button type="button" class="btn-secondary" id="mapNodeDeleteBtn" style="display:none; margin-left:4px;" onclick="deleteCurrentMapNode()">Excluir nó</button>
                            </div>
                        </div>
                        <div style="margin-bottom:12px;">
                            <label for="mapNodeSelect">Editar nome do nó</label>
                            <div class="flex-row">
                                <select id="mapNodeSelect"></select>
                                <button type="button" onclick="loadNodeForEdit()">Editar</button>
                            </div>
                        </div>
                        <div style="margin-top:8px;">
                            <label>Conectar</label>
                            <div class="flex-row">
                                <select id="mapEdgeFrom"></select>
                                <select id="mapEdgeTo"></select>
                            </div>
                            <div style="margin-top:8px;">
                                <button type="button" onclick="saveMapEdge()">Adicionar ligação</button>
                                <button type="button" class="btn-secondary" onclick="clearMapEdgeForm()">Limpar ligação</button>
                            </div>
                            <div class="map-edge-list" id="mapEdgesList"></div>
                        </div>
                    </div>
                    <div class="map-visual">
                        <label>Visualização</label>
                        <div class="map-canvas" id="mapCanvas">
                            <svg id="mapEdgesLayer"></svg>
                            <div class="map-nodes-layer" id="mapNodesLayer"></div>
                        </div>
                        <div class="small-text" id="mapCanvasHint" style="margin-top:6px;"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SENHAS -->
        <section id="passwordsSection" class="section">
            <div class="card">
                <h2>Senhas por empresa</h2>
                <p class="small-text">
                    Gestores podem cadastrar/alterar senhas. Operadores possuem apenas visualização.<br>
                    
                </p>
                <form id="passwordForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordCompanySelect">Empresa</label>
                            <select id="passwordCompanySelect" required></select>
                        </div>
                        <div class="flex-1">
                            <label for="passwordName">Nome / Descrição</label>
                            <input type="text" id="passwordName" required>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordSite">Link do site</label>
                            <input type="text" id="passwordSite" placeholder="https://...">
                        </div>
                        <div class="flex-1">
                            <label for="passwordUser">Usuário</label>
                            <input type="text" id="passwordUser" required>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordAgency">Agencia</label>
                            <input type="text" id="passwordAgency">
                        </div>
                        <div class="flex-1">
                            <label for="passwordAccount">Conta</label>
                            <input type="text" id="passwordAccount">
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordPass">Senha</label>
                            <input type="text" id="passwordPass" required>
                        </div>
                    </div>

                    <label for="passwordObservation">Observação</label>
                    <textarea id="passwordObservation" placeholder="Alguma observação sobre esta senha..."></textarea>

                    <button type="submit" id="passwordSubmitBtn">Salvar senha</button>
                    <button type="button" id="passwordCancelBtn" class="btn-secondary"
                            style="display:none; margin-left:8px;"
                            onclick="cancelPasswordEdit()">
                        Voltar
                    </button>
                    <button type="button" id="passwordDeleteBtn" class="btn-secondary"
                            style="display:none; margin-left:8px;"
                            onclick="deleteCurrentEditingPassword()">
                        Excluir
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>Senhas cadastradas</h2>
                <div class="flex-row" style="margin-bottom:10px; align-items:flex-end;">
                    <div class="flex-1">
                        <label for="passwordCompanyFilter">Filtrar por empresa</label>
                        <select id="passwordCompanyFilter" onchange="renderPasswordsTable()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div id="passwordsTable"></div>
            </div>
        </section>

        <!-- USUÁRIOS -->
        <section id="usersSection" class="section">
            <div class="card">
                <h2>Cadastro de usuários (vínculo com Firebase Auth)</h2>
                <p class="small-text">
                    1. Crie o usuário no <strong>Firebase Authentication (e-mail/senha)</strong> pelo console.<br>
                    2. Depois, cadastre aqui o e-mail, nome e perfil (Gestor ou Operador).<br>
                    3. As permissões no Firestore podem usar este perfil para restringir acesso.
                </p>
                <form id="userForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="userEmail">E-mail (login)</label>
                            <input type="email" id="userEmail" required>
                        </div>
                        <div class="flex-1">
                            <label for="userName">Nome de exibição</label>
                            <input type="text" id="userName" required>
                        </div>
                        <div class="flex-1">
                            <label for="userRole">Perfil</label>
                            <select id="userRole" required>
                                <option value="Gestor">Gestor</option>
                                <option value="Operador">Operador</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="userSubmitBtn">Salvar usuário</button>
                </form>
            </div>

            <div class="card">
                <h2>Usuários cadastrados</h2>
                <div id="usersTable"></div>
            </div>
        </section>
    </main>
</div>

<!-- Modal recorrência -->
<div id="recurrenceModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
        <h3 id="recurrenceModalTitle">Escolha</h3>
        <div id="recurrenceModalMessage" class="small-text" style="margin-bottom:8px;"></div>

        <div class="options">
            <label><input type="radio" name="recurrenceChoice" value="this" checked> Apenas esta tarefa selecionada</label>
            <label><input type="radio" name="recurrenceChoice" value="future"> Esta tarefa e as futuras</label>
        </div>

        <div class="buttons">
            <button id="recurrenceCancelBtn" class="btn-secondary">Cancelar</button>
            <button id="recurrenceConfirmBtn">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal tarefa em andamento -->
<div id="inProgressModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true" style="display:none;">
    <div class="modal" role="document">
        <h3 id="inProgressModalTitle">Tarefa em andamento</h3>
        <div id="inProgressModalMessage" class="small-text" style="margin-bottom:8px;"></div>
        <div class="small-text" id="inProgressModalHint" style="margin-bottom:8px;">
            Se não responder em 3 minutos, a tarefa será marcada como Pendente. Ao clicar em Finalizar, ela será marcada como Concluída.
        </div>
        <div class="buttons">
            <button id="inProgressContinueBtn">Continuar</button>
            <button id="inProgressFinishBtn" class="btn-secondary">Finalizar</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="copyToast" class="copy-toast">Copiado!</div>

<script>
    // ========================== FIREBASE CONFIG ==========================
    const firebaseConfig = {
        apiKey: "AIzaSyAtUE0oNAyM4_ZGqqAPdCyEKTsCh9Zxz2o",
        authDomain: "tarefou-se.firebaseapp.com",
        databaseURL: "https://tarefou-se-default-rtdb.firebaseio.com",
        projectId: "tarefou-se",
        storageBucket: "tarefou-se.firebasestorage.app",
        messagingSenderId: "967193019294",
        appId: "1:967193019294:web:7b029d1027633c52d48c8f",
        measurementId: "G-MTQ1H1QQSX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // ========================== DADOS EM MEMÓRIA ==========================
    let users = [];
    let companies = [];
    let tasks = [];
    let passwords = [];
    let maps = [];
    let currentMapId = null;
    let editingMapNodeId = null;
    let draggingMapNodeId = null;
    let mapDragOffset = { x: 0, y: 0 };
    let mapPan = { x: 0, y: 0 };
    let mapPanning = false;
    let mapPanStart = { x: 0, y: 0 };
    let mapPanOrigin = { x: 0, y: 0 };
    let mapScale = 1;
    const MAP_BASE_WIDTH = 1200;
    const MAP_BASE_HEIGHT = 800;
    const MAP_MIN_PCT = -20;  // allow arrastar um pouco para fora à esquerda/acima
    const MAP_MAX_PCT = 200;  // permite mais espaço à direita/abaixo
    let currentUser = null; // { id (email), email, username, role }

    let currentMonth;
    let currentYear;
    let selectedDate = null;

    let editingUserId = null;
    let editingCompanyId = null;
    let editingTaskId = null;
    let editingPasswordId = null;

    let taskFilterStart = null;
    let taskFilterEnd = null;
    let taskFilterResponsible = null;
    let taskFilterCompanyId = null;

    let dayTasksSortField = null;
    let dayTasksSortDirection = 'asc';
    let dayTasksFilterResponsible = '';
    let dayTasksFilterCompanyId = '';

    const selectedTaskIds = new Set();

    // Controle de monitoramento de tarefas em andamento
    const IN_PROGRESS_LIMIT_MS = 30 * 60 * 1000; // 30 minutos
    const IN_PROGRESS_PROMPT_TIMEOUT_MS = 3 * 60 * 1000; // 3 minutos
    let inProgressCheckInterval = null;
    let inProgressPromptState = null; // { taskId, autoTimeout }

    let __openStatusDropdown = null;
    let __openStatusDropdownAnchor = null;
    let __outsideClickHandler = null;
    let __escapeHandler = null;

    // ========================== AUXILIARES GERAIS ==========================
    async function loadData() {
        // zera caches locais
        users = [];
        companies = [];
        tasks = [];
        passwords = [];
        maps = [];

        // Carrega usuários
        try {
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                users.push({ id: doc.id, ...doc.data() });
            });
        } catch (e) {
            console.warn("Erro ao carregar 'users' (possível falta de auth):", e);
        }

        // Carrega empresas
        try {
            const companiesSnapshot = await db.collection('companies').get();
            companiesSnapshot.forEach(doc => {
                const c = { id: doc.id, ...doc.data() };
                c.activeBPO = !!c.activeBPO;
                c.bpoStart = c.bpoStart || '';
                c.operatorResponsible = c.operatorResponsible || '';
                companies.push(c);
            });
        } catch (e) {
            console.warn("Erro ao carregar 'companies':", e);
        }

        // Carrega tarefas (filtrando por perfil para reduzir leituras)
        try {
            tasks = [];
            if (currentUser) {
                let query = db.collection('tasks');
                if (currentUser.role !== 'Gestor') {
                    // Operador vê apenas as tarefas dele
                    query = query.where('responsible', '==', currentUser.username);
                }
                const tasksSnapshot = await query.get();
                tasksSnapshot.forEach(doc => {
                    const t = { id: doc.id, ...doc.data() };
                    tasks.push(t);
                });
            }
        } catch (e) {
            console.warn("Erro ao carregar 'tasks':", e);
        }

        // Carrega senhas
        try {
            const passwordsSnapshot = await db.collection('passwords').get();
            passwordsSnapshot.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                passwords.push(p);
            });
        } catch (e) {
            console.warn("Erro ao carregar 'passwords':", e);
        }

        // Carrega mapas
        try {
            const mapsSnapshot = await db.collection('maps').get();
            mapsSnapshot.forEach(doc => {
                const m = { id: doc.id, ...doc.data() };
                m.nodes = Array.isArray(m.nodes) ? m.nodes : [];
                m.nodes = m.nodes.map(n => {
                    return {
                        ...n,
                        x: typeof n.x === 'number' ? n.x : 10,
                        y: typeof n.y === 'number' ? n.y : 10
                    };
                });
                m.edges = Array.isArray(m.edges) ? m.edges : [];
                m.edges = m.edges.map(e => e && e.id ? e : { ...e, id: generateId() });
                maps.push(m);
            });
        } catch (e) {
            console.warn("Erro ao carregar 'maps':", e);
        }
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(16).slice(2);
    }

    function parseLocalDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        if (parts.length !== 3) return null;
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const day = parseInt(parts[2], 10);
        return new Date(year, month - 1, day);
    }

    function dateToISO(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function formatDateBR(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    function formatCnpjCpf(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 14);
        if (!digits) return '';

        if (digits.length <= 11) {
            let formatted = digits.slice(0, 3);
            if (digits.length > 3) formatted += '.' + digits.slice(3, 6);
            if (digits.length > 6) formatted += '.' + digits.slice(6, 9);
            if (digits.length > 9) formatted += '-' + digits.slice(9, 11);
            return formatted;
        }

        let formatted = digits.slice(0, 2);
        if (digits.length > 2) formatted += '.' + digits.slice(2, 5);
        if (digits.length > 5) formatted += '.' + digits.slice(5, 8);
        if (digits.length > 8) formatted += '/' + digits.slice(8, 12);
        if (digits.length > 12) formatted += '-' + digits.slice(12, 14);
        return formatted;
    }

    function getTodayStr() {
        return dateToISO(new Date());
    }

    function formatTimeSpent(ms) {
        if (!ms || ms <= 0) return '-';
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        if (hours > 0) return `${hours}h ${minutes}min`;
        return `${minutes}min`;
    }

    function applyStatusChange(task, newStatus) {
        const now = Date.now();
        if (typeof task.timeSpentMs !== 'number') task.timeSpentMs = 0;
        if (typeof task.currentStart !== 'number') task.currentStart = null;

        const oldStatus = task.status || 'Aberto';
        if (oldStatus === newStatus) return;

        if (oldStatus === 'Em andamento' && task.currentStart) {
            task.timeSpentMs += now - task.currentStart;
            task.currentStart = null;
        }
        if (newStatus === 'Em andamento') {
            task.currentStart = now;
        }
        task.status = newStatus;
    }

    // Reaplica a regra de recálculo: tarefas de ontem não concluídas vão para hoje como Pendente/Alta.
    function applyAutoCarryOver() {
        const todayStr = getTodayStr();
        const yesterday = parseLocalDate(todayStr);
        if (!yesterday) return;
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = dateToISO(yesterday);

        let changed = false;

        tasks.forEach(task => {
            const status = (task.status || '').toLowerCase();
            if (task.date === yesterdayStr && !status.startsWith('conclu')) {
                task.date = todayStr;
                applyStatusChange(task, 'Pendente');
                task.priority = 'Alta';
                changed = true;
            }
        });

        if (changed) {
            tasks.forEach(t => {
                try { db.collection('tasks').doc(t.id).set(t); } catch (e) {}
            });
        }

        deduplicateRecurringSameDay();
    }

        // Remove duplicatas de tarefas recorrentes no mesmo dia, mantendo somente uma ocorrência e somando tempo.
    function deduplicateRecurringSameDay() {
        const seen = new Map();
        const toDelete = [];
        const toUpdate = new Set();
        const now = Date.now();

        tasks.forEach(task => {
            if (!task || !task.date) return;
            const isRecurring = task.baseId || (task.recurrence && task.recurrence !== 'Nenhuma');
            if (!isRecurring) return;

            const baseKey = task.baseId || `${task.recurrence}|${task.title}|${task.responsible}|${task.companyId}`;
            const key = `${baseKey}|${task.date}`;

            if (!seen.has(key)) {
                seen.set(key, task);
            } else {
                const kept = seen.get(key);
                const extraTime = (task.timeSpentMs || 0) +
                    (task.status === 'Em andamento' && typeof task.currentStart === 'number'
                        ? Math.max(0, now - task.currentStart)
                        : 0);

                kept.timeSpentMs = (kept.timeSpentMs || 0) + extraTime;
                toUpdate.add(kept.id);
                toDelete.push(task.id);
            }
        });

        if (!toDelete.length && !toUpdate.size) return;

        const deleteSet = new Set(toDelete);
        tasks = tasks.filter(t => !deleteSet.has(t.id));

        toUpdate.forEach(id => {
            const t = tasks.find(x => x.id === id);
            if (t) {
                try { db.collection('tasks').doc(id).set(t); } catch (e) {}
            }
        });

        toDelete.forEach(id => {
            try { db.collection('tasks').doc(id).delete(); } catch (e) {}
        });
    }

    function closeInProgressPrompt() {
        if (inProgressPromptState && inProgressPromptState.autoTimeout) {
            clearTimeout(inProgressPromptState.autoTimeout);
        }
        inProgressPromptState = null;
        const overlay = document.getElementById('inProgressModal');
        if (overlay) {
            overlay.style.display = 'none';
            overlay.setAttribute('aria-hidden', 'true');
        }
    }

    function finalizeInProgressTask(autoTriggered = false) {
        if (!inProgressPromptState) return;
        const taskId = inProgressPromptState.taskId;
        closeInProgressPrompt();

        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        const newStatus = autoTriggered ? 'Pendente' : 'Concluído';
        applyStatusChange(task, newStatus);
        task.currentStart = null;
        try { db.collection('tasks').doc(task.id).set(task); } catch (e) {}

        refreshAllUI();
        if (autoTriggered) {
            showCopyToast('Tarefa marcada como Pendente automaticamente.');
        } else {
            showCopyToast('Tarefa marcada como Concluída.');
        }
    }

    function continueInProgressTask() {
        if (!inProgressPromptState) return;
        const taskId = inProgressPromptState.taskId;
        closeInProgressPrompt();

        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        const now = Date.now();
        if (typeof task.currentStart === 'number' && task.currentStart) {
            task.timeSpentMs = (task.timeSpentMs || 0) + (now - task.currentStart);
        }
        task.currentStart = now;
        try { db.collection('tasks').doc(task.id).set(task); } catch (e) {}

        startInProgressWatcher();
    }

    function openInProgressPrompt(task) {
        if (!task) return;

        closeInProgressPrompt();

        const overlay = document.getElementById('inProgressModal');
        const msgEl = document.getElementById('inProgressModalMessage');

        if (msgEl) {
            msgEl.innerText = `A tarefa "${task.title}" está em andamento há mais de 30 minutos. Ainda está realizando?`;
        }

        if (overlay) {
            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
        }

        const autoTimeout = setTimeout(() => finalizeInProgressTask(true), IN_PROGRESS_PROMPT_TIMEOUT_MS);
        inProgressPromptState = { taskId: task.id, autoTimeout };
    }

    function checkInProgressTasks() {
        if (!currentUser || inProgressPromptState) return;

        const now = Date.now();
        const candidate = tasks.find(t =>
            t &&
            t.status === 'Em andamento' &&
            typeof t.currentStart === 'number' &&
            t.currentStart &&
            (now - t.currentStart) >= IN_PROGRESS_LIMIT_MS
        );

        if (candidate) {
            openInProgressPrompt(candidate);
        }
    }

    function startInProgressWatcher() {
        stopInProgressWatcher();
        inProgressCheckInterval = setInterval(checkInProgressTasks, 60000);
        checkInProgressTasks();
    }

    function stopInProgressWatcher() {
        if (inProgressCheckInterval) {
            clearInterval(inProgressCheckInterval);
            inProgressCheckInterval = null;
        }
        closeInProgressPrompt();
    }

    function getVisibleTasks() {
        if (!currentUser) return [];
        if (currentUser.role === 'Gestor') return tasks.slice();
        return tasks.filter(t => t.responsible === currentUser.username);
    }

    function sortTasks(list) {
        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
        return list.sort((a, b) => {
            if (a.date === b.date) {
                return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
            }
            return (a.date || '').localeCompare(b.date || '');
        });
    }

    // ========= NOVO: intervalo padrão de 1 semana para a página de Tarefas =========
    function getDefaultWeekRangeFromToday() {
        const today = new Date();
        const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const end = new Date(start);
        end.setDate(end.getDate() + 6); // hoje + 6 dias = 7 dias de intervalo
        return {
            start: dateToISO(start),
            end: dateToISO(end)
        };
    }

    function setDefaultTaskWeekFilter(applyToInputs = true) {
        const range = getDefaultWeekRangeFromToday();
        taskFilterStart = range.start;
        taskFilterEnd = range.end;

        if (applyToInputs) {
            const startInput = document.getElementById('filterStartDate');
            const endInput = document.getElementById('filterEndDate');
            if (startInput) startInput.value = range.start;
            if (endInput) endInput.value = range.end;
        }
    }
    // =====================================================================

    // ========================== LOGIN / AUTH ==========================
    function showLogin() {
        document.getElementById('loginView').style.display = 'flex';
        document.getElementById('appView').style.display = 'none';
    }

    function showApp() {
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('appView').style.display = 'block';

        document.getElementById('currentUserInfo').innerText =
            currentUser.username + ' (' + currentUser.role + ')';

        document.getElementById('nav-users').style.display =
            currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        document.getElementById('nav-tasks').style.display =
            currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        document.getElementById('nav-maps').style.display = 'inline-block';
        document.getElementById('nav-passwords').style.display = 'inline-block';

        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.style.display = currentUser.role === 'Gestor' ? 'block' : 'none';
        }

        const delSel = document.getElementById('deleteSelectedBtn');
        if (delSel) delSel.style.display = currentUser.role === 'Gestor' ? 'inline-block' : 'inline-block';

        selectedDate = getTodayStr();
        resetTaskForm();
        resetPasswordForm();
        refreshAllUI();
    }

    async function handleLogin(event) {
        event.preventDefault();
        const emailInput = document.getElementById('loginUser');
        const passInput = document.getElementById('loginPass');
        const errorDiv = document.getElementById('loginError');
        const loginButton = document.getElementById('loginButton');

        const email = (emailInput.value || '').trim().toLowerCase();
        const password = passInput.value;

        if (!email || !password) {
            errorDiv.style.display = 'block';
            errorDiv.innerText = 'Preencha e-mail e senha.';
            return;
        }

        loginButton.disabled = true;
        loginButton.textContent = 'Entrando...';
        errorDiv.style.display = 'none';

        try {
            await auth.signInWithEmailAndPassword(email, password);
            // onAuthStateChanged vai cuidar do resto
        } catch (err) {
            console.error('Erro de login:', err);
            let msg = 'Falha ao fazer login.';
            if (err.code === 'auth/user-not-found') msg = 'Usuário não encontrado.';
            if (err.code === 'auth/wrong-password') msg = 'Senha incorreta.';
            if (err.code === 'auth/invalid-email') msg = 'E-mail inválido.';
            errorDiv.style.display = 'block';
            errorDiv.innerText = msg;
            loginButton.disabled = false;
            loginButton.textContent = 'Entrar';
        }
    }

    async function onAuthUserLoggedIn(firebaseUser) {
        if (!firebaseUser) {
            currentUser = null;
            showLogin();
            return;
        }

        const email = (firebaseUser.email || '').toLowerCase();
        if (!email) {
            alert('Conta sem e-mail não é suportada por esta aplicação.');
            try { await auth.signOut(); } catch (e) {}
            currentUser = null;
            showLogin();
            return;
        }

        // Primeiro busca o perfil do usuário (users/<email>)
        let userDoc = null;
        try {
            userDoc = await db.collection('users').doc(email).get();
        } catch (e) {
            console.error('Erro ao buscar perfil de usuário:', e);
        }

        if (!userDoc || !userDoc.exists) {
            alert('Seu login foi autenticado, mas não há cadastro de perfil para este e-mail.\n' +
                  'Peça ao Gestor para cadastrá-lo na aba "Usuários".');
            try { await auth.signOut(); } catch (e) {}
            currentUser = null;
            showLogin();
            return;
        }

        const data = userDoc.data() || {};
        currentUser = {
            id: userDoc.id,
            email: email,
            username: data.username || email,
            role: data.role || 'Operador'
        };

        // Agora carrega os dados de acordo com o perfil (Gestor/Operador)
        await loadData();

        applyAutoCarryOver();
        showApp();
        startInProgressWatcher();

        const loginButton = document.getElementById('loginButton');
        if (loginButton) {
            loginButton.disabled = false;
            loginButton.textContent = 'Entrar';
        }
        const errorDiv = document.getElementById('loginError');
        if (errorDiv) errorDiv.style.display = 'none';
    }

    async function logout() {
        editingUserId = null;
        editingCompanyId = null;
        editingTaskId = null;
        editingPasswordId = null;
        selectedTaskIds.clear();
        try {
            await auth.signOut();
        } catch (e) {
            console.error('Erro ao sair:', e);
        }
        currentUser = null;
        stopInProgressWatcher();
        showLogin();
    }

    // ========================== NAVEGAÇÃO ==========================
    function showSection(sectionId) {
        if (sectionId !== 'dashboardSection' && editingTaskId) {
            const leave = confirm('Você está editando uma tarefa. Sair sem salvar?');
            if (!leave) return;
            cancelTaskEdit();
        }
        if (sectionId !== 'companiesSection' && editingCompanyId) {
            const leave = confirm('Você está editando uma empresa. Sair sem salvar?');
            if (!leave) return;
            cancelCompanyEdit();
        }
        if (sectionId !== 'passwordsSection' && editingPasswordId) {
            const leave = confirm('Você está editando uma senha. Sair sem salvar?');
            if (!leave) return;
            cancelPasswordEdit();
        }
        if (sectionId !== 'usersSection' && editingUserId) {
            const leave = confirm('Você está editando um usuário. Sair sem salvar?');
            if (!leave) return;
            document.getElementById('userForm').reset();
            editingUserId = null;
            document.getElementById('userEmail').disabled = false;
            document.getElementById('userSubmitBtn').textContent = 'Salvar usuário';
        }

        if (sectionId === 'tasksSection' && (!currentUser || currentUser.role !== 'Gestor')) {
            alert('Apenas Gestores podem visualizar a página de tarefas.');
            sectionId = 'dashboardSection';
        }

        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));

        document.getElementById(sectionId).classList.add('active');

        if (sectionId === 'dashboardSection') {
            document.getElementById('nav-dashboard').classList.add('active');
        } else if (sectionId === 'companiesSection') {
            document.getElementById('nav-companies').classList.add('active');
        } else if (sectionId === 'tasksSection') {
            document.getElementById('nav-tasks').classList.add('active');
        } else if (sectionId === 'mapsSection') {
            document.getElementById('nav-maps').classList.add('active');
        } else if (sectionId === 'passwordsSection') {
            document.getElementById('nav-passwords').classList.add('active');
        } else if (sectionId === 'usersSection') {
            document.getElementById('nav-users').classList.add('active');
        }

        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm && currentUser) {
            passwordForm.style.display = currentUser.role === 'Gestor' ? 'block' : 'none';
        }

        refreshAllUI();
    }

    function refreshAllUI() {
        const companyForm = document.getElementById('companyForm');
        if (companyForm) {
            companyForm.style.display =
                currentUser && currentUser.role === 'Gestor' ? 'block' : 'none';
        }

        renderUserSelect();
        renderCompanyOperatorSelect();
        renderCompanySelect();
        renderTaskFilterOptions();
        renderTasksTable();
        renderTasksOverview();
        renderCompaniesTable();
        renderMapsUI();
        renderUsersTable();
        renderCalendar();
        renderInProgressTasks();
        renderPasswordCompanySelect();
        renderPasswordsTable();
        renderDayTasksResponsibleFilter();
        renderDayTasksCompanyFilter();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    // ========================== FORM TAREFA ==========================
    function resetTaskForm() {
        const form = document.getElementById('taskForm');
        if (form) form.reset();

        const taskDateInput = document.getElementById('taskDate');
        if (taskDateInput) taskDateInput.value = getTodayStr();

        const taskUserSelect = document.getElementById('taskUser');
        if (taskUserSelect) taskUserSelect.value = '';

        const taskCompanySelect = document.getElementById('taskCompany');
        if (taskCompanySelect) taskCompanySelect.value = '';

        const recurrenceSelect = document.getElementById('taskRecurrence');
        if (recurrenceSelect) recurrenceSelect.value = 'Nenhuma';

        editingTaskId = null;

        document.getElementById('taskSubmitBtn').textContent = 'Salvar tarefa';
        document.getElementById('taskDeleteBtn').style.display = 'none';
        document.getElementById('taskCancelBtn').style.display = 'none';
    }

    function cancelTaskEdit() {
        resetTaskForm();
    }

    // ========================== USUÁRIOS (PERFIS / ROLES) ==========================
    function renderUsersTable() {
        const container = document.getElementById('usersTable');
        if (!container) return;

        if (!currentUser || currentUser.role !== 'Gestor') {
            container.innerHTML = '<p class="small-text">Apenas Gestores podem visualizar e gerenciar usuários.</p>';
            return;
        }

        if (!users.length) {
            container.innerHTML = '<p class="small-text">Nenhum usuário cadastrado.</p>';
            return;
        }

        const isGestor = currentUser.role === 'Gestor';

        let html = '<div class="table-wrapper"><table><thead><tr>' +
            '<th>E-mail</th><th>Nome</th><th>Perfil</th>';
        if (isGestor) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        users.forEach(u => {
            html += `<tr>
                <td>${u.email || u.id}</td>
                <td>${u.username || '-'}</td>
                <td>${u.role || '-'}</td>`;
            if (isGestor) {
                html += `<td class="actions">
                    <button onclick="editUser('${u.id}')">Editar</button>
                    <button onclick="deleteUser('${u.id}')">Excluir</button>
                </td>`;
            }
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function renderUserSelect() {
        const select = document.getElementById('taskUser');
        if (!select) return;
        select.innerHTML = '';

        if (!currentUser) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Faça login para selecionar';
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        if (!users.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre usuários primeiro';
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione o responsável';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        if (currentUser.role === 'Operador') {
            const u = users.find(u => (u.email || u.id).toLowerCase() === currentUser.email);
            if (u) {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = `${u.username} (${u.role})`;
                select.appendChild(opt);
            }
        } else {
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = `${u.username} (${u.role})`;
                select.appendChild(opt);
            });
        }
    }

    async function handleUserForm(event) {
        event.preventDefault();
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem cadastrar usuários/perfis.');
            return;
        }

        const emailInput = document.getElementById('userEmail');
        const nameInput = document.getElementById('userName');
        const roleSelect = document.getElementById('userRole');
        const submitBtn = document.getElementById('userSubmitBtn');

        const email = (emailInput.value || '').trim().toLowerCase();
        const name = nameInput.value.trim();
        const role = roleSelect.value;

        if (!email || !name || !role) {
            alert('Preencha e-mail, nome e perfil.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Salvando...';

        try {
            if (editingUserId) {
                const u = users.find(u => u.id === editingUserId);
                if (u) {
                    u.email = email;
                    u.username = name;
                    u.role = role;
                    await db.collection('users').doc(editingUserId).set({
                        email,
                        username: name,
                        role
                    });
                }
                editingUserId = null;
                emailInput.disabled = false;
                submitBtn.textContent = 'Salvar usuário';
            } else {
                await db.collection('users').doc(email).set({
                    email,
                    username: name,
                    role
                });
                // atualiza cache local sem recarregar tudo
                users.push({
                    id: email,
                    email,
                    username: name,
                    role
                });
            }

            document.getElementById('userForm').reset();
            renderUsersTable();
            renderUserSelect();
            renderCompanyOperatorSelect();
            renderTaskFilterOptions();
            renderDayTasksResponsibleFilter();
            renderDayTasksCompanyFilter();
            showCopyToast('Usuário/perfil salvo com sucesso!');
        } catch (e) {
            console.error('Erro ao salvar usuário:', e);
            alert('Erro ao salvar usuário. Verifique as regras do Firestore.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Salvar usuário';
        }
    }

    function editUser(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem editar usuários.');
            return;
        }
        const u = users.find(u => u.id === id);
        if (!u) return;

        editingUserId = id;

        const emailInput = document.getElementById('userEmail');
        const nameInput = document.getElementById('userName');
        const roleSelect = document.getElementById('userRole');
        const submitBtn = document.getElementById('userSubmitBtn');

        emailInput.value = u.email || u.id;
        emailInput.disabled = true;
        nameInput.value = u.username || '';
        roleSelect.value = u.role || 'Operador';
        submitBtn.textContent = 'Atualizar usuário';
    }

    async function deleteUser(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir usuários/perfis.');
            return;
        }
        const u = users.find(u => u.id === id);
        if (!u) return;

        if (!confirm('Deseja realmente excluir o cadastro deste usuário (apenas o perfil do Firestore, não a conta do Firebase Auth)?')) return;

        try {
            await db.collection('users').doc(id).delete();
            users = users.filter(us => us.id !== id);
            renderUsersTable();
            renderUserSelect();
            renderCompanyOperatorSelect();
            renderTaskFilterOptions();
            renderDayTasksResponsibleFilter();
            renderDayTasksCompanyFilter();
            showCopyToast('Usuario/perfil excluido.');

        } catch (e) {
            console.error('Erro ao excluir usuário:', e);
            alert('Erro ao excluir usuário. Verifique as regras do Firestore.');
        }
    }

    // ========================== EMPRESAS ==========================
    function renderCompanyOperatorSelect() {
        const select = document.getElementById('companyOperator');
        if (!select) return;

        select.innerHTML = '';

        const operators = users.filter(u => (u.role || '').toLowerCase() === 'operador');

        if (!operators.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre operadores na aba Usuários';
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione o operador responsável';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        operators.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.username;
            opt.textContent = o.username + ' (Operador)';
            select.appendChild(opt);
        });
    }

    function applyCompanyCnpjMask() {
        const input = document.getElementById('companyCNPJ');
        if (!input) return;

        const applyMask = () => {
            input.value = formatCnpjCpf(input.value);
        };

        input.addEventListener('input', applyMask);
        applyMask();
    }

    function handleCompanyForm(event) {
        event.preventDefault();
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem cadastrar/alterar empresas.');
            return;
        }

        const nameInput = document.getElementById('companyName');
        const cnpjInput = document.getElementById('companyCNPJ');
        const regimeSelect = document.getElementById('companyRegime');
        const operatorSelect = document.getElementById('companyOperator');
        const activeCheckbox = document.getElementById('companyActiveBPO');
        const bpoStartInput = document.getElementById('companyBPOStart');
        const submitBtn = document.getElementById('companySubmitBtn');
        const cancelBtn = document.getElementById('companyCancelBtn');

        const name = nameInput.value.trim();
        const cnpj = cnpjInput ? cnpjInput.value.trim() : '';
        const regime = regimeSelect ? regimeSelect.value : '';
        const operatorResponsible = operatorSelect ? operatorSelect.value : '';
        const active = !!(activeCheckbox && activeCheckbox.checked);
        const bpoStart = (bpoStartInput && bpoStartInput.value) ? bpoStartInput.value : '';

        if (!name) {
            alert('Digite o nome da empresa.');
            return;
        }

        if (editingCompanyId) {
            const c = companies.find(c => c.id === editingCompanyId);
            if (c) {
                c.name = name;
                c.cnpj = cnpj || '';
                c.regime = regime || '';
                c.operatorResponsible = operatorResponsible || '';
                c.activeBPO = active;
                c.bpoStart = bpoStart || '';
                try { db.collection('companies').doc(c.id).set(c); } catch (e) {}
            }
            editingCompanyId = null;
            submitBtn.textContent = 'Adicionar empresa';
            if (cancelBtn) cancelBtn.style.display = 'none';
            showCopyToast('Empresa atualizada com sucesso!');
        } else {
            const newCompany = {
                id: generateId(),
                name,
                cnpj: cnpj || '',
                regime: regime || '',
                operatorResponsible: operatorResponsible || '',
                activeBPO: active,
                bpoStart: bpoStart || ''
            };
            companies.push(newCompany);
            try { db.collection('companies').doc(newCompany.id).set(newCompany); } catch (e) {}
            showCopyToast('Empresa cadastrada com sucesso!');
        }

        document.getElementById('companyForm').reset();
        const reg = document.getElementById('companyRegime');
        if (reg) reg.value = '';
        const chk = document.getElementById('companyActiveBPO');
        if (chk) chk.checked = false;
        const bpo = document.getElementById('companyBPOStart');
        if (bpo) bpo.value = '';
        const opSel = document.getElementById('companyOperator');
        if (opSel) opSel.value = '';

        renderCompaniesTable();
        renderCompanySelect();
        renderPasswordCompanySelect();
        renderDayTasksCompanyFilter();
    }

    function cancelCompanyEdit() {
        editingCompanyId = null;
        const form = document.getElementById('companyForm');
        if (form) form.reset();

        const regimeSelect = document.getElementById('companyRegime');
        if (regimeSelect) regimeSelect.value = '';
        const operatorSelect = document.getElementById('companyOperator');
        if (operatorSelect) operatorSelect.value = '';
        const activeCheckbox = document.getElementById('companyActiveBPO');
        if (activeCheckbox) activeCheckbox.checked = false;
        const bpoStartInput = document.getElementById('companyBPOStart');
        if (bpoStartInput) bpoStartInput.value = '';

        const submitBtn = document.getElementById('companySubmitBtn');
        if (submitBtn) submitBtn.textContent = 'Adicionar empresa';
        const cancelBtn = document.getElementById('companyCancelBtn');
        if (cancelBtn) cancelBtn.style.display = 'none';
    }

    function renderCompaniesTable() {
        const container = document.getElementById('companiesTable');
        if (!container) return;

        if (!companies.length) {
            document.getElementById('companiesCount').innerText = '0';
            document.getElementById('companiesActiveCount').innerText = '0';
            const g1 = document.getElementById('companiesActiveGroup1Count');
            if (g1) g1.innerText = '0';
            const g2 = document.getElementById('companiesActiveGroup2Count');
            if (g2) g2.innerText = '0';
            container.innerHTML = '<p class="small-text">Nenhuma empresa cadastrada.</p>';
            return;
        }

        document.getElementById('companiesCount').innerText = String(companies.length);
        const activeCount = companies.filter(c => !!c.activeBPO).length;
        document.getElementById('companiesActiveCount').innerText = String(activeCount);
        const activeGroup1 = companies.filter(c =>
            !!c.activeBPO &&
            ['Simples Nacional', 'Lucro Presumido', 'Lucro Real', 'MEI'].includes(c.regime)
        ).length;
        const activeGroup2 = companies.filter(c =>
            !!c.activeBPO && c.regime === 'Livro Caixa'
        ).length;
        const g1 = document.getElementById('companiesActiveGroup1Count');
        if (g1) g1.innerText = String(activeGroup1);
        const g2 = document.getElementById('companiesActiveGroup2Count');
        if (g2) g2.innerText = String(activeGroup2);

        const canManageCompanies = currentUser && currentUser.role === 'Gestor';

        let html = '<div class="table-wrapper"><table><thead><tr>' +
            '<th>Nome</th><th>CNPJ/CPF</th><th>Regime</th><th>Operador responsável</th><th>Cliente ativo</th><th>Início BPO</th>';
        if (canManageCompanies) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        companies.forEach(c => {
            const cnpjDisplay = formatCnpjCpf(c.cnpj || '') || '-';
            const regimeDisplay = c.regime && c.regime.trim() ? c.regime : '-';
            const operatorDisplay = c.operatorResponsible && c.operatorResponsible.trim() ? c.operatorResponsible : '-';
            const activeDisplay = c.activeBPO ? '<strong style="color:#155724;">Sim</strong>' : 'Não';
            const bpoStartDisplay = c.bpoStart ? formatDateBR(c.bpoStart) : '-';
            html += `<tr>
                <td>${c.name}</td>
                <td>${cnpjDisplay}</td>
                <td>${regimeDisplay}</td>
                <td>${operatorDisplay}</td>
                <td>${activeDisplay}</td>
                <td>${bpoStartDisplay}</td>`;
            if (canManageCompanies) {
                html += `<td class="actions">
                    <button onclick="editCompany('${c.id}')">Editar</button>
                    <button onclick="deleteCompany('${c.id}')">Excluir</button>
                </td>`;
            }
            html += '</tr>';
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function renderCompanySelect() {
        const select = document.getElementById('taskCompany');
        if (!select) return;
        select.innerHTML = '';

        if (!companies.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre empresas primeiro';
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione a empresa';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        companies.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
        });
    }

    function getCompanyNameById(id) {
        const c = companies.find(c => c.id === id);
        return c ? c.name : '-';
    }

    function editCompany(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem editar empresas.');
            return;
        }
        const c = companies.find(c => c.id === id);
        if (!c) return;

        editingCompanyId = id;

        document.getElementById('companyName').value = c.name || '';
        document.getElementById('companyCNPJ').value = formatCnpjCpf(c.cnpj || '');
        document.getElementById('companyRegime').value = c.regime || '';
        document.getElementById('companyOperator').value = c.operatorResponsible || '';
        document.getElementById('companyActiveBPO').checked = !!c.activeBPO;
        document.getElementById('companyBPOStart').value = c.bpoStart || '';
        document.getElementById('companySubmitBtn').textContent = 'Atualizar empresa';
        document.getElementById('companyCancelBtn').style.display = 'inline-block';

        const formEl = document.getElementById('companyForm');
        if (formEl && formEl.scrollIntoView) {
            formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function deleteCompany(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir empresas.');
            return;
        }
        if (!confirm('Deseja realmente excluir esta empresa?')) return;
        companies = companies.filter(c => c.id !== id);
        try { db.collection('companies').doc(id).delete(); } catch (e) {}
        renderCompaniesTable();
        renderCompanySelect();
        renderPasswordCompanySelect();
        renderDayTasksCompanyFilter();
        showCopyToast('Empresa excluida.');
    }

    // ========================== TAREFAS (recorrência, filtros, etc.) ==========================
    function getSeriesTasks(task) {
        if (!task) return [];
        if (task.baseId) {
            return tasks.filter(t => t.baseId === task.baseId);
        }
        return tasks.filter(t =>
            t.recurrence === task.recurrence &&
            t.title === task.title &&
            t.responsible === task.responsible &&
            t.companyId === task.companyId
        );
    }

    function getFutureSeriesTasks(task, fromDateStr) {
        const series = getSeriesTasks(task);
        const pivot = parseLocalDate(fromDateStr || (task && task.date));
        if (!pivot) return series;

        const pivotTime = pivot.getTime();
        return series.filter(t => {
            const date = parseLocalDate(t.date);
            if (!date) return true;
            return date.getTime() >= pivotTime;
        });
    }

    function createTaskClone(baseTask, dateStr) {
        const clone = {
            id: generateId(),
            title: baseTask.title,
            date: dateStr,
            responsible: baseTask.responsible,
            companyId: baseTask.companyId,
            status: baseTask.status,
            priority: baseTask.priority,
            description: baseTask.description,
            recurrence: baseTask.recurrence,
            timeSpentMs: 0,
            currentStart: null,
            baseId: baseTask.baseId || baseTask.id
        };
        tasks.push(clone);
        try { db.collection('tasks').doc(clone.id).set(clone); } catch (e) {}
    }

    function generateRecurrenceTasks(baseTask) {
        const recurrence = baseTask.recurrence || 'Nenhuma';
        if (recurrence === 'Nenhuma') return;
        if (!baseTask.date) return;

        if (!baseTask.baseId) baseTask.baseId = baseTask.id;

        const startDate = parseLocalDate(baseTask.date);
        if (!startDate) return;

        const year = startDate.getFullYear();

        function isWeekday(d) {
            const day = d.getDay();
            return day >= 1 && day <= 5;
        }

        if (recurrence === 'Diária') {
            let d = new Date(startDate);
            while (true) {
                d.setDate(d.getDate() + 1);
                if (d.getFullYear() !== year) break;
                if (isWeekday(d)) createTaskClone(baseTask, dateToISO(d));
            }
        } else if (recurrence === 'Semanal') {
            let d = new Date(startDate);
            while (true) {
                d.setDate(d.getDate() + 7);
                if (d.getFullYear() !== year) break;
                if (isWeekday(d)) createTaskClone(baseTask, dateToISO(d));
            }
        } else if (recurrence === 'Mensal') {
            const originalDay = startDate.getDate();
            let month = startDate.getMonth() + 1;
            while (true) {
                const d = new Date(year, month, originalDay);
                if (d.getFullYear() !== year) break;
                if (d.getMonth() !== month) {
                    month++;
                    if (month > 11) break;
                    continue;
                }
                if (isWeekday(d)) createTaskClone(baseTask, dateToISO(d));
                month++;
                if (month > 11) break;
            }
        }
    }

    function showRecurrenceModal(message, title = 'Escolha') {
        return new Promise((resolve) => {
            const overlay = document.getElementById('recurrenceModal');
            const msgEl = document.getElementById('recurrenceModalMessage');
            const titleEl = document.getElementById('recurrenceModalTitle');
            const confirmBtn = document.getElementById('recurrenceConfirmBtn');
            const cancelBtn = document.getElementById('recurrenceCancelBtn');

            titleEl.innerText = title;
            msgEl.innerText = message;

            const radios = overlay.querySelectorAll('input[name="recurrenceChoice"]');
            radios.forEach(r => r.checked = (r.value === 'this'));

            function cleanup() {
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
                document.removeEventListener('keydown', onKeyDown);
                overlay.style.display = 'none';
                overlay.setAttribute('aria-hidden', 'true');
            }

            function onConfirm() {
                const chosen = overlay.querySelector('input[name="recurrenceChoice"]:checked');
                const value = chosen ? chosen.value : 'this';
                cleanup();
                resolve(value === 'future' ? 'future' : 'this');
            }

            function onCancel() {
                cleanup();
                resolve(null);
            }

            function onKeyDown(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    onCancel();
                }
            }

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
            document.addEventListener('keydown', onKeyDown);

            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
        });
    }

    async function handleTaskForm(event) {
        event.preventDefault();
        if (!currentUser) {
            alert('Faça login para cadastrar tarefas.');
            return;
        }

        const title = document.getElementById('taskTitle').value.trim();
        const date = document.getElementById('taskDate').value;
        const responsible = document.getElementById('taskUser').value;
        const companyId = document.getElementById('taskCompany').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        const description = document.getElementById('taskDescription').value.trim();
        const recurrence = document.getElementById('taskRecurrence').value || 'Nenhuma';

        if (!title || !date || !responsible || !companyId) {
            alert('Preencha todos os campos obrigatórios.');
            return;
        }

        if (editingTaskId) {
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) {
                alert('Tarefa não encontrada para edição.');
            } else {
                if (task.recurrence && task.recurrence !== 'Nenhuma') {
                    const choice = await showRecurrenceModal(
                        'Esta tarefa faz parte de uma recorrência.\n\nEscolha "Apenas esta tarefa" para aplicar somente nesta data ou "Esta e as futuras" para aplicar a partir desta data em diante.',
                        'Alterar tarefa recorrente'
                    );

                    if (choice === null) return;

                    if (choice === 'future') {
                        const series = getFutureSeriesTasks(task, task.date);
                        series.forEach(t => {
                            applyStatusChange(t, status);
                            t.title = title;
                            if (t.id === task.id) t.date = date;
                            t.responsible = responsible;
                            t.companyId = companyId;
                            t.priority = priority;
                            t.description = description;
                            t.recurrence = recurrence;
                            try { db.collection('tasks').doc(t.id).set(t); } catch (e) {}
                        });
                    } else {
                        applyStatusChange(task, status);
                        task.title = title;
                        task.date = date;
                        task.responsible = responsible;
                        task.companyId = companyId;
                        task.priority = priority;
                        task.description = description;
                        task.recurrence = recurrence;
                        try { db.collection('tasks').doc(task.id).set(task); } catch (e) {}
                    }
                } else {
                    applyStatusChange(task, status);
                    task.title = title;
                    task.date = date;
                    task.responsible = responsible;
                    task.companyId = companyId;
                    task.priority = priority;
                    task.description = description;
                    task.recurrence = recurrence;
                    try { db.collection('tasks').doc(task.id).set(task); } catch (e) {}
                }
            }
        } else {
            const now = Date.now();
            const baseTask = {
                id: generateId(),
                title,
                date,
                responsible,
                companyId,
                status,
                priority,
                description,
                recurrence,
                timeSpentMs: 0,
                currentStart: null,
                baseId: null
            };
            if (status === 'Em andamento') baseTask.currentStart = now;
            baseTask.baseId = baseTask.id;

            tasks.push(baseTask);
            try { db.collection('tasks').doc(baseTask.id).set(baseTask); } catch (e) {}
            generateRecurrenceTasks(baseTask);
        }

        resetTaskForm();
        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        showCopyToast('Tarefa salva com sucesso!');
    }

    async function deleteCurrentEditingTask() {
        if (!editingTaskId) return;
        await deleteTask(editingTaskId);
        resetTaskForm();
    }

    function getFilteredTasksList() {
        let visible = sortTasks(getVisibleTasks());

        visible = visible.filter(t => {
            if (taskFilterStart || taskFilterEnd) {
                if (!t.date) return false;
                if (taskFilterStart && t.date < taskFilterStart) return false;
                if (taskFilterEnd && t.date > taskFilterEnd) return false;
            }
            if (taskFilterResponsible && t.responsible !== taskFilterResponsible) return false;
            if (taskFilterCompanyId && t.companyId !== taskFilterCompanyId) return false;
            return true;
        });

        return visible;
    }

    function applyTaskDateFilter() {
        const startInput = document.getElementById('filterStartDate');
        const endInput = document.getElementById('filterEndDate');
        const respSelect = document.getElementById('filterResponsible');
        const companySelect = document.getElementById('filterCompany');

        taskFilterStart = startInput.value || null;
        taskFilterEnd = endInput.value || null;
        taskFilterResponsible = respSelect ? (respSelect.value || null) : null;
        taskFilterCompanyId = companySelect ? (companySelect.value || null) : null;

        renderTasksTable();
    }

    function clearTaskDateFilter() {
        // Em vez de remover o filtro, volta para o intervalo padrão de 1 semana
        setDefaultTaskWeekFilter(true);

        taskFilterResponsible = null;
        taskFilterCompanyId = null;

        const respSelect = document.getElementById('filterResponsible');
        const companySelect = document.getElementById('filterCompany');
        if (respSelect) respSelect.value = '';
        if (companySelect) companySelect.value = '';

        renderTasksTable();
    }

    function exportTasksToExcel() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem exportar as tarefas.');
            return;
        }

        const list = getFilteredTasksList();
        if (!list.length) {
            alert('Não há tarefas para exportar nesse período.');
            return;
        }

        let tableHtml = '<table border="1"><thead><tr>' +
            '<th>Título</th>' +
            '<th>Data</th>' +
            '<th>Responsável</th>' +
            '<th>Empresa</th>' +
            '<th>Status</th>' +
            '<th>Prioridade</th>' +
            '<th>Recorrência</th>' +
            '<th>Tempo Em andamento</th>' +
            '<th>Descrição</th>' +
            '</tr></thead><tbody>';

        list.forEach(t => {
            const companyName = getCompanyNameById(t.companyId);
            const timeText = formatTimeSpent(t.timeSpentMs || 0);

            tableHtml += '<tr>' +
                `<td>${(t.title || '').replace(/<\/?[^>]+(>|$)/g, '')}</td>` +
                `<td>${formatDateBR(t.date || '')}</td>` +
                `<td>${t.responsible || ''}</td>` +
                `<td>${companyName || ''}</td>` +
                `<td>${t.status || ''}</td>` +
                `<td>${t.priority || ''}</td>` +
                `<td>${t.recurrence || 'Nenhuma'}</td>` +
                `<td>${timeText}</td>` +
                `<td>${(t.description || '').replace(/<\/?[^>]+(>|$)/g, '')}</td>` +
                '</tr>';
        });

        tableHtml += '</tbody></table>';

        const htmlFile = `<html><head><meta charset="UTF-8"></head><body>${tableHtml}</body></html>`;
        const blob = new Blob([htmlFile], { type: 'application/vnd.ms-excel' });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tarefas_${getTodayStr()}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showCopyToast('Planilha exportada.');
    }

    function renderTasksTable() {
        const container = document.getElementById('tasksTable');
        if (!container) return;

        if (!currentUser || currentUser.role !== 'Gestor') {
            container.innerHTML = '<p class="small-text">Apenas Gestores podem visualizar todas as tarefas.</p>';
            return;
        }

        const visible = getFilteredTasksList();

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa cadastrada nesse período.</p>';
            return;
        }

        let html = '<div class="table-wrapper"><table><thead><tr>' +
            '<th style="width:36px;"><input id="selectAllCheckbox" type="checkbox" onchange="toggleSelectAll(this)"></th>' +
            '<th>Título</th><th>Data</th><th>Responsável</th><th>Empresa</th>' +
            '<th>Status</th><th>Prioridade</th><th>Tempo Em andamento</th></tr></thead><tbody>';

        visible.forEach(t => {
            const statusClass = 'tag-' + (t.status || '').replace(/\s+/g, '-');
            const priorityClass = 'tag-' + (t.priority || '');
            const checked = selectedTaskIds.has(t.id) ? 'checked' : '';

            html += `<tr>
                <td><input type="checkbox" class="task-select-checkbox" data-taskid="${t.id}" ${checked} onchange="toggleTaskSelection(this)"></td>
                <td>${t.title}</td>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
                <td>${formatTimeSpent(t.timeSpentMs || 0)}</td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

        const delBtn = document.getElementById('deleteSelectedBtn');
        if (delBtn) delBtn.style.display = (selectedTaskIds.size > 0 && currentUser.role === 'Gestor') ? 'inline-block' : 'inline-block';

        const selectAll = document.getElementById('selectAllCheckbox');
        if (selectAll) {
            const allIds = visible.map(v => v.id);
            const allSelected = allIds.length > 0 && allIds.every(id => selectedTaskIds.has(id));
            selectAll.checked = allSelected;
            selectAll.indeterminate = selectedTaskIds.size > 0 && !allSelected;
        }
    }

    function toggleSelectAll(el) {
        const check = el.checked;
        const visible = getFilteredTasksList();
        visible.forEach(t => {
            if (check) selectedTaskIds.add(t.id);
            else selectedTaskIds.delete(t.id);
        });
        renderTasksTable();
    }

    function toggleTaskSelection(checkbox) {
        const id = checkbox.getAttribute('data-taskid');
        if (!id) return;
        if (checkbox.checked) selectedTaskIds.add(id);
        else selectedTaskIds.delete(id);
        renderTasksTable();
    }

    async function deleteSelectedTasks() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir tarefas.');
            return;
        }
        if (!selectedTaskIds.size) {
            alert('Nenhuma tarefa selecionada.');
            return;
        }

        const selected = tasks.filter(t => selectedTaskIds.has(t.id));
        if (!selected.length) {
            alert('Nenhuma tarefa válida selecionada.');
            return;
        }

        const recurringSelected = selected.filter(t => t.recurrence && t.recurrence !== 'Nenhuma');

        if (recurringSelected.length) {
            const choice = await showRecurrenceModal(
                `Existem ${recurringSelected.length} tarefa(s) recorrente(s) selecionada(s). Deseja excluir esta(s) data(s) e as futuras da série ou apenas as selecionadas?`,
                'Excluir tarefas recorrentes'
            );
            if (choice === null) return;

            if (choice === 'future') {
                const toDeleteIds = new Set();
                recurringSelected.forEach(t => {
                    const series = getFutureSeriesTasks(t, t.date);
                    series.forEach(s => toDeleteIds.add(s.id));
                });
                selected.filter(t => !(t.recurrence && t.recurrence !== 'Nenhuma')).forEach(t => toDeleteIds.add(t.id));

                if (!confirm(`Confirma excluir ${toDeleteIds.size} tarefas (inclui esta data e as futuras das séries selecionadas)?`)) return;

                toDeleteIds.forEach(id => {
                    tasks = tasks.filter(x => x.id !== id);
                    try { db.collection('tasks').doc(id).delete(); } catch (e) {}
                    selectedTaskIds.delete(id);
                });

            } else {
                if (!confirm(`Confirma excluir ${selected.length} tarefas selecionadas?`)) return;
                selected.forEach(t => {
                    tasks = tasks.filter(x => x.id !== t.id);
                    try { db.collection('tasks').doc(t.id).delete(); } catch (e) {}
                    selectedTaskIds.delete(t.id);
                });
            }
        } else {
            if (!confirm(`Confirma excluir ${selected.length} tarefas selecionadas?`)) return;
            selected.forEach(t => {
                tasks = tasks.filter(x => x.id !== t.id);
                try { db.collection('tasks').doc(t.id).delete(); } catch (e) {}
                selectedTaskIds.delete(t.id);
            });
        }

        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        showCopyToast('Tarefas excluídas.');
    }

    function renderTaskFilterOptions() {
        const respSelect = document.getElementById('filterResponsible');
        const companySelect = document.getElementById('filterCompany');

        if (respSelect) {
            const current = taskFilterResponsible || '';
            respSelect.innerHTML = '';

            const optAll = document.createElement('option');
            optAll.value = '';
            optAll.textContent = 'Todos';
            respSelect.appendChild(optAll);

            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = u.username;
                respSelect.appendChild(opt);
            });

            respSelect.value = current;
        }

        if (companySelect) {
            const currentComp = taskFilterCompanyId || '';
            companySelect.innerHTML = '';

            const optAllC = document.createElement('option');
            optAllC.value = '';
            optAllC.textContent = 'Todas';
            companySelect.appendChild(optAllC);

            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                companySelect.appendChild(opt);
            });

            companySelect.value = currentComp;
        }
    }

    async function deleteTask(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir tarefas.');
            return;
        }
        const t = tasks.find(t => t.id === id);
        if (!t) return;

        if (t.recurrence && t.recurrence !== 'Nenhuma') {
            const choice = await showRecurrenceModal(
                'Esta tarefa faz parte de uma recorrência.\n\nEscolha "Esta e as futuras" para excluir a partir desta data ou "Apenas esta tarefa" para excluir somente esta.',
                'Excluir tarefa recorrente'
            );

            if (choice === null) return;

            if (choice === 'future') {
                const series = getFutureSeriesTasks(t, t.date);
                if (!confirm(`Confirma excluir ${series.length} tarefas recorrentes (esta e as futuras)?`)) return;
                series.forEach(item => {
                    tasks = tasks.filter(x => x.id !== item.id);
                    try { db.collection('tasks').doc(item.id).delete(); } catch (e) {}
                    selectedTaskIds.delete(item.id);
                });
            } else {
                if (!confirm('Deseja realmente excluir esta tarefa?')) return;
                tasks = tasks.filter(x => x.id !== t.id);
                try { db.collection('tasks').doc(t.id).delete(); } catch (e) {}
                selectedTaskIds.delete(t.id);
            }
        } else {
            if (!confirm('Deseja realmente excluir esta tarefa?')) return;
            tasks = tasks.filter(x => x.id !== t.id);
            try { db.collection('tasks').doc(t.id).delete(); } catch (e) {}
            selectedTaskIds.delete(t.id);
        }

        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        showCopyToast('Tarefa excluída.');
    }

    function renderTasksOverview() {
        const container = document.getElementById('tasksOverview');
        if (!container) return;

        const visible = sortTasks(getVisibleTasks());
        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa cadastrada.</p>';
            return;
        }

        let html = '<div class="table-wrapper"><table><thead><tr><th>Data</th><th>Título</th><th>Resp.</th>' +
            '<th>Empresa</th><th>Status</th><th>Prioridade</th></tr></thead><tbody>';

        visible.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;
            html += `<tr>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.title}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function renderInProgressTasks() {
        const container = document.getElementById('inProgressList');
        if (!container) return;

        const list = sortTasks(
            getVisibleTasks().filter(t => t.status === 'Em andamento')
        );

        if (!list.length) {
            container.innerHTML = 'Nenhuma tarefa em andamento.';
            return;
        }

        let html = '<div class="table-wrapper"><table><thead><tr>' +
            '<th>Título</th><th>Data</th><th>Responsável</th><th>Empresa</th><th>Status</th><th>Prioridade</th>' +
            '</tr></thead><tbody>';

        list.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;

            html += `<tr>
                <td>${t.title}</td>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // ========================== CALENDÁRIO / TAREFAS DO DIA ==========================
    function renderCalendar() {
        const calendarDiv = document.getElementById('calendar');
        const monthLabel = document.getElementById('monthLabel');
        const today = new Date();
        const todayStr = getTodayStr();

        if (currentMonth === undefined || currentYear === undefined) {
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
        }

        const firstDay = new Date(currentYear, currentMonth, 1);
        const startingDay = firstDay.getDay();
        const monthLength = new Date(currentYear, currentMonth + 1, 0).getDate();

        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        monthLabel.innerText = `${monthNames[currentMonth]} de ${currentYear}`;

        const visibleTasks = getVisibleTasks();
        const tasksByDay = {};
        visibleTasks.forEach(t => {
            if (!t.date) return;
            const d = parseLocalDate(t.date);
            if (!d) return;
            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                const day = d.getDate();
                if (!tasksByDay[day]) tasksByDay[day] = [];
                tasksByDay[day].push(t);
            }
        });

        let html = '<table><thead><tr>' +
            '<th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th>' +
            '<th>Qui</th><th>Sex</th><th>Sáb</th></tr></thead><tbody><tr>';

        let day = 1;
        for (let i = 0; i < startingDay; i++) html += '<td></td>';

        for (let i = startingDay; i < 7; i++) {
            html += buildCalendarDayCell(day, monthLength, tasksByDay, todayStr);
            day++;
        }
        html += '</tr>';

        while (day <= monthLength) {
            html += '<tr>';
            for (let i = 0; i < 7 && day <= monthLength; i++) {
                html += buildCalendarDayCell(day, monthLength, tasksByDay, todayStr);
                day++;
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        calendarDiv.innerHTML = html;
    }

    function buildCalendarDayCell(day, monthLength, tasksByDay, todayStr) {
        if (day > monthLength) return '<td></td>';
        const d = new Date(currentYear, currentMonth, day);
        const dateStr = dateToISO(d);
        const isToday = dateStr === todayStr;
        const hasTasks = !!tasksByDay[day];
        const isSelected = selectedDate === dateStr;

        let classes = [];
        if (isToday) classes.push('today');
        if (isSelected) classes.push('selected');

        let html = `<td class="${classes.join(' ')}" onclick="selectDate('${dateStr}')" aria-label="Dia ${day}">`;
        html += day;
        if (hasTasks) html += '<div class="dot"></div>';
        html += '</td>';
        return html;
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        selectedDate = null;
        document.getElementById('dayTasksTitle').innerText = 'Tarefas do dia';
        document.getElementById('dayTasksList').innerHTML =
            '<span class="small-text">Selecione um dia no calendário para ver as tarefas.</span>';
        renderCalendar();
        renderInProgressTasks();
    }

    function selectDate(dateStr) {
        selectedDate = dateStr;
        renderCalendar();
        renderDayTasks(dateStr);
    }

    function setDayTasksSort(field) {
        if (dayTasksSortField === field) {
            dayTasksSortDirection = (dayTasksSortDirection === 'asc') ? 'desc' : 'asc';
        } else {
            dayTasksSortField = field;
            dayTasksSortDirection = 'asc';
        }
        if (selectedDate) renderDayTasks(selectedDate);
    }

    const STATUS_META = {
        'Aberto': { cls: 'tag-Aberto', bg: '#17a2b8', color: '#fff' },
        'Em andamento': { cls: 'tag-Em-andamento', bg: '#6f42c1', color: '#fff' },
        'Concluído': { cls: 'tag-Concluído', bg: '#28a745', color: '#fff' },
        'Pendente': { cls: 'tag-Pendente', bg: '#fd7e14', color: '#000' }
    };

    function closeStatusDropdown() {
        if (__openStatusDropdown) {
            __openStatusDropdown.remove();
            __openStatusDropdown = null;
        }
        __openStatusDropdownAnchor = null;

        if (__outsideClickHandler) {
            document.removeEventListener('click', __outsideClickHandler);
            __outsideClickHandler = null;
        }
        if (__escapeHandler) {
            document.removeEventListener('keydown', __escapeHandler);
            __escapeHandler = null;
        }
    }

    function openStatusDropdown(taskId, anchorEl) {
        if (__openStatusDropdown && __openStatusDropdownAnchor === anchorEl) {
            closeStatusDropdown();
            return;
        }

        closeStatusDropdown();

        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        if (!currentUser) {
            alert('Faça login para alterar o status.');
            return;
        }
        if (currentUser.role !== 'Gestor' && currentUser.username !== task.responsible) {
            alert('Você não tem permissão para alterar o status desta tarefa.');
            return;
        }

        const dropdown = document.createElement('div');
        dropdown.className = 'status-dropdown';

        const statuses = ['Aberto', 'Em andamento', 'Concluído', 'Pendente'];

        statuses.forEach(s => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.innerText = s;
            const meta = STATUS_META[s] || { bg: '#fff', color: '#000' };
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.gap = '8px';

            const colorBox = document.createElement('span');
            colorBox.style.display = 'inline-block';
            colorBox.style.width = '12px';
            colorBox.style.height = '12px';
            colorBox.style.borderRadius = '3px';
            colorBox.style.background = meta.bg;
            colorBox.style.border = '1px solid rgba(0,0,0,0.06)';
            btn.prepend(colorBox);

            btn.addEventListener('click', function (ev) {
                ev.stopPropagation();
                updateTaskStatus(taskId, s);
            });
            dropdown.appendChild(btn);
        });

        document.body.appendChild(dropdown);
        __openStatusDropdown = dropdown;
        __openStatusDropdownAnchor = anchorEl;

        const rect = anchorEl.getBoundingClientRect();
        const ddRect = dropdown.getBoundingClientRect();
        const margin = 8;

        let top = rect.bottom + margin;
        let left = rect.left;

        if (left + ddRect.width > window.innerWidth - 8) {
            left = Math.max(8, window.innerWidth - ddRect.width - 8);
        }

        const ddHeight = dropdown.getBoundingClientRect().height;
        if (top + ddHeight > window.innerHeight - 8) {
            top = rect.top - ddHeight - margin;
            if (top < 8) top = 8;
        }

        dropdown.style.left = left + 'px';
        dropdown.style.top = top + 'px';

        __outsideClickHandler = function (e) {
            if (!dropdown.contains(e.target) && !anchorEl.contains(e.target)) {
                closeStatusDropdown();
            }
        };
        document.addEventListener('click', __outsideClickHandler);

        __escapeHandler = function (e) {
            if (e.key === 'Escape') closeStatusDropdown();
        };
        document.addEventListener('keydown', __escapeHandler);
    }

    function updateTaskStatus(id, newStatus) {
        const t = tasks.find(t => t.id === id);
        if (!t) return;

        if (!currentUser) {
            alert('Faça login para alterar o status.');
            closeStatusDropdown();
            if (selectedDate) renderDayTasks(selectedDate);
            return;
        }
        if (currentUser.role !== 'Gestor' && currentUser.username !== t.responsible) {
            alert('Você não tem permissão para alterar o status desta tarefa.');
            closeStatusDropdown();
            if (selectedDate) renderDayTasks(selectedDate);
            return;
        }

        applyStatusChange(t, newStatus);
        try { db.collection('tasks').doc(t.id).set(t); } catch (e) {}

        closeStatusDropdown();

        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        renderTasksTable();
        showCopyToast('Status da tarefa atualizado.');
    }

    function canUseDayTasksFilters() {
        return currentUser && (currentUser.role === 'Gestor' || currentUser.role === 'Operador');
    }

    function renderDayTasksResponsibleFilter() {
        const container = document.getElementById('dayTasksFilterContainer');
        const select = document.getElementById('dayTasksResponsibleFilter');
        if (!container || !select) return;

        if (!canUseDayTasksFilters()) {
            container.style.display = 'none';
            dayTasksFilterResponsible = '';
            return;
        }

        container.style.display = 'block';

        const current = dayTasksFilterResponsible || '';
        select.innerHTML = '';

        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'Todos';
        select.appendChild(optAll);

        let allowedUsers = [];
        if (currentUser.role === 'Gestor') {
            allowedUsers = users.slice();
        } else {
            allowedUsers = users.filter(u =>
                (u.username || '').toLowerCase() === (currentUser.username || '').toLowerCase()
            );
            if (!allowedUsers.length && currentUser.username) {
                allowedUsers.push({ username: currentUser.username });
            }
        }

        allowedUsers.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.username;
            opt.textContent = u.username;
            select.appendChild(opt);
        });

        select.value = current;
        if (select.value !== current) {
            select.value = '';
            dayTasksFilterResponsible = '';
        }
    }

    function setDayTasksResponsibleFilter(value) {
        dayTasksFilterResponsible = value || '';
        if (selectedDate) renderDayTasks(selectedDate);
    }

    function renderDayTasksCompanyFilter() {
        const container = document.getElementById('dayTasksCompanyFilterContainer');
        const select = document.getElementById('dayTasksCompanyFilter');
        if (!container || !select) return;

        if (!canUseDayTasksFilters()) {
            container.style.display = 'none';
            dayTasksFilterCompanyId = '';
            return;
        }

        container.style.display = 'block';

        const current = dayTasksFilterCompanyId || '';
        select.innerHTML = '';

        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'Todas';
        select.appendChild(optAll);

        companies.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
        });

        select.value = current;
        if (select.value !== current) {
            select.value = '';
            dayTasksFilterCompanyId = '';
        }
    }

    function setDayTasksCompanyFilter(value) {
        dayTasksFilterCompanyId = value || '';
        if (selectedDate) renderDayTasks(selectedDate);
    }

    function renderDayTasks(dateStr) {
        const container = document.getElementById('dayTasksList');
        const title = document.getElementById('dayTasksTitle');
        title.innerText = 'Tarefas em ' + formatDateBR(dateStr);

        let visible = getVisibleTasks().filter(t => {
            if (t.date !== dateStr) return false;
            if (dayTasksFilterResponsible && t.responsible !== dayTasksFilterResponsible) return false;
            if (dayTasksFilterCompanyId && t.companyId !== dayTasksFilterCompanyId) return false;
            const showCompletedCheckbox = document.getElementById('dayTasksShowCompleted');
            const showCompleted = showCompletedCheckbox && showCompletedCheckbox.checked;
            if (!showCompleted && t.status === 'Concluído') return false;

            return true;
        });

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa para este dia.</p>';
            return;
        }

        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };

        if (dayTasksSortField) {
            visible.sort((a, b) => {
                let valA, valB;

                switch (dayTasksSortField) {
                    case 'title':
                        valA = (a.title || '').toUpperCase();
                        valB = (b.title || '').toUpperCase();
                        break;
                    case 'responsible':
                        valA = (a.responsible || '').toUpperCase();
                        valB = (b.responsible || '').toUpperCase();
                        break;
                    case 'company':
                        valA = (getCompanyNameById(a.companyId) || '').toUpperCase();
                        valB = (getCompanyNameById(b.companyId) || '').toUpperCase();
                        break;
                    case 'status':
                        valA = (a.status || '').toUpperCase();
                        valB = (b.status || '').toUpperCase();
                        break;
                    case 'priority':
                        valA = priorityOrder[a.priority] || 999;
                        valB = priorityOrder[b.priority] || 999;
                        break;
                    default:
                        valA = 0;
                        valB = 0;
                }

                let compare = 0;
                if (dayTasksSortField === 'priority') {
                    compare = valA - valB;
                } else {
                    if (valA < valB) compare = -1;
                    else if (valA > valB) compare = 1;
                    else compare = 0;
                }

                return (dayTasksSortDirection === 'asc') ? compare : -compare;
            });
        } else {
            visible = sortTasks(visible);
        }

        const titleArrow    = (dayTasksSortField === 'title')       ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const respArrow     = (dayTasksSortField === 'responsible') ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const companyArrow  = (dayTasksSortField === 'company')     ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const statusArrow   = (dayTasksSortField === 'status')      ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const priorityArrow = (dayTasksSortField === 'priority')    ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';

        let html = '<div class="table-wrapper"><table><thead><tr>' +
            '<th onclick="setDayTasksSort(\'title\')">Título' + titleArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'responsible\')">Resp.' + respArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'company\')">Empresa' + companyArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'status\')">Status' + statusArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'priority\')">Prioridade' + priorityArrow + '</th>' +
            '</tr></thead><tbody>';

        visible.forEach(t => {
            const prClass = 'tag-' + (t.priority || '');
            const statusClass = STATUS_META[t.status]?.cls || 'tag-Aberto';

            html += `<tr class="clickable-row" onclick="selectTaskForEdit('${t.id}')">
                <td>${t.title}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td data-taskid="${t.id}" class="status-cell">` +
                    `<span class="tag ${statusClass}" ` +
                    `onclick="(function(e){ e.stopPropagation(); const el = e.currentTarget; openStatusDropdown('${t.id}', el); })(event)">${t.status}</span>` +
                `</td>
                <td><span class="tag ${prClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function selectTaskForEdit(taskId) {
        const t = tasks.find(t => t.id === taskId);
        if (!t) return;

        editingTaskId = taskId;

        document.getElementById('taskTitle').value = t.title;
        document.getElementById('taskDate').value = t.date;
        document.getElementById('taskUser').value = t.responsible;
        document.getElementById('taskCompany').value = t.companyId;
        document.getElementById('taskStatus').value = t.status;
        document.getElementById('taskPriority').value = t.priority;
        document.getElementById('taskDescription').value = t.description || '';
        document.getElementById('taskRecurrence').value = t.recurrence || 'Nenhuma';

        document.getElementById('taskSubmitBtn').textContent = 'Atualizar tarefa';
        document.getElementById('taskDeleteBtn').style.display =
            (currentUser && currentUser.role === 'Gestor') ? 'inline-block' : 'none';
        document.getElementById('taskCancelBtn').style.display = 'inline-block';

        const formEl = document.getElementById('taskForm');
        if (formEl && formEl.scrollIntoView) {
            formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // ========================== SENHAS ==========================
    function resetPasswordForm() {
        const form = document.getElementById('passwordForm');
        if (form) form.reset();

        const companySelect = document.getElementById('passwordCompanySelect');
        if (companySelect && companySelect.options.length > 0) {
            companySelect.selectedIndex = 0;
        }

        editingPasswordId = null;
        const submitBtn = document.getElementById('passwordSubmitBtn');
        if (submitBtn) submitBtn.textContent = 'Salvar senha';
        const cancelBtn = document.getElementById('passwordCancelBtn');
        const deleteBtn = document.getElementById('passwordDeleteBtn');
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'none';
    }

    function cancelPasswordEdit() {
        resetPasswordForm();
    }

    function deleteCurrentEditingPassword() {
        if (!editingPasswordId) return;
        deletePassword(editingPasswordId);
        resetPasswordForm();
    }

    function handlePasswordForm(event) {
        event.preventDefault();

        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem gerenciar senhas.');
            return;
        }

        const companyId = document.getElementById('passwordCompanySelect').value;
        const name = document.getElementById('passwordName').value.trim();
        const site = document.getElementById('passwordSite').value.trim();
        const username = document.getElementById('passwordUser').value.trim();
        const agency = document.getElementById('passwordAgency').value.trim();
        const account = document.getElementById('passwordAccount').value.trim();
        const pass = document.getElementById('passwordPass').value.trim();
        const observation = document.getElementById('passwordObservation').value.trim();

        if (!companyId || !name || !username || !pass) {
            alert('Preencha os campos obrigatórios (empresa, nome, usuário e senha).');
            return;
        }

        if (editingPasswordId) {
            const p = passwords.find(p => p.id === editingPasswordId);
            if (!p) {
                alert('Registro de senha não encontrado para edição.');
            } else {
                p.companyId = companyId;
                p.name = name;
                p.site = site;
                p.username = username;
                p.agency = agency;
                p.account = account;
                p.password = pass;
                p.observation = observation;
                try { db.collection('passwords').doc(p.id).set(p); } catch (e) {}
            }
            showCopyToast('Senha atualizada com sucesso!');
        } else {
            const newPassword = {
                id: generateId(),
                companyId,
                name,
                site,
                username,
                agency,
                account,
                password: pass,
                observation
            };
            passwords.push(newPassword);
            try { db.collection('passwords').doc(newPassword.id).set(newPassword); } catch (e) {}
            showCopyToast('Senha salva com sucesso!');
        }

        resetPasswordForm();
        renderPasswordsTable();
    }

    function renderPasswordCompanySelect() {
        const selectForm = document.getElementById('passwordCompanySelect');
        const selectFilter = document.getElementById('passwordCompanyFilter');

        if (selectForm) {
            selectForm.innerHTML = '';

            if (!companies.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Cadastre empresas primeiro';
                opt.disabled = true;
                opt.selected = true;
                selectForm.appendChild(opt);
                selectForm.disabled = true;
            } else {
                selectForm.disabled = false;

                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Selecione a empresa';
                placeholder.disabled = true;
                placeholder.selected = true;
                selectForm.appendChild(placeholder);

                companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    selectForm.appendChild(opt);
                });
            }
        }

        if (selectFilter) {
            const current = selectFilter.value || '';
            selectFilter.innerHTML = '';

            const optAll = document.createElement('option');
            optAll.value = '';
            optAll.textContent = 'Todas';
            selectFilter.appendChild(optAll);

            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                selectFilter.appendChild(opt);
            });

            selectFilter.value = current;
        }
    }

    function showCopyToast(message) {
        const toast = document.getElementById('copyToast');
        if (!toast) return;
        toast.textContent = message || 'Copiado!';
        toast.classList.add('show');
        clearTimeout(window.__copyToastTimeout);
        window.__copyToastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, 1500);
    }

    function copyToClipboard(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showCopyToast('Copiado!');
                })
                .catch(() => {
                    fallbackCopy(text);
                });
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
            document.execCommand('copy');
            showCopyToast('Copiado!');
        } catch (e) {
            console.error('Falha ao copiar texto:', e);
        }
        document.body.removeChild(textarea);
    }

    function handleCopyClick(el) {
        const encoded = el.getAttribute('data-copy') || '';
        const text = decodeURIComponent(encoded);
        copyToClipboard(text);
    }

    function renderPasswordsTable() {
        const container = document.getElementById('passwordsTable');
        if (!container) return;

        if (!currentUser) {
            container.innerHTML = '<p class="small-text">Faça login para visualizar as senhas.</p>';
            return;
        }

        if (!passwords.length) {
            container.innerHTML = '<p class="small-text">Nenhuma senha cadastrada.</p>';
            return;
        }

        const filterSelect = document.getElementById('passwordCompanyFilter');
        const filterCompanyId = filterSelect ? (filterSelect.value || '') : '';

        let list = passwords.slice();
        if (filterCompanyId) {
            list = list.filter(p => p.companyId === filterCompanyId);
        }

        if (!list.length) {
            container.innerHTML = '<p class="small-text">Nenhuma senha encontrada para o filtro selecionado.</p>';
            return;
        }

        list.sort((a, b) => {
            const compA = (getCompanyNameById(a.companyId) || '').toUpperCase();
            const compB = (getCompanyNameById(b.companyId) || '').toUpperCase();
            if (compA < compB) return -1;
            if (compA > compB) return 1;
            const nameA = (a.name || '').toUpperCase();
            const nameB = (b.name || '').toUpperCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
        });

        const isGestor = currentUser && currentUser.role === 'Gestor';

        let html = '<div class="table-wrapper"><table><thead><tr>' +
            '<th>Empresa</th><th>Nome</th><th>Site</th><th>Usuário</th><th>Senha</th>';
        if (isGestor) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        list.forEach(p => {
            const companyName = getCompanyNameById(p.companyId);
            const siteLink = p.site
                ? `<a href="${p.site}" target="_blank" rel="noopener noreferrer">${p.site}</a>`
                : '-';

            const encodedUser = encodeURIComponent(p.username || '');
            const encodedPass = encodeURIComponent(p.password || '');

            html += `<tr>
                <td>${companyName}</td>
                <td>${p.name}</td>
                <td>${siteLink}</td>
                <td><span class="copyable" data-copy="${encodedUser}" onclick="handleCopyClick(this)">${p.username}</span></td>
                <td><span class="copyable" data-copy="${encodedPass}" onclick="handleCopyClick(this)">${p.password}</span></td>`;
            if (isGestor) {
                html += `<td class="actions">
                    <button onclick="editPassword('${p.id}')">Editar</button>
                    <button onclick="deletePassword('${p.id}')">Excluir</button>
                </td>`;
            }
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function editPassword(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem editar senhas.');
            return;
        }

        const p = passwords.find(p => p.id === id);
        if (!p) return;

        editingPasswordId = id;

        document.getElementById('passwordCompanySelect').value = p.companyId;
        document.getElementById('passwordName').value = p.name || '';
        document.getElementById('passwordSite').value = p.site || '';
        document.getElementById('passwordUser').value = p.username || '';
        document.getElementById('passwordAgency').value = p.agency || '';
        document.getElementById('passwordAccount').value = p.account || '';
        document.getElementById('passwordPass').value = p.password || '';
        document.getElementById('passwordObservation').value = p.observation || '';

        document.getElementById('passwordSubmitBtn').textContent = 'Atualizar senha';
        document.getElementById('passwordCancelBtn').style.display = 'inline-block';
        document.getElementById('passwordDeleteBtn').style.display = 'inline-block';
    }

    function deletePassword(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem excluir senhas.');
            return;
        }
        if (!confirm('Deseja realmente excluir esta senha?')) return;

        passwords = passwords.filter(p => p.id !== id);
        try { db.collection('passwords').doc(id).delete(); } catch (e) {}
        renderPasswordsTable();
        showCopyToast('Senha excluída.');
    }

    // ========================== MAPAS / FLUXOGRAMAS ==========================
    function getCurrentMap() {
        if (!currentMapId && maps.length) {
            currentMapId = maps[0].id;
        }
        return maps.find(m => m.id === currentMapId) || null;
    }

    function saveCurrentMap() {
        const map = getCurrentMap();
        if (!map) return;
        try { db.collection('maps').doc(map.id).set(map); } catch (e) {}
    }

    function toggleMapEditUI() {
        const canEdit = currentUser && currentUser.role === 'Gestor';
        document.querySelectorAll('.map-edit-only').forEach(el => {
            el.style.display = canEdit ? 'block' : 'none';
        });
        const deleteBtn = document.getElementById('mapDeleteBtn');
        if (deleteBtn) deleteBtn.style.display = canEdit ? 'inline-block' : 'none';
    }

    function renderMapSelect() {
        const select = document.getElementById('mapSelect');
        const deleteBtn = document.getElementById('mapDeleteBtn');
        if (!select) return;

        select.innerHTML = '';

        if (!maps.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Nenhum fluxograma';
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            select.disabled = true;
            currentMapId = null;
            if (deleteBtn) deleteBtn.disabled = true;
        } else {
            select.disabled = false;
            maps.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name || 'Sem nome';
                select.appendChild(opt);
            });

            if (currentMapId && maps.some(m => m.id === currentMapId)) {
                select.value = currentMapId;
            } else {
                currentMapId = maps[0].id;
                select.value = currentMapId;
            }
            if (deleteBtn) deleteBtn.disabled = !currentMapId;
        }

        const mapNameInput = document.getElementById('mapNameInput');
        const map = getCurrentMap();
        if (mapNameInput) mapNameInput.value = map ? (map.name || '') : '';
    }

    function handleMapSelectChange() {
        const select = document.getElementById('mapSelect');
        currentMapId = select ? (select.value || null) : null;
        editingMapNodeId = null;
        mapPan = { x: 0, y: 0 };
        const mapNameInput = document.getElementById('mapNameInput');
        const map = getCurrentMap();
        if (mapNameInput) mapNameInput.value = map ? (map.name || '') : '';
        renderMapsUI();
    }

    function createMap() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem criar fluxogramas.');
            return;
        }
        const input = document.getElementById('mapNameInput');
        const name = input ? input.value.trim() : '';
        if (!name) {
            alert('Informe o nome do fluxograma.');
            return;
        }
        const newMap = {
            id: generateId(),
            name,
            nodes: [],
            edges: []
        };
        maps.push(newMap);
        currentMapId = newMap.id;
        if (input) input.value = '';
        try { db.collection('maps').doc(newMap.id).set(newMap); } catch (e) {}
        renderMapsUI();
        showCopyToast('Fluxograma criado.');
    }

    function deleteCurrentMap() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem excluir fluxogramas.');
            return;
        }
        const map = getCurrentMap();
        if (!map) {
            alert('Selecione um fluxograma.');
            return;
        }
        if (!confirm('Excluir este fluxograma?')) return;
        maps = maps.filter(m => m.id !== map.id);
        try { db.collection('maps').doc(map.id).delete(); } catch (e) {}
        currentMapId = maps.length ? maps[0].id : null;
        editingMapNodeId = null;
        renderMapsUI();
        showCopyToast('Fluxograma excluido.');
    }

    function renameCurrentMap() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem editar fluxogramas.');
            return;
        }
        const map = getCurrentMap();
        if (!map) {
            alert('Selecione um fluxograma para editar.');
            return;
        }
        const input = document.getElementById('mapNameInput');
        const name = input ? input.value.trim() : '';
        if (!name) {
            alert('Informe o nome do fluxograma.');
            return;
        }
        map.name = name;
        saveCurrentMap();
        showCopyToast('Nome do fluxograma atualizado.');
        renderMapsUI();
    }

    function getNodePosition(map) {
        const count = map.nodes.length;
        const col = count % 4;
        const row = Math.floor(count / 4);
        const x = Math.min(90, 10 + col * 22);
        const y = Math.min(90, 10 + row * 22);
        return { x, y };
    }

    function resetMapNodeForm() {
        editingMapNodeId = null;
        const input = document.getElementById('mapNodeLabel');
        if (input) input.value = '';
        const delBtn = document.getElementById('mapNodeDeleteBtn');
        if (delBtn) delBtn.style.display = 'none';
        const nodeSelect = document.getElementById('mapNodeSelect');
        if (nodeSelect) nodeSelect.value = '';
    }

    function saveMapNode() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem criar/editar nós.');
            return;
        }
        const map = getCurrentMap();
        if (!map) {
            alert('Crie um fluxograma primeiro.');
            return;
        }
        const input = document.getElementById('mapNodeLabel');
        const label = input ? input.value.trim() : '';
        if (!label) {
            alert('Informe o nome do nó.');
            return;
        }

        if (editingMapNodeId) {
            const node = map.nodes.find(n => n.id === editingMapNodeId);
            if (node) {
                node.label = label;
            }
        } else {
            const pos = getNodePosition(map);
            map.nodes.push({
                id: generateId(),
                label,
                x: pos.x,
                y: pos.y
            });
        }

        saveCurrentMap();
        resetMapNodeForm();
        renderMapsUI();
        showCopyToast('Salvo');
    }

    function deleteCurrentMapNode() {
        if (!currentUser || currentUser.role !== 'Gestor') return;
        const map = getCurrentMap();
        if (!map || !editingMapNodeId) return;
        map.nodes = map.nodes.filter(n => n.id !== editingMapNodeId);
        map.edges = map.edges.filter(e => e.from !== editingMapNodeId && e.to !== editingMapNodeId);
        saveCurrentMap();
        resetMapNodeForm();
        renderMapsUI();
        showCopyToast('Nó removido.');
    }

    function saveMapEdge() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem conectar nós.');
            return;
        }
        const map = getCurrentMap();
        if (!map) {
            alert('Crie um fluxograma primeiro.');
            return;
        }

        const fromSel = document.getElementById('mapEdgeFrom');
        const toSel = document.getElementById('mapEdgeTo');
        const from = fromSel ? fromSel.value : '';
        const to = toSel ? toSel.value : '';

        if (!from || !to) {
            alert('Selecione os dois nós para conectar.');
            return;
        }
        if (from === to) {
            alert('Selecione nós diferentes.');
            return;
        }
        const exists = map.edges.some(e => e.from === from && e.to === to);
        if (exists) {
            alert('Esta ligação já existe.');
            return;
        }
        map.edges.push({ id: generateId(), from, to });
        saveCurrentMap();
        clearMapEdgeForm();
        renderMapsUI();
        showCopyToast('Ligação criada.');
    }

    function deleteMapEdge(id) {
        if (!currentUser || currentUser.role !== 'Gestor') return;
        const map = getCurrentMap();
        if (!map) return;
        map.edges = map.edges.filter(e => e.id !== id);
        saveCurrentMap();
        renderMapsUI();
    }

    function clearMapEdgeForm() {
        const fromSel = document.getElementById('mapEdgeFrom');
        const toSel = document.getElementById('mapEdgeTo');
        if (fromSel) fromSel.value = '';
        if (toSel) toSel.value = '';
    }

    function renderMapEdgeForm() {
        const fromSel = document.getElementById('mapEdgeFrom');
        const toSel = document.getElementById('mapEdgeTo');
        const listEl = document.getElementById('mapEdgesList');
        const nodeSelect = document.getElementById('mapNodeSelect');
        if (!fromSel || !toSel || !listEl) return;

        fromSel.innerHTML = '';
        toSel.innerHTML = '';
        listEl.innerHTML = '';
        if (nodeSelect) nodeSelect.innerHTML = '';

        const map = getCurrentMap();
        if (!map) {
            const p = document.createElement('p');
            p.className = 'small-text';
            p.textContent = 'Nenhum fluxograma selecionado.';
            listEl.appendChild(p);
            fromSel.disabled = true;
            toSel.disabled = true;
            if (nodeSelect) nodeSelect.disabled = true;
            return;
        }

        const nodes = map.nodes;
        const canEdit = currentUser && currentUser.role === 'Gestor';

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Nó';
        placeholder.disabled = true;
        placeholder.selected = true;
        fromSel.appendChild(placeholder.cloneNode(true));
        toSel.appendChild(placeholder.cloneNode(true));
        if (nodeSelect) {
            const placeholderNode = placeholder.cloneNode(true);
            placeholderNode.textContent = 'Selecione o nó';
            nodeSelect.appendChild(placeholderNode);
        }

        nodes.forEach(n => {
            const opt1 = document.createElement('option');
            opt1.value = n.id;
            opt1.textContent = n.label || 'Nó';
            fromSel.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = n.id;
            opt2.textContent = n.label || 'Nó';
            toSel.appendChild(opt2);

            if (nodeSelect) {
                const optNode = document.createElement('option');
                optNode.value = n.id;
                optNode.textContent = n.label || 'Nó';
                nodeSelect.appendChild(optNode);
            }
        });

        fromSel.disabled = !canEdit || !nodes.length;
        toSel.disabled = !canEdit || !nodes.length;
        if (nodeSelect) nodeSelect.disabled = !canEdit || !nodes.length;

        if (!map.edges.length) {
            const p = document.createElement('p');
            p.className = 'small-text';
            p.textContent = 'Nenhuma ligação criada.';
            listEl.appendChild(p);
        } else {
            map.edges.forEach(e => {
                const fromNode = nodes.find(n => n.id === e.from);
                const toNode = nodes.find(n => n.id === e.to);
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.alignItems = 'center';
                row.style.marginBottom = '4px';
                row.innerHTML = `<span>${fromNode ? fromNode.label : 'Nó'} -> ${toNode ? toNode.label : 'Nó'}</span>`;
                if (canEdit) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn-secondary';
                    btn.textContent = 'Excluir';
                    btn.onclick = () => deleteMapEdge(e.id);
                    row.appendChild(btn);
                }
                listEl.appendChild(row);
            });
        }
    }

    function renderMapNodeForm() {
        const delBtn = document.getElementById('mapNodeDeleteBtn');
        if (delBtn) delBtn.style.display = editingMapNodeId ? 'inline-block' : 'none';
    }

    function getMapDimensions() {
        const width = MAP_BASE_WIDTH * (MAP_MAX_PCT - MAP_MIN_PCT) / 100;
        const height = MAP_BASE_HEIGHT * (MAP_MAX_PCT - MAP_MIN_PCT) / 100;
        const offsetX = -MAP_MIN_PCT / 100 * MAP_BASE_WIDTH;
        const offsetY = -MAP_MIN_PCT / 100 * MAP_BASE_HEIGHT;
        return { width, height, offsetX, offsetY };
    }

    function renderMapCanvas() {
        const canvas = document.getElementById('mapCanvas');
        const nodesLayer = document.getElementById('mapNodesLayer');
        const edgesLayer = document.getElementById('mapEdgesLayer');
        const hint = document.getElementById('mapCanvasHint');
        if (!canvas || !nodesLayer || !edgesLayer) return;

        nodesLayer.innerHTML = '';
        edgesLayer.innerHTML = '';

        const map = getCurrentMap();
        const canEdit = currentUser && currentUser.role === 'Gestor';

        if (!map) {
            if (hint) hint.textContent = 'Crie um fluxograma para começar.';
            return;
        }

        const nodes = map.nodes || [];
        const edges = map.edges || [];
        nodes.forEach(n => {
            n.x = typeof n.x === 'number' ? n.x : 10;
            n.y = typeof n.y === 'number' ? n.y : 10;
            n.x = Math.max(MAP_MIN_PCT, Math.min(MAP_MAX_PCT, n.x));
            n.y = Math.max(MAP_MIN_PCT, Math.min(MAP_MAX_PCT, n.y));
        });

        const baseWidth = MAP_BASE_WIDTH;
        const baseHeight = MAP_BASE_HEIGHT;
        const { width: mapWidth, height: mapHeight, offsetX, offsetY } = getMapDimensions();
        nodesLayer.style.width = `${mapWidth}px`;
        nodesLayer.style.height = `${mapHeight}px`;
        edgesLayer.setAttribute('width', String(mapWidth));
        edgesLayer.setAttribute('height', String(mapHeight));
        edgesLayer.style.width = `${mapWidth}px`;
        edgesLayer.style.height = `${mapHeight}px`;
        edgesLayer.setAttribute('viewBox', `0 0 ${mapWidth} ${mapHeight}`);

        nodes.forEach(n => {
            const nodeEl = document.createElement('div');
            nodeEl.className = 'map-node' + (canEdit ? '' : ' readonly');
            nodeEl.textContent = n.label || 'Nó';
            const leftPx = (n.x / 100) * baseWidth + offsetX;
            const topPx = (n.y / 100) * baseHeight + offsetY;
            nodeEl.style.left = `${leftPx}px`;
            nodeEl.style.top = `${topPx}px`;
            nodeEl.dataset.id = n.id;
            nodeEl.onclick = () => {
                if (!canEdit) return;
                editingMapNodeId = n.id;
                const input = document.getElementById('mapNodeLabel');
                if (input) input.value = n.label || '';
                renderMapNodeForm();
            };
            if (canEdit) {
                nodeEl.onmousedown = (ev) => startMapNodeDrag(ev, n.id);
            }
            nodesLayer.appendChild(nodeEl);
        });

        const nodesMap = new Map();
        nodesLayer.childNodes.forEach(el => {
            if (el.dataset && el.dataset.id) nodesMap.set(el.dataset.id, el);
        });

        const targetWidth = canvas.clientWidth;
        mapScale = Math.min(1, Math.max(0.6, targetWidth / baseWidth));

        const buildCurvePath = (x1, y1, x2, y2) => {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const direction = dx === 0 ? 1 : Math.sign(dx);
            const curvature = Math.max(40, Math.min(Math.abs(dx) * 0.6, 160));
            const c1x = x1 + direction * curvature;
            const c2x = x2 - direction * curvature;
            const c1y = y1 + dy * 0.2;
            const c2y = y2 - dy * 0.2;
            return `M ${x1} ${y1} C ${c1x} ${c1y}, ${c2x} ${c2y}, ${x2} ${y2}`;
        };

        edges.forEach(e => {
            const fromEl = nodesMap.get(e.from);
            const toEl = nodesMap.get(e.to);
            if (!fromEl || !toEl) return;

            const fromNode = nodes.find(n => n.id === e.from);
            const toNode = nodes.find(n => n.id === e.to);
            if (!fromNode || !toNode) return;

            const fromWidth = fromEl.offsetWidth;
            const fromHeight = fromEl.offsetHeight;
            const toWidth = toEl.offsetWidth;
            const toHeight = toEl.offsetHeight;

            const fromCenterX = (fromNode.x / 100) * baseWidth + offsetX + fromWidth / 2;
            const fromCenterY = (fromNode.y / 100) * baseHeight + offsetY + fromHeight / 2;
            const toCenterX = (toNode.x / 100) * baseWidth + offsetX + toWidth / 2;
            const toCenterY = (toNode.y / 100) * baseHeight + offsetY + toHeight / 2;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', buildCurvePath(fromCenterX, fromCenterY, toCenterX, toCenterY));
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', '#7b7b65');
            path.setAttribute('stroke-width', '2.5');
            path.setAttribute('stroke-linecap', 'round');
            path.setAttribute('stroke-linejoin', 'round');
            edgesLayer.appendChild(path);
        });

        const translateStr = `translate(${mapPan.x}px, ${mapPan.y}px) scale(${mapScale})`;
        nodesLayer.style.transform = translateStr;
        edgesLayer.style.transform = translateStr;

        if (hint) {
            hint.textContent = canEdit
                ? 'Arraste os nós para posicionar. Use os campos ao lado para criar nós e ligações.'
                : 'Visualização somente leitura.';
        }
    }

    function renderMapsUI() {
        toggleMapEditUI();
        renderMapSelect();
        renderMapEdgeForm();
        renderMapNodeForm();
        renderMapCanvas();

        const mapPanel = document.querySelector('#mapsSection .map-panel');
        if (mapPanel) {
            const isGestor = currentUser && currentUser.role === 'Gestor';
            if (isGestor) {
                mapPanel.classList.remove('readonly');
            } else {
                mapPanel.classList.add('readonly');
            }
        }
    }

    function loadNodeForEdit() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem editar nós.');
            return;
        }
        const select = document.getElementById('mapNodeSelect');
        if (!select) return;
        const nodeId = select.value;
        if (!nodeId) {
            alert('Selecione o nó para editar.');
            return;
        }
        const map = getCurrentMap();
        if (!map) return;
        const node = map.nodes.find(n => n.id === nodeId);
        if (!node) return;
        editingMapNodeId = nodeId;
        const input = document.getElementById('mapNodeLabel');
        if (input) input.value = node.label || '';
        renderMapNodeForm();
    }

    function startMapNodeDrag(ev, id) {
        if (!currentUser || currentUser.role !== 'Gestor') return;
        draggingMapNodeId = id;
        const map = getCurrentMap();
        const canvas = document.getElementById('mapCanvas');
        const node = map ? map.nodes.find(n => n.id === id) : null;
        if (!map || !canvas || !node) {
            mapDragOffset = { x: 0, y: 0 };
            return;
        }

        const canvasRect = canvas.getBoundingClientRect();
        const { offsetX, offsetY } = getMapDimensions();
        const mouseLogicalX = (ev.clientX - canvasRect.left) / mapScale - mapPan.x;
        const mouseLogicalY = (ev.clientY - canvasRect.top) / mapScale - mapPan.y;
        const nodeLeft = (node.x / 100) * MAP_BASE_WIDTH + offsetX;
        const nodeTop = (node.y / 100) * MAP_BASE_HEIGHT + offsetY;
        mapDragOffset = {
            x: mouseLogicalX - nodeLeft,
            y: mouseLogicalY - nodeTop
        };
        ev.preventDefault();
    }

    function handleMapNodeDrag(ev) {
        if (!draggingMapNodeId) return;
        const map = getCurrentMap();
        const canvas = document.getElementById('mapCanvas');
        if (!map || !canvas) return;
        const rect = canvas.getBoundingClientRect();
        const { offsetX, offsetY } = getMapDimensions();
        const node = map.nodes.find(n => n.id === draggingMapNodeId);
        if (!node) return;

        const logicalX = (ev.clientX - rect.left) / mapScale - mapPan.x;
        const logicalY = (ev.clientY - rect.top) / mapScale - mapPan.y;
        let xPerc = (logicalX - mapDragOffset.x - offsetX) / MAP_BASE_WIDTH * 100;
        let yPerc = (logicalY - mapDragOffset.y - offsetY) / MAP_BASE_HEIGHT * 100;
        xPerc = Math.max(MAP_MIN_PCT, Math.min(MAP_MAX_PCT, xPerc));
        yPerc = Math.max(MAP_MIN_PCT, Math.min(MAP_MAX_PCT, yPerc));
        node.x = xPerc;
        node.y = yPerc;
        renderMapCanvas();
    }

    function stopMapNodeDrag() {
        if (!draggingMapNodeId) return;
        draggingMapNodeId = null;
        saveCurrentMap();
    }

    function startMapPan(ev) {
        const canvas = document.getElementById('mapCanvas');
        if (!canvas) return;
        if (ev.target.closest('.map-node')) return; // se clicar num nó, não pan
        if (draggingMapNodeId) return;
        mapPanning = true;
        mapPanStart = { x: ev.clientX, y: ev.clientY };
        mapPanOrigin = { ...mapPan };
        canvas.classList.add('grabbing');
        ev.preventDefault();
    }

    function handleMapPanDrag(ev) {
        if (!mapPanning) return;
        const dx = ev.clientX - mapPanStart.x;
        const dy = ev.clientY - mapPanStart.y;
        mapPan = { x: mapPanOrigin.x + dx, y: mapPanOrigin.y + dy };
        renderMapCanvas();
    }

    function stopMapPan() {
        if (!mapPanning) return;
        mapPanning = false;
        const canvas = document.getElementById('mapCanvas');
        if (canvas) canvas.classList.remove('grabbing');
    }
    // ========================== INICIALIZAÇÃO ==========================
    document.addEventListener('DOMContentLoaded', function () {
        // Não chamamos loadData aqui para evitar leituras antes do login

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('userForm').addEventListener('submit', handleUserForm);
        document.getElementById('companyForm').addEventListener('submit', handleCompanyForm);
        document.getElementById('taskForm').addEventListener('submit', handleTaskForm);

        applyCompanyCnpjMask();
        document.addEventListener('mousemove', handleMapNodeDrag);
        document.addEventListener('mouseup', stopMapNodeDrag);

        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.addEventListener('submit', handlePasswordForm);
        }

        const mapCanvas = document.getElementById('mapCanvas');
        if (mapCanvas) {
            mapCanvas.addEventListener('mousedown', startMapPan);
        }
        document.addEventListener('mousemove', handleMapPanDrag);
        document.addEventListener('mouseup', stopMapPan);

        const inProgressContinueBtn = document.getElementById('inProgressContinueBtn');
        const inProgressFinishBtn = document.getElementById('inProgressFinishBtn');
        if (inProgressContinueBtn) inProgressContinueBtn.addEventListener('click', continueInProgressTask);
        if (inProgressFinishBtn) inProgressFinishBtn.addEventListener('click', () => finalizeInProgressTask(false));

        const taskDateInput = document.getElementById('taskDate');
        function fillTodayIfEmpty() {
            if (!taskDateInput.value) taskDateInput.value = getTodayStr();
        }
        taskDateInput.addEventListener('focus', fillTodayIfEmpty);
        taskDateInput.addEventListener('click', function () {
            if (taskDateInput.dataset.pickerOpen === 'true') {
                taskDateInput.blur(); // fecha o calendário se já estiver aberto
                taskDateInput.dataset.pickerOpen = '';
                return;
            }
            fillTodayIfEmpty();
            taskDateInput.dataset.pickerOpen = 'true';
            if (taskDateInput.showPicker) taskDateInput.showPicker();
        });
        taskDateInput.addEventListener('blur', function () {
            taskDateInput.dataset.pickerOpen = '';
        });
        taskDateInput.value = getTodayStr();

        function attachDateToggle(input) {
            if (!input) return;
            input.addEventListener('click', function () {
                if (input.dataset.pickerOpen === 'true') {
                    input.blur();
                    input.dataset.pickerOpen = '';
                    return;
                }
                input.dataset.pickerOpen = 'true';
                if (input.showPicker) input.showPicker();
            });
            input.addEventListener('blur', function () {
                input.dataset.pickerOpen = '';
            });
        }

        attachDateToggle(document.getElementById('filterStartDate'));
        attachDateToggle(document.getElementById('filterEndDate'));

        const recurrenceSelect = document.getElementById('taskRecurrence');
        if (recurrenceSelect) recurrenceSelect.value = 'Nenhuma';

        renderCompanyOperatorSelect();
        renderPasswordCompanySelect();
        renderCompaniesTable();
        renderUsersTable();
        renderTaskFilterOptions();
        renderDayTasksResponsibleFilter();
        renderDayTasksCompanyFilter();
        renderCalendar();

        // Atualiza lista de tarefas do dia ao marcar/desmarcar "Mostrar concluídas"
        const dayTasksShowCompleted = document.getElementById('dayTasksShowCompleted');
        if (dayTasksShowCompleted) {
            dayTasksShowCompleted.addEventListener('change', function () {
                if (selectedDate) {
                    renderDayTasks(selectedDate);
                }
            });
        }

        // Define o filtro inicial de tarefas para 1 semana a partir de hoje
        setDefaultTaskWeekFilter(true);
        renderTasksTable();

        // Listener de sessão segura (Firebase Auth cuida do remember-me)
        auth.onAuthStateChanged(onAuthUserLoggedIn);
    });
</script>

</body>
</html>













