<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Tarefou-se!</title>

    <!-- Firebase (versão compat para uso simples em HTML) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        /* Fundo padrão da aplicação (área depois do login) */
        body {
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
        }

        h1, h2, h3 {
            margin: 0 0 10px;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* LOGIN – fundo em tela cheia com a capivara
           >>> Troque "capivara-login.png" pelo nome/caminho da sua imagem. */
        #loginView {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 40px 60px;
            background: #f4f5f7 url("capivara-login.png") center center / cover no-repeat fixed;
        }

        .login-card {
            background: #ffffff;
            padding: 32px 36px;
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(0,0,0,0.08);
            width: 360px;
        }

        .login-card h1 {
            font-size: 32px;
            font-weight: 800;
            text-align: left;
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #d0d7de;
            font-size: 14px;
            outline: none;
            background-color: #ffffff;
        }

        input[type="checkbox"] {
            transform: scale(1.05);
            margin-right: 8px;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26,115,232,0.15);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            background: #1a73e8;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        button:hover {
            background: #185abc;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .small-text {
            font-size: 12px;
            color: #666;
        }

        .error {
            color: #b00020;
            font-size: 13px;
            margin-bottom: 8px;
        }

        /* APP */
        #appView {
            display: none;
            min-height: 100vh;
        }

        header {
            background: #343a40;
            color: #fff;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header .logo {
            font-weight: bold;
            font-size: 18px;
        }

        nav a {
            margin-right: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        nav a.active {
            text-decoration: underline;
            font-weight: bold;
        }

        .user-info {
            font-size: 13px;
        }

        main {
            padding: 15px 20px 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr 1.2fr;
            gap: 20px;
        }

        .card {
            background: #fff;
            padding: 12px 14px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

        .card h2 {
            margin-bottom: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: #e9ecef;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 13px;
            color: #333;
            font-weight: 700;
        }

        .card h3 {
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            border-bottom: 1px solid #ddd;
            padding: 6px 4px;
            text-align: left;
        }

        th {
            background: #f8f9fa;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #fff;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
        }

        .tag-Alta { background: #dc3545; }
        .tag-Média { background: #ffc107; color:#000; }
        .tag-Baixa { background: #28a745; }

        .tag-Aberto { background: #17a2b8; }
        .tag-Em-andamento { background: #6f42c1; }
        .tag-Concluído { background: #28a745; }
        .tag-Pendente { background: #fd7e14; color: #000; }

        .actions button {
            font-size: 11px;
            padding: 4px 8px;
            margin-right: 4px;
            margin-top: 2px;
        }

        .calendar-container {
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .calendar-header span {
            font-weight: bold;
        }

        .calendar {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            padding: 10px;
        }

        .calendar table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .calendar th, .calendar td {
            width: 14.28%;
            text-align: center;
            padding: 6px 0;
            border-bottom: none;
            border-right: none;
        }

        .calendar th {
            font-weight: bold;
        }

        .calendar td {
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }

        .calendar td:hover {
            background: #e9ecef;
        }

        .calendar .today {
            border: 1px solid #007bff;
        }

        .calendar .selected {
            background: #007bff;
            color: #fff;
        }

        .calendar .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #000;
            margin: 2px auto 0;
        }

        .flex-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .flex-1 {
            flex: 1;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #f1f3f5;
        }

        .copyable {
            cursor: pointer;
            text-decoration: underline dotted;
        }

        /* Hover específico para a tabela de senhas */
        #passwordsTable table tbody tr:hover {
            background: #f1f3f5;
        }

        /* Hover para Empresas, Tarefas e Usuários */
        #companiesTable table tbody tr:hover,
        #tasksTable table tbody tr:hover,
        #usersTable table tbody tr:hover {
            background: #f1f3f5;
        }

        /* Toast de "Copiado!" */
        .copy-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            z-index: 9999;
        }

        .copy-toast.show {
            opacity: 1;
        }

        /* Modal de escolha de recorrência */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal {
            background: #fff;
            width: 420px;
            max-width: 90%;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        }

        .modal h3 {
            margin-bottom: 8px;
        }

        .modal .options {
            margin: 12px 0;
        }

        .modal .options label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .modal .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
            main {
                padding: 10px;
            }
            #loginView {
                justify-content: center;
                padding: 20px;
            }
            .login-card {
                width: 100%;
                max-width: 380px;
            }
        }

        /* dropdown menu style */
        .status-dropdown {
            position: fixed;
            min-width: 160px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            background: #fff;
            z-index: 20000;
            padding: 6px;
            overflow: hidden;

            /* COR FIXA (evita herdar color do header) */
            color: #222 !important;
        }

        /* garantir que os botões do dropdown tenham texto escuro e boa legibilidade */
        .status-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            color: #222 !important; /* forçar cor legível */
            outline: none;
        }

        .status-dropdown button:hover {
            background: #f1f3f5;
        }

        .status-dropdown button span {
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView">
    <div class="login-card">
        <h1>Tarefou-se!</h1>
        <form id="loginForm">
            <div class="error" id="loginError" style="display:none;"></div>
            <label for="loginUser">Usuário</label>
            <input type="text" id="loginUser" required>
            <label for="loginPass">Senha</label>
            <input type="password" id="loginPass" required>
            <button type="submit" style="width:100%; margin-top:8px;">Entrar</button>
        </form>
    </div>
</div>

<!-- APP -->
<div id="appView">
    <header>
        <div class="logo">Tarefou-se!</div>
        <nav>
            <a id="nav-dashboard" onclick="showSection('dashboardSection')" class="active">Dashboard</a>
            <a id="nav-companies" onclick="showSection('companiesSection')">Empresas</a>
            <a id="nav-tasks" onclick="showSection('tasksSection')">Tarefas</a>
            <a id="nav-passwords" onclick="showSection('passwordsSection')">Senhas</a>
            <a id="nav-users" onclick="showSection('usersSection')">Usuários</a>
        </nav>
        <div class="user-info">
            Logado como: <span id="currentUserInfo"></span>
            &nbsp;|&nbsp;
            <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
    </header>

    <main>
        <!-- DASHBOARD -->
        <section id="dashboardSection" class="section active">
            <div class="grid">
                <!-- Calendário + Tarefas em andamento -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn-secondary" onclick="changeMonth(-1)">&lt;</button>
                        <span id="monthLabel"></span>
                        <button class="btn-secondary" onclick="changeMonth(1)">&gt;</button>
                    </div>
                    <div class="calendar" id="calendar"></div>

                    <!-- Tarefas em andamento -->
                    <div class="card" style="margin-top:10px;">
                        <h2>Tarefas em andamento</h2>
                        <div id="inProgressList" class="small-text">
                            Nenhuma tarefa em andamento.
                        </div>
                    </div>
                </div>

                <!-- Lado direito: Cadastro + Tarefas do dia -->
                <div>
                    <div class="card">
                        <h2>Cadastro de tarefas</h2>
                        <form id="taskForm">
                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskTitle">Título</label>
                                    <input type="text" id="taskTitle" required>
                                </div>
                                <div style="width:160px;">
                                    <label for="taskDate">Data</label>
                                    <input type="date" id="taskDate" required>
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskUser">Responsável</label>
                                    <select id="taskUser" required></select>
                                </div>
                                <div class="flex-1">
                                    <label for="taskCompany">Empresa relacionada</label>
                                    <select id="taskCompany" required></select>
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskStatus">Status</label>
                                    <select id="taskStatus" required>
                                        <option value="Aberto">Aberto</option>
                                        <option value="Em andamento">Em andamento</option>
                                        <option value="Concluído">Concluído</option>
                                        <option value="Pendente">Pendente</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="taskPriority">Prioridade</label>
                                    <select id="taskPriority" required>
                                        <option value="Alta">Alta</option>
                                        <option value="Média">Média</option>
                                        <option value="Baixa">Baixa</option>
                                    </select>
                                </div>
                            </div>

                            <label for="taskRecurrence">Recorrência</label>
                            <select id="taskRecurrence">
                                <option value="Nenhuma">Nenhuma</option>
                                <option value="Diária">Diária (seg a sex)</option>
                                <option value="Semanal">Semanal (seg a sex)</option>
                                <option value="Mensal">Mensal (seg a sex)</option>
                            </select>

                            <label for="taskDescription">Descrição</label>
                            <textarea id="taskDescription"></textarea>

                            <button type="submit" id="taskSubmitBtn">Salvar tarefa</button>
                            <button type="button" id="taskCancelBtn" class="btn-secondary"
                                    style="display:none; margin-left:8px;"
                                    onclick="cancelTaskEdit()">
                                Voltar
                            </button>
                            <button type="button" id="taskDeleteBtn" class="btn-secondary"
                                    style="display:none; margin-left:8px;"
                                    onclick="deleteCurrentEditingTask()">
                                Excluir tarefa
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h2 id="dayTasksTitle">Tarefas do dia</h2>
                        <div id="dayTasksList" class="small-text">
                            Selecione um dia no calendário para ver as tarefas.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- EMPRESAS -->
        <section id="companiesSection" class="section">
            <div class="card">
                <h2>Cadastro de empresas</h2>
                <form id="companyForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="companyName">Nome da empresa</label>
                            <input type="text" id="companyName" required>
                        </div>
                        <div style="width:220px;">
                            <label for="companyCNPJ">CNPJ</label>
                            <input type="text" id="companyCNPJ" placeholder="00.000.000/0000-00">
                        </div>
                    </div>

                    <div class="flex-row" style="align-items:center;">
                        <div class="flex-1">
                            <label for="companyRegime">Regime Tributário</label>
                            <select id="companyRegime">
                                <option value="">-- Selecionar --</option>
                                <option value="Simples Nacional">Simples Nacional</option>
                                <option value="Lucro Presumido">Lucro Presumido</option>
                                <option value="Lucro Real">Lucro Real</option>
                                <option value="MEI">MEI</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div style="width:200px; display:flex; align-items:flex-end; gap:8px;">
                            <div style="display:flex; align-items:center;">
                                <input type="checkbox" id="companyActiveBPO">
                                <label for="companyActiveBPO" style="margin:0;">Cliente ativo BPO</label>
                            </div>
                            <div style="display:flex; align-items:flex-end;">
                                <button type="submit" id="companySubmitBtn">Adicionar empresa</button>
                            </div>
                        </div>
                    </div>

                    <!-- NOVO: campo data de início do serviço BPO -->
                    <div class="flex-row" style="align-items:center;">
                        <div class="flex-1">
                            <label for="companyBPOStart">Data de início do serviço BPO</label>
                            <input type="date" id="companyBPOStart">
                        </div>
                        <div style="width:220px; align-self:flex-end;">
                            <span class="small-text">Preencha apenas se já houver início do BPO.</span>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card">
                <h2>
                    Empresas cadastradas
                    <span id="companiesCount" class="count-badge">0</span>
                    <span id="companiesActiveCount" class="count-badge" style="margin-left:8px; background:#28a745; color:#fff;">
                        0
                    </span>
                </h2>
                <div id="companiesTable"></div>
            </div>
        </section>

        <!-- TAREFAS (apenas Gestor) -->
        <section id="tasksSection" class="section">
            <div class="card">
                <h2>Todas as tarefas</h2>

                <!-- Filtros -->
                <div class="flex-row" style="margin-bottom:10px; flex-wrap:wrap; align-items:flex-end;">
                    <div class="flex-1">
                        <label for="filterStartDate">Data inicial</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="flex-1">
                        <label for="filterEndDate">Data final</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div class="flex-1">
                        <label for="filterResponsible">Responsável</label>
                        <select id="filterResponsible">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="filterCompany">Empresa</label>
                        <select id="filterCompany">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <button type="button" onclick="applyTaskDateFilter()">Filtrar</button>
                        <button type="button" class="btn-secondary" onclick="clearTaskDateFilter()">Limpar</button>
                        <button type="button" onclick="exportTasksToExcel()">Baixar Excel</button>
                    </div>
                </div>

                <!-- Botão para excluir selecionadas -->
                <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
                    <button id="deleteSelectedBtn" type="button" class="btn-secondary" onclick="deleteSelectedTasks()" style="display:none;">
                        Excluir selecionadas
                    </button>
                </div>

                <div id="tasksTable"></div>
            </div>
        </section>

        <!-- SENHAS -->
        <section id="passwordsSection" class="section">
            <div class="card">
                <h2>Senhas por empresa</h2>
                <p class="small-text">
                    Gestores podem cadastrar/alterar senhas. Operadores possuem apenas visualização.
                </p>
                <form id="passwordForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordCompanySelect">Empresa</label>
                            <select id="passwordCompanySelect" required></select>
                        </div>
                        <div class="flex-1">
                            <label for="passwordName">Nome / Descrição</label>
                            <input type="text" id="passwordName" required>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordSite">Link do site (opcional)</label>
                            <input type="text" id="passwordSite" placeholder="https://...">
                        </div>
                        <div class="flex-1">
                            <label for="passwordUser">Usuário</label>
                            <input type="text" id="passwordUser" required>
                        </div>
                    </div>

                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="passwordPass">Senha</label>
                            <input type="text" id="passwordPass" required>
                        </div>
                    </div>

                    <label for="passwordObservation">Observação</label>
                    <textarea id="passwordObservation" placeholder="Alguma observação sobre esta senha..."></textarea>

                    <button type="submit" id="passwordSubmitBtn">Salvar senha</button>
                    <button type="button" id="passwordCancelBtn" class="btn-secondary"
                            style="display:none; margin-left:8px;"
                            onclick="cancelPasswordEdit()">
                        Voltar
                    </button>
                    <button type="button" id="passwordDeleteBtn" class="btn-secondary"
                            style="display:none; margin-left:8px;"
                            onclick="deleteCurrentEditingPassword()">
                        Excluir
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>Senhas cadastradas</h2>
                <div class="flex-row" style="margin-bottom:10px; align-items:flex-end;">
                    <div class="flex-1">
                        <label for="passwordCompanyFilter">Filtrar por empresa</label>
                        <select id="passwordCompanyFilter" onchange="renderPasswordsTable()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div id="passwordsTable"></div>
            </div>
        </section>

        <!-- USUÁRIOS -->
        <section id="usersSection" class="section">
            <div class="card">
                <h2>Cadastro de usuários</h2>
                <p class="small-text">
                    Somente Gestores devem cadastrar usuários.<br>
                    O usuário padrão <b>admin</b> (Gestor) já existe com senha <b>123</b>.
                </p>
                <form id="userForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="userName">Usuário</label>
                            <input type="text" id="userName" required>
                        </div>
                        <div class="flex-1">
                            <label for="userPassword">Senha</label>
                            <input type="text" id="userPassword" required>
                        </div>
                        <div class="flex-1">
                            <label for="userRole">Perfil</label>
                            <select id="userRole" required>
                                <option value="Gestor">Gestor</option>
                                <option value="Operador">Operador</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="userSubmitBtn">Salvar usuário</button>
                </form>
            </div>

            <div class="card">
                <h2>Usuários cadastrados</h2>
                <div id="usersTable"></div>
            </div>
        </section>
    </main>
</div>

<!-- Modal de escolha (aplicar apenas esta ocorrência ou todas) -->
<div id="recurrenceModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
        <h3 id="recurrenceModalTitle">Escolha</h3>
        <div id="recurrenceModalMessage" class="small-text" style="margin-bottom:8px;"></div>

        <div class="options">
            <label><input type="radio" name="recurrenceChoice" value="this" checked> Apenas esta(s) tarefa(s) selecionada(s)</label>
            <label><input type="radio" name="recurrenceChoice" value="all"> Todas as tarefas da(s) série(s)</label>
        </div>

        <div class="buttons">
            <button id="recurrenceCancelBtn" class="btn-secondary">Cancelar</button>
            <button id="recurrenceConfirmBtn">Confirmar</button>
        </div>
    </div>
</div>

<!-- Toast de cópia -->
<div id="copyToast" class="copy-toast">Copiado!</div>

<script>
    // ========================== FIREBASE CONFIG ==========================
    const firebaseConfig = {
        apiKey: "AIzaSyAtUE0oNAyM4_ZGqqAPdCyEKTsCh9Zxz2o",
        authDomain: "tarefou-se.firebaseapp.com",
        databaseURL: "https://tarefou-se-default-rtdb.firebaseio.com",
        projectId: "tarefou-se",
        storageBucket: "tarefou-se.firebasestorage.app",
        messagingSenderId: "967193019294",
        appId: "1:967193019294:web:7b029d1027633c52d48c8f",
        measurementId: "G-MTQ1H1QQSX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ========================== DADOS ==========================
    let users = [];
    let companies = [];
    let tasks = [];
    let passwords = [];
    let currentUser = null;

    let currentMonth;
    let currentYear;
    let selectedDate = null;

    let editingUserId = null;
    let editingCompanyId = null;
    let editingTaskId = null;
    let editingPasswordId = null;

    let taskFilterStart = null;
    let taskFilterEnd = null;
    let taskFilterResponsible = null;
    let taskFilterCompanyId = null;

    let dayTasksSortField = null;
    let dayTasksSortDirection = 'asc';

    // Selection set for multi-delete in tasks page
    const selectedTaskIds = new Set();

    // Keep a reference to the open dropdown so we can close it
    let __openStatusDropdown = null;
    // Track anchor element for toggle behavior
    let __openStatusDropdownAnchor = null;
    let __outsideClickHandler = null;
    let __escapeHandler = null;

    // ========================== FUNÇÕES AUXILIARES ==========================
    async function loadData() {
        try {
            const usersSnapshot = await db.collection('users').get();
            users = [];
            usersSnapshot.forEach(doc => users.push(doc.data()));

            const companiesSnapshot = await db.collection('companies').get();
            companies = [];
            companiesSnapshot.forEach(doc => {
                const c = doc.data();
                // garantir compatibilidade se o campo não existir
                c.activeBPO = !!c.activeBPO;
                c.bpoStart = c.bpoStart || ''; // novo campo: data de início do BPO (YYYY-MM-DD)
                companies.push(c);
            });

            const tasksSnapshot = await db.collection('tasks').get();
            tasks = [];
            tasksSnapshot.forEach(doc => tasks.push(doc.data()));

            const passwordsSnapshot = await db.collection('passwords').get();
            passwords = [];
            passwordsSnapshot.forEach(doc => passwords.push(doc.data()));
        } catch (e) {
            console.error("Erro ao carregar dados do Firestore (rodando offline ou sem permissão?):", e);
            // fallback: manter arrays vazios — ensureDefaultAdmin cuidará do admin local
        }
    }

    function saveUsers() {
        users.forEach(u => {
            try { db.collection('users').doc(u.id).set(u); } catch (e) { /* ignore */ }
        });
    }
    function saveCompanies() {
        companies.forEach(c => {
            try { db.collection('companies').doc(c.id).set(c); } catch (e) { /* ignore */ }
        });
    }
    function saveTasks() {
        tasks.forEach(t => {
            try { db.collection('tasks').doc(t.id).set(t); } catch (e) { /* ignore */ }
        });
    }
    function savePasswords() {
        passwords.forEach(p => {
            try { db.collection('passwords').doc(p.id).set(p); } catch (e) { /* ignore */ }
        });
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(16).slice(2);
    }

    function parseLocalDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        if (parts.length !== 3) return null;
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const day = parseInt(parts[2], 10);
        return new Date(year, month - 1, day);
    }

    function dateToISO(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function formatDateBR(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    function getTodayStr() {
        return dateToISO(new Date());
    }

    function formatTimeSpent(ms) {
        if (!ms || ms <= 0) return '-';
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        if (hours > 0) return `${hours}h ${minutes}min`;
        return `${minutes}min`;
    }

    function ensureDefaultAdmin() {
        // garante admin local se não existir — útil se Firestore não carregou
        if (!users.some(u => u.username === 'admin')) {
            const adminUser = {
                id: generateId(),
                username: 'admin',
                password: '123',
                role: 'Gestor'
            };
            users.push(adminUser);
            try { db.collection('users').doc(adminUser.id).set(adminUser); } catch (e) { /* ignore write error */ }
        }
    }

    function applyStatusChange(task, newStatus) {
        const now = Date.now();

        if (typeof task.timeSpentMs !== 'number') task.timeSpentMs = 0;
        if (typeof task.currentStart !== 'number') task.currentStart = null;

        const oldStatus = task.status || 'Aberto';
        if (oldStatus === newStatus) return;

        if (oldStatus === 'Em andamento' && task.currentStart) {
            task.timeSpentMs += now - task.currentStart;
            task.currentStart = null;
        }

        if (newStatus === 'Em andamento') {
            task.currentStart = now;
        }

        task.status = newStatus;
    }

    function applyAutoCarryOver() {
        const todayStr = getTodayStr();
        const todayDate = parseLocalDate(todayStr);
        let changed = false;

        tasks.forEach(task => {
            if (task.status !== 'Concluído' && task.date && task.date < todayStr) {
                let d = parseLocalDate(task.date);
                if (!d) return;
                while (d < todayDate) d.setDate(d.getDate() + 1);
                task.date = dateToISO(d);
                applyStatusChange(task, 'Pendente');
                changed = true;
            }
        });

        if (changed) saveTasks();
    }

    function getVisibleTasks() {
        if (!currentUser) return [];
        if (currentUser.role === 'Gestor') return tasks.slice();
        return tasks.filter(t => t.responsible === currentUser.username);
    }

    function sortTasks(list) {
        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
        return list.sort((a, b) => {
            if (a.date === b.date) {
                return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
            }
            return (a.date || '').localeCompare(b.date || '');
        });
    }

    // ========================== LOGIN / SESSÃO ==========================
    function showLogin() {
        document.getElementById('loginView').style.display = 'flex';
        document.getElementById('appView').style.display = 'none';
    }

    function showApp() {
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('appView').style.display = 'block';

        document.getElementById('currentUserInfo').innerText =
            currentUser.username + ' (' + currentUser.role + ')';

        document.getElementById('nav-users').style.display =
            currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        document.getElementById('nav-tasks').style.display =
            currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        // Senhas visível para Gestor e Operador
        document.getElementById('nav-passwords').style.display = 'inline-block';

        // Form de senhas só para Gestor (Operador apenas visualiza)
        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.style.display = currentUser.role === 'Gestor' ? 'block' : 'none';
        }

        // botão excluir selecionadas só para gestor
        const delSel = document.getElementById('deleteSelectedBtn');
        if (delSel) delSel.style.display = currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        selectedDate = getTodayStr();
        resetTaskForm();
        resetPasswordForm();
        refreshAllUI();
    }

    async function handleLogin(event) {
        event.preventDefault();
        const userInput = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value;
        const errorDiv = document.getElementById('loginError');

        // Se a lista users ainda não foi carregada (ou está vazia), garantir admin local
        if (!users || users.length === 0) {
            ensureDefaultAdmin();
        }

        const found = users.find(u => u.username === userInput && u.password === pass);

        if (!found) {
            // feedback mais claro
            errorDiv.style.display = 'block';
            errorDiv.innerText = 'Usuário ou senha inválidos. Verifique e tente novamente (usuário padrão: admin / 123).';
            return;
        }

        currentUser = { id: found.id, username: found.username, role: found.role };
        localStorage.setItem('miniERP_currentUser', JSON.stringify(currentUser));
        errorDiv.style.display = 'none';

        applyAutoCarryOver();
        showApp();
    }

    function logout() {
        currentUser = null;
        editingUserId = null;
        editingCompanyId = null;
        editingTaskId = null;
        editingPasswordId = null;
        localStorage.removeItem('miniERP_currentUser');
        showLogin();
    }

    // ========================== NAVEGAÇÃO ==========================
    function showSection(sectionId) {
        if (sectionId === 'tasksSection' && (!currentUser || currentUser.role !== 'Gestor')) {
            alert('Apenas Gestores podem visualizar a página de tarefas.');
            sectionId = 'dashboardSection';
        }

        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));

        document.getElementById(sectionId).classList.add('active');

        if (sectionId === 'dashboardSection') {
            document.getElementById('nav-dashboard').classList.add('active');
        } else if (sectionId === 'companiesSection') {
            document.getElementById('nav-companies').classList.add('active');
        } else if (sectionId === 'tasksSection') {
            document.getElementById('nav-tasks').classList.add('active');
        } else if (sectionId === 'passwordsSection') {
            document.getElementById('nav-passwords').classList.add('active');
        } else if (sectionId === 'usersSection') {
            document.getElementById('nav-users').classList.add('active');
        }

        // Atualiza visibilidade do formulário de senhas conforme o perfil
        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm && currentUser) {
            passwordForm.style.display = currentUser.role === 'Gestor' ? 'block' : 'none';
        }

        refreshAllUI();
    }

    function refreshAllUI() {
        renderUserSelect();
        renderCompanySelect();
        renderTaskFilterOptions();
        renderTasksTable();
        renderTasksOverview();
        renderCompaniesTable();
        renderUsersTable();
        renderCalendar();
        renderInProgressTasks();
        renderPasswordCompanySelect();
        renderPasswordsTable();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    // ========================== FORM TAREFA ==========================
    function resetTaskForm() {
        const form = document.getElementById('taskForm');
        if (form) form.reset();

        const taskDateInput = document.getElementById('taskDate');
        if (taskDateInput) taskDateInput.value = getTodayStr();

        const recurrenceSelect = document.getElementById('taskRecurrence');
        if (recurrenceSelect) recurrenceSelect.value = 'Nenhuma';

        const userSelect = document.getElementById('taskUser');
        if (userSelect && userSelect.options.length > 0) userSelect.selectedIndex = 0;

        const companySelect = document.getElementById('taskCompany');
        if (companySelect && companySelect.options.length > 0) companySelect.selectedIndex = 0;

        editingTaskId = null;

        document.getElementById('taskSubmitBtn').textContent = 'Salvar tarefa';
        document.getElementById('taskDeleteBtn').style.display = 'none';
        document.getElementById('taskCancelBtn').style.display = 'none';
    }

    function cancelTaskEdit() {
        resetTaskForm();
    }

    // ========================== USUÁRIOS ==========================
    function renderUsersTable() {
        const container = document.getElementById('usersTable');
        if (!container) return;

        if (!users.length) {
            container.innerHTML = '<p class="small-text">Nenhum usuário cadastrado.</p>';
            return;
        }

        const isAdmin = currentUser && currentUser.username === 'admin';

        let html = '<table><thead><tr><th>Usuário</th><th>Perfil</th>';
        if (isAdmin) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        users.forEach(u => {
            html += `<tr><td>${u.username}</td><td>${u.role}</td>`;
            if (isAdmin) {
                if (u.username === 'admin') {
                    html += '<td>-</td>';
                } else {
                    html += `<td class="actions">
                        <button onclick="editUser('${u.id}')">Editar</button>
                        <button onclick="deleteUser('${u.id}')">Excluir</button>
                    </td>`;
                }
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderUserSelect() {
        const select = document.getElementById('taskUser');
        if (!select) return;
        select.innerHTML = '';

        if (!currentUser) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Faça login para selecionar';
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        if (!users.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre usuários primeiro';
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione o responsável';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        if (currentUser.role === 'Operador') {
            const u = users.find(u => u.id === currentUser.id || u.username === currentUser.username);
            if (u) {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = `${u.username} (${u.role})`;
                select.appendChild(opt);
            }
        } else {
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = `${u.username} (${u.role})`;
                select.appendChild(opt);
            });
        }
    }

    function handleUserForm(event) {
        event.preventDefault();
        const nameInput = document.getElementById('userName');
        const passwordInput = document.getElementById('userPassword');
        const roleSelect = document.getElementById('userRole');
        theSubmitBtn = document.getElementById('userSubmitBtn');

        const name = nameInput.value.trim();
        const password = passwordInput.value;
        const role = roleSelect.value;

        if (editingUserId) {
            if (!currentUser || currentUser.username !== 'admin') {
                alert('Somente o usuário admin pode alterar usuários.');
                return;
            }
            const u = users.find(u => u.id === editingUserId);
            if (u) {
                u.password = password;
                u.role = role;
                db.collection('users').doc(u.id).set(u);
            }
            editingUserId = null;
            nameInput.disabled = false;
            theSubmitBtn.textContent = 'Salvar usuário';
            document.getElementById('userForm').reset();
            renderUsersTable();
            renderUserSelect();
            renderTaskFilterOptions();
            return;
        }

        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem cadastrar usuários.');
            return;
        }

        if (!name || !password) {
            alert('Preencha usuário e senha.');
            return;
        }

        if (users.some(u => u.username === name)) {
            alert('Já existe um usuário com esse nome.');
            return;
        }

        const newUser = {
            id: generateId(),
            username: name,
            password: password,
            role: role
        };
        users.push(newUser);
        try { db.collection('users').doc(newUser.id).set(newUser); } catch (e) { /* ignore */ }

        document.getElementById('userForm').reset();
        renderUsersTable();
        renderUserSelect();
        renderTaskFilterOptions();
    }

    function editUser(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode editar usuários.');
            return;
        }
        const u = users.find(u => u.id === id);
        if (!u) return;

        editingUserId = id;
        const nameInput = document.getElementById('userName');
        const passwordInput = document.getElementById('userPassword');
        const roleSelect = document.getElementById('userRole');
        const submitBtn = document.getElementById('userSubmitBtn');

        nameInput.value = u.username;
        nameInput.disabled = true;
        passwordInput.value = u.password || '';
        roleSelect.value = u.role;
        submitBtn.textContent = 'Atualizar usuário';
    }

    function deleteUser(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode excluir usuários.');
            return;
        }
        const u = users.find(u => u.id === id);
        if (!u) return;
        if (u.username === 'admin') {
            alert('Você não pode excluir o usuário admin.');
            return;
        }
        if (!confirm('Deseja realmente excluir este usuário?')) return;

        users = users.filter(us => us.id !== id);
        try { db.collection('users').doc(id).delete(); } catch (e) { /* ignore */ }
        renderUsersTable();
        renderUserSelect();
        renderTaskFilterOptions();
    }

    // ========================== EMPRESAS ==========================
    function handleCompanyForm(event) {
        event.preventDefault();
        const nameInput = document.getElementById('companyName');
        const cnpjInput = document.getElementById('companyCNPJ');
        const regimeSelect = document.getElementById('companyRegime');
        const activeCheckbox = document.getElementById('companyActiveBPO');
        const bpoStartInput = document.getElementById('companyBPOStart');
        const submitBtn = document.getElementById('companySubmitBtn');
        const name = nameInput.value.trim();
        const cnpj = cnpjInput ? cnpjInput.value.trim() : '';
        const regime = regimeSelect ? regimeSelect.value : '';
        const active = !!(activeCheckbox && activeCheckbox.checked);
        const bpoStart = (bpoStartInput && bpoStartInput.value) ? bpoStartInput.value : '';

        if (!name) {
            alert('Digite o nome da empresa.');
            return;
        }

        if (editingCompanyId) {
            if (!currentUser || currentUser.username !== 'admin') {
                alert('Somente o usuário admin pode alterar empresas.');
                return;
            }
            const c = companies.find(c => c.id === editingCompanyId);
            if (c) {
                c.name = name;
                c.cnpj = cnpj || '';
                c.regime = regime || '';
                c.activeBPO = active;
                c.bpoStart = bpoStart || '';
                try { db.collection('companies').doc(c.id).set(c); } catch (e) { /* ignore */ }
            }
            editingCompanyId = null;
            submitBtn.textContent = 'Adicionar empresa';
        } else {
            const newCompany = {
                id: generateId(),
                name: name,
                cnpj: cnpj || '',
                regime: regime || '',
                activeBPO: active,
                bpoStart: bpoStart || ''
            };
            companies.push(newCompany);
            try { db.collection('companies').doc(newCompany.id).set(newCompany); } catch (e) { /* ignore */ }
        }

        document.getElementById('companyForm').reset();
        // reset regime select placeholder
        const reg = document.getElementById('companyRegime');
        if (reg) reg.value = '';
        // ensure checkbox reset
        const chk = document.getElementById('companyActiveBPO');
        if (chk) chk.checked = false;
        // reset BPO start date
        const bpo = document.getElementById('companyBPOStart');
        if (bpo) bpo.value = '';

        renderCompaniesTable();
        renderCompanySelect();
        renderTaskFilterOptions();
        renderPasswordCompanySelect();
    }

    function renderCompaniesTable() {
        const container = document.getElementById('companiesTable');
        if (!container) return;

        if (!companies.length) {
            document.getElementById('companiesCount').innerText = '0';
            document.getElementById('companiesActiveCount').innerText = '0';
            container.innerHTML = '<p class="small-text">Nenhuma empresa cadastrada.</p>';
            return;
        }

        document.getElementById('companiesCount').innerText = String(companies.length);

        // contar ativos como cliente BPO (tratar undefined como false)
        const activeCount = companies.filter(c => !!c.activeBPO).length;
        document.getElementById('companiesActiveCount').innerText = String(activeCount);

        const isAdmin = currentUser && currentUser.username === 'admin';

        let html = '<table><thead><tr><th>Nome</th><th>CNPJ</th><th>Regime</th><th>Cliente ativo</th><th>Início BPO</th>';
        if (isAdmin) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        companies.forEach(c => {
            const cnpjDisplay = c.cnpj && c.cnpj.trim() ? c.cnpj : '-';
            const regimeDisplay = c.regime && c.regime.trim() ? c.regime : '-';
            const activeDisplay = c.activeBPO ? '<strong style="color:#155724;">Sim</strong>' : 'Não';
            const bpoStartDisplay = c.bpoStart ? formatDateBR(c.bpoStart) : '-';
            html += `<tr><td>${c.name}</td><td>${cnpjDisplay}</td><td>${regimeDisplay}</td><td>${activeDisplay}</td><td>${bpoStartDisplay}</td>`;
            if (isAdmin) {
                html += `<td class="actions">
                    <button onclick="editCompany('${c.id}')">Editar</button>
                    <button onclick="deleteCompany('${c.id}')">Excluir</button>
                </td>`;
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderCompanySelect() {
        const select = document.getElementById('taskCompany');
        if (!select) return;
        select.innerHTML = '';

        if (!companies.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre empresas primeiro';
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione a empresa';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        companies.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
        });
    }

    function getCompanyNameById(id) {
        const c = companies.find(c => c.id === id);
        return c ? c.name : '-';
    }

    function editCompany(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode editar empresas.');
            return;
        }
        const c = companies.find(c => c.id === id);
        if (!c) return;

        editingCompanyId = id;
        const nameInput = document.getElementById('companyName');
        const cnpjInput = document.getElementById('companyCNPJ');
        const regimeSelect = document.getElementById('companyRegime');
        const activeCheckbox = document.getElementById('companyActiveBPO');
        const bpoStartInput = document.getElementById('companyBPOStart');
        const submitBtn = document.getElementById('companySubmitBtn');

        nameInput.value = c.name || '';
        cnpjInput.value = c.cnpj || '';
        regimeSelect.value = c.regime || '';
        activeCheckbox.checked = !!c.activeBPO;
        bpoStartInput.value = c.bpoStart || '';
        submitBtn.textContent = 'Atualizar empresa';

        // --- NOVA PARTE: subir a página automaticamente para o formulário e focar o campo nome ---
        const formEl = document.getElementById('companyForm');
        if (formEl && formEl.scrollIntoView) {
            // usa smooth scroll para melhor UX
            formEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            // fallback: scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        // dar foco ao campo nome após pequeno delay (garante que o scroll/paint aconteceu)
        setTimeout(() => {
            try { nameInput.focus(); nameInput.select(); } catch (e) { /* ignore */ }
        }, 450);
    }

    function deleteCompany(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode excluir empresas.');
            return;
        }
        if (!confirm('Deseja realmente excluir esta empresa?')) return;
        companies = companies.filter(c => c.id !== id);
        try { db.collection('companies').doc(id).delete(); } catch (e) { /* ignore */ }
        renderCompaniesTable();
        renderCompanySelect();
        renderTaskFilterOptions();
        renderPasswordCompanySelect();
    }

    // ========================== TAREFAS ==========================
    // Helper: retorna os membros da série (todos os recorrentes relacionados ao mesmo 'baseId' ou, se não houver baseId, por comparação heurística)
    function getSeriesTasks(task) {
        if (!task) return [];
        if (task.baseId) {
            return tasks.filter(t => t.baseId === task.baseId);
        }
        // Fallback heurística: mesma title, responsible, companyId e mesma recorrência
        return tasks.filter(t => t.recurrence === task.recurrence &&
            t.title === task.title &&
            t.responsible === task.responsible &&
            t.companyId === task.companyId);
    }

    function createTaskClone(baseTask, dateStr) {
        const clone = {
            id: generateId(),
            title: baseTask.title,
            date: dateStr,
            responsible: baseTask.responsible,
            companyId: baseTask.companyId,
            status: baseTask.status,
            priority: baseTask.priority,
            description: baseTask.description,
            recurrence: baseTask.recurrence,
            timeSpentMs: 0,
            currentStart: null,
            baseId: baseTask.baseId || baseTask.id
        };
        tasks.push(clone);
        try { db.collection('tasks').doc(clone.id).set(clone); } catch (e) { /* ignore */ }
    }

    function generateRecurrenceTasks(baseTask) {
        const recurrence = baseTask.recurrence || 'Nenhuma';
        if (recurrence === 'Nenhuma') return;
        if (!baseTask.date) return;

        // Guarantee baseId exists on base task
        if (!baseTask.baseId) baseTask.baseId = baseTask.id;

        const startDate = parseLocalDate(baseTask.date);
        if (!startDate) return;

        const year = startDate.getFullYear();

        function isWeekday(d) {
            const day = d.getDay();
            return day >= 1 && day <= 5;
        }

        if (recurrence === 'Diária') {
            let d = new Date(startDate);
            while (true) {
                d.setDate(d.getDate() + 1);
                if (d.getFullYear() !== year) break;
                if (isWeekday(d)) createTaskClone(baseTask, dateToISO(d));
            }
        } else if (recurrence === 'Semanal') {
            let d = new Date(startDate);
            while (true) {
                d.setDate(d.getDate() + 7);
                if (d.getFullYear() !== year) break;
                if (isWeekday(d)) createTaskClone(baseTask, dateToISO(d));
            }
        } else if (recurrence === 'Mensal') {
            const originalDay = startDate.getDate();
            let month = startDate.getMonth() + 1;
            while (true) {
                const d = new Date(year, month, originalDay);
                if (d.getFullYear() !== year) break;
                if (d.getMonth() !== month) {
                    month++;
                    if (month > 11) break;
                    continue;
                }
                if (isWeekday(d)) createTaskClone(baseTask, dateToISO(d));
                month++;
                if (month > 11) break;
            }
        }
    }

    // ==========================
    // Modal helper: mostra modal com opções "Apenas esta tarefa" / "Todas as tarefas"
    // Retorna uma Promise que resolve 'this' | 'all' | null (null = cancel)
    // ==========================
    function showRecurrenceModal(message, title = 'Escolha') {
        return new Promise((resolve) => {
            const overlay = document.getElementById('recurrenceModal');
            const msgEl = document.getElementById('recurrenceModalMessage');
            const titleEl = document.getElementById('recurrenceModalTitle');
            const confirmBtn = document.getElementById('recurrenceConfirmBtn');
            const cancelBtn = document.getElementById('recurrenceCancelBtn');

            titleEl.innerText = title;
            msgEl.innerText = message;

            // ensure default selection
            const radios = overlay.querySelectorAll('input[name="recurrenceChoice"]');
            radios.forEach(r => r.checked = (r.value === 'this'));

            function cleanup() {
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
                overlay.style.display = 'none';
                overlay.setAttribute('aria-hidden', 'true');
            }

            function onConfirm() {
                const chosen = overlay.querySelector('input[name="recurrenceChoice"]:checked');
                const value = chosen ? chosen.value : 'this';
                cleanup();
                resolve(value === 'all' ? 'all' : 'this');
            }

            function onCancel() {
                cleanup();
                resolve(null);
            }

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);

            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
        });
    }

    // ==========================
    // handleTaskForm agora é async para usar o modal quando necessário
    // ==========================
    async function handleTaskForm(event) {
        event.preventDefault();
        const title = document.getElementById('taskTitle').value.trim();
        const date = document.getElementById('taskDate').value;
        const responsible = document.getElementById('taskUser').value;
        const companyId = document.getElementById('taskCompany').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        const description = document.getElementById('taskDescription').value.trim();
        const recurrence = document.getElementById('taskRecurrence').value || 'Nenhuma';

        if (!title || !date || !responsible || !companyId) {
            alert('Preencha todos os campos obrigatórios.');
            return;
        }

        if (editingTaskId) {
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) {
                alert('Tarefa não encontrada para edição.');
            } else {
                // If task is part of a recurrence series, ask the user via modal
                if (task.recurrence && task.recurrence !== 'Nenhuma') {
                    const choice = await showRecurrenceModal(
                        'Esta tarefa faz parte de uma recorrência.\n\nEscolha "Apenas esta ocorrência" para aplicar somente a alteração nesta tarefa ou "Todas as tarefas" para aplicar a TODAS as tarefas.',
                        'Alterar tarefa recorrente'
                    );

                    if (choice === null) {
                        // user canceled
                        return;
                    }

                    if (choice === 'all') {
                        const series = getSeriesTasks(task);
                        series.forEach(t => {
                            applyStatusChange(t, status);
                            t.title = title;
                            t.responsible = responsible;
                            t.companyId = companyId;
                            t.priority = priority;
                            t.description = description;
                            t.recurrence = recurrence;
                            // Do NOT overwrite date for other occurrences
                            try { db.collection('tasks').doc(t.id).set(t); } catch (e) { /* ignore */ }
                        });
                    } else {
                        applyStatusChange(task, status);
                        task.title = title;
                        task.date = date;
                        task.responsible = responsible;
                        task.companyId = companyId;
                        task.priority = priority;
                        task.description = description;
                        task.recurrence = recurrence;
                        try { db.collection('tasks').doc(task.id).set(task); } catch (e) { /* ignore */ }
                    }
                } else {
                    applyStatusChange(task, status);
                    task.title = title;
                    task.date = date;
                    task.responsible = responsible;
                    task.companyId = companyId;
                    task.priority = priority;
                    task.description = description;
                    task.recurrence = recurrence;
                    try { db.collection('tasks').doc(task.id).set(task); } catch (e) { /* ignore */ }
                }
            }
        } else {
            const now = Date.now();
            const baseTask = {
                id: generateId(),
                title,
                date,
                responsible,
                companyId,
                status,
                priority,
                description,
                recurrence,
                timeSpentMs: 0,
                currentStart: null,
                baseId: null
            };
            if (status === 'Em andamento') baseTask.currentStart = now;
            // set baseId so series can be tracked
            baseTask.baseId = baseTask.id;

            tasks.push(baseTask);
            try { db.collection('tasks').doc(baseTask.id).set(baseTask); } catch (e) { /* ignore */ }
            generateRecurrenceTasks(baseTask);
        }

        resetTaskForm();
        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    // ==========================
    // deleteCurrentEditingTask usa modal quando a tarefa é recorrente
    // ==========================
    async function deleteCurrentEditingTask() {
        if (!editingTaskId) return;
        const task = tasks.find(t => t.id === editingTaskId);
        if (!task) return;

        if (task.recurrence && task.recurrence !== 'Nenhuma') {
            const choice = await showRecurrenceModal(
                'Esta tarefa faz parte de uma recorrência.\n\nEscolha "Apenas esta tarefa" para aplicar somente a alteração nesta tarefa ou "Todas as tarefas" para aplicar a TODAS as tarefas.',
                'Excluir tarefa recorrente'
            );
            if (choice === null) return;

            if (choice === 'all') {
                const series = getSeriesTasks(task);
                if (!confirm(`Confirma excluir ${series.length} tarefas recorrentes?`)) return;
                series.forEach(t => {
                    tasks = tasks.filter(x => x.id !== t.id);
                    try { db.collection('tasks').doc(t.id).delete(); } catch (e) { /* ignore */ }
                });
            } else {
                if (!confirm('Deseja realmente excluir esta tarefa?')) return;
                tasks = tasks.filter(t => t.id !== task.id);
                try { db.collection('tasks').doc(task.id).delete(); } catch (e) { /* ignore */ }
            }
        } else {
            if (!confirm('Deseja realmente excluir esta tarefa?')) return;
            tasks = tasks.filter(t => t.id !== task.id);
            try { db.collection('tasks').doc(task.id).delete(); } catch (e) { /* ignore */ }
        }

        resetTaskForm();
        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    function getFilteredTasksList() {
        let visible = sortTasks(getVisibleTasks());

        visible = visible.filter(t => {
            if (taskFilterStart || taskFilterEnd) {
                if (!t.date) return false;
                if (taskFilterStart && t.date < taskFilterStart) return false;
                if (taskFilterEnd && t.date > taskFilterEnd) return false;
            }
            if (taskFilterResponsible && t.responsible !== taskFilterResponsible) return false;
            if (taskFilterCompanyId && t.companyId !== taskFilterCompanyId) return false;
            return true;
        });

        return visible;
    }

    function applyTaskDateFilter() {
        const startInput = document.getElementById('filterStartDate');
        const endInput = document.getElementById('filterEndDate');
        const respSelect = document.getElementById('filterResponsible');
        const companySelect = document.getElementById('filterCompany');

        taskFilterStart = startInput.value || null;
        taskFilterEnd = endInput.value || null;
        taskFilterResponsible = respSelect ? (respSelect.value || null) : null;
        taskFilterCompanyId = companySelect ? (companySelect.value || null) : null;

        renderTasksTable();
    }

    function clearTaskDateFilter() {
        taskFilterStart = null;
        taskFilterEnd = null;
        taskFilterResponsible = null;
        taskFilterCompanyId = null;

        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterResponsible').value = '';
        document.getElementById('filterCompany').value = '';

        renderTasksTable();
    }

    function exportTasksToExcel() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem exportar as tarefas.');
            return;
        }

        const list = getFilteredTasksList();
        if (!list.length) {
            alert('Não há tarefas para exportar nesse período.');
            return;
        }

        let tableHtml = '<table border="1"><thead><tr>' +
            '<th>Título</th>' +
            '<th>Data</th>' +
            '<th>Responsável</th>' +
            '<th>Empresa</th>' +
            '<th>Status</th>' +
            '<th>Prioridade</th>' +
            '<th>Recorrência</th>' +
            '<th>Tempo Em andamento</th>' +
            '<th>Descrição</th>' +
            '</tr></thead><tbody>';

        list.forEach(t => {
            const companyName = getCompanyNameById(t.companyId);
            const timeText = formatTimeSpent(t.timeSpentMs || 0);

            tableHtml += '<tr>' +
                `<td>${(t.title || '').replace(/<\/?[^>]+(>|$)/g, '')}</td>` +
                `<td>${formatDateBR(t.date || '')}</td>` +
                `<td>${t.responsible || ''}</td>` +
                `<td>${companyName || ''}</td>` +
                `<td>${t.status || ''}</td>` +
                `<td>${t.priority || ''}</td>` +
                `<td>${t.recurrence || 'Nenhuma'}</td>` +
                `<td>${timeText}</td>` +
                `<td>${(t.description || '').replace(/<\/?[^>]+(>|$)/g, '')}</td>` +
                '</tr>';
        });

        tableHtml += '</tbody></table>';

        const htmlFile = `<html><head><meta charset="UTF-8"></head><body>${tableHtml}</body></html>`;
        const blob = new Blob([htmlFile], { type: 'application/vnd.ms-excel' });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tarefas_${getTodayStr()}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function renderTasksTable() {
        const container = document.getElementById('tasksTable');
        if (!container) return;

        if (!currentUser || currentUser.role !== 'Gestor') {
            container.innerHTML = '<p class="small-text">Apenas Gestores podem visualizar todas as tarefas.</p>';
            return;
        }

        const visible = getFilteredTasksList();

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa cadastrada nesse período.</p>';
            return;
        }

        // Build table with checkbox column (A coluna "Ações" foi removida conforme solicitado)
        let html = '<table><thead><tr>' +
            '<th style="width:36px;"><input id="selectAllCheckbox" type="checkbox" onchange="toggleSelectAll(this)"></th>' +
            '<th>Título</th><th>Data</th><th>Responsável</th><th>Empresa</th>' +
            '<th>Status</th><th>Prioridade</th><th>Tempo Em andamento</th></tr></thead><tbody>';

        visible.forEach(t => {
            const statusClass = 'tag-' + (t.status || '').replace(/\s+/g, '-');
            const priorityClass = 'tag-' + (t.priority || '');

            const checked = selectedTaskIds.has(t.id) ? 'checked' : '';

            html += `<tr>
                <td><input type="checkbox" class="task-select-checkbox" data-taskid="${t.id}" ${checked} onchange="toggleTaskSelection(this)"></td>
                <td>${t.title}</td>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
                <td>${formatTimeSpent(t.timeSpentMs || 0)}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        // show/hide delete selected button depending on selection
        const delBtn = document.getElementById('deleteSelectedBtn');
        if (delBtn) delBtn.style.display = (selectedTaskIds.size > 0 && currentUser.role === 'Gestor') ? 'inline-block' : (currentUser.role === 'Gestor' ? 'inline-block' : 'none');

        // update selectAll checkbox state
        const selectAll = document.getElementById('selectAllCheckbox');
        if (selectAll) {
            const allIds = visible.map(v => v.id);
            const allSelected = allIds.length > 0 && allIds.every(id => selectedTaskIds.has(id));
            selectAll.checked = allSelected;
            // if some selected but not all -> set indeterminate
            selectAll.indeterminate = selectedTaskIds.size > 0 && !allSelected;
        }
    }

    function toggleSelectAll(el) {
        const check = el.checked;
        const visible = getFilteredTasksList();
        visible.forEach(t => {
            if (check) selectedTaskIds.add(t.id);
            else selectedTaskIds.delete(t.id);
        });
        renderTasksTable();
    }

    function toggleTaskSelection(checkbox) {
        const id = checkbox.getAttribute('data-taskid');
        if (!id) return;
        if (checkbox.checked) selectedTaskIds.add(id);
        else selectedTaskIds.delete(id);
        renderTasksTable();
    }

    async function deleteSelectedTasks() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir tarefas.');
            return;
        }
        if (!selectedTaskIds.size) {
            alert('Nenhuma tarefa selecionada.');
            return;
        }

        // Collect selected tasks
        const selected = tasks.filter(t => selectedTaskIds.has(t.id));
        if (!selected.length) {
            alert('Nenhuma tarefa válida selecionada.');
            return;
        }

        // Check if any selected tasks are recurring
        const recurringSelected = selected.filter(t => t.recurrence && t.recurrence !== 'Nenhuma');

        if (recurringSelected.length) {
            const choice = await showRecurrenceModal(
                `Existem ${recurringSelected.length} tarefa(s) recorrente(s) selecionada(s). Deseja excluir todas as ocorrências das séries ou apenas as ocorrências selecionadas?`,
                'Excluir tarefas recorrentes'
            );
            if (choice === null) return;

            if (choice === 'all') {
                // Gather all ids to delete: for each recurringSelected, delete its whole series
                const toDeleteIds = new Set();
                recurringSelected.forEach(t => {
                    const series = getSeriesTasks(t);
                    series.forEach(s => toDeleteIds.add(s.id));
                });
                // Also include non-recurring selected tasks
                selected.filter(t => ! (t.recurrence && t.recurrence !== 'Nenhuma')).forEach(t => toDeleteIds.add(t.id));

                if (!confirm(`Confirma excluir ${toDeleteIds.size} tarefas (inclui todas as ocorrências das séries)?`)) return;

                // Delete
                toDeleteIds.forEach(id => {
                    tasks = tasks.filter(x => x.id !== id);
                    try { db.collection('tasks').doc(id).delete(); } catch (e) { /* ignore */ }
                    selectedTaskIds.delete(id);
                });

            } else {
                // choice === 'this' -> delete only selected occurrences (no series deletion)
                if (!confirm(`Confirma excluir ${selected.length} tarefas selecionadas?`)) return;
                selected.forEach(t => {
                    tasks = tasks.filter(x => x.id !== t.id);
                    try { db.collection('tasks').doc(t.id).delete(); } catch (e) { /* ignore */ }
                    selectedTaskIds.delete(t.id);
                });
            }
        } else {
            // No recurring tasks — delete selected directly
            if (!confirm(`Confirma excluir ${selected.length} tarefas selecionadas?`)) return;
            selected.forEach(t => {
                tasks = tasks.filter(x => x.id !== t.id);
                try { db.collection('tasks').doc(t.id).delete(); } catch (e) { /* ignore */ }
                selectedTaskIds.delete(t.id);
            });
        }

        // refresh UI
        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    function renderTaskFilterOptions() {
        const respSelect = document.getElementById('filterResponsible');
        const companySelect = document.getElementById('filterCompany');

        if (respSelect) {
            const current = taskFilterResponsible || '';
            respSelect.innerHTML = '';

            const optAll = document.createElement('option');
            optAll.value = '';
            optAll.textContent = 'Todos';
            respSelect.appendChild(optAll);

            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = u.username;
                respSelect.appendChild(opt);
            });

            respSelect.value = current;
        }

        if (companySelect) {
            const currentComp = taskFilterCompanyId || '';
            companySelect.innerHTML = '';

            const optAllC = document.createElement('option');
            optAllC.value = '';
            optAllC.textContent = 'Todas';
            companySelect.appendChild(optAllC);

            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                companySelect.appendChild(opt);
            });

            companySelect.value = currentComp;
        }
    }

    function updateTaskStatus(id, newStatus) {
        const t = tasks.find(t => t.id === id);
        if (!t) return;

        // Permissão: Gestor pode alterar qualquer um; Operador só altera se for responsável
        if (!currentUser) {
            alert('Faça login para alterar o status.');
            closeStatusDropdown();
            renderDayTasks(selectedDate);
            return;
        }
        if (currentUser.role !== 'Gestor' && currentUser.username !== t.responsible) {
            alert('Você não tem permissão para alterar o status desta tarefa.');
            closeStatusDropdown();
            renderDayTasks(selectedDate);
            return;
        }

        applyStatusChange(t, newStatus);
        try { db.collection('tasks').doc(t.id).set(t); } catch (e) { /* ignore */ }

        closeStatusDropdown();

        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        renderTasksTable();
    }

    function updateTaskPriority(id, newPriority) {
        const t = tasks.find(t => t.id === id);
        if (!t) return;
        t.priority = newPriority;
        try { db.collection('tasks').doc(t.id).set(t); } catch (e) { /* ignore */ }
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        renderTasksTable();
    }

    // ==========================
    // deleteTask (ao excluir da tabela) também usa modal para recorrência
    // ==========================
    async function deleteTask(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir tarefas.');
            return;
        }
        const t = tasks.find(t => t.id === id);
        if (t) applyStatusChange(t, 'Pendente');

        if (!t) return;

        if (t.recurrence && t.recurrence !== 'Nenhuma') {
            const choice = await showRecurrenceModal(
                'Esta tarefa faz parte de uma recorrência.\n\nEscolha "Todas as tarefas" para excluir TODAS as ocorrências recorrentes ou "Apenas esta tarefa" para excluir apenas ESTA.',
                'Excluir tarefa recorrente'
            );

            if (choice === null) return;

            if (choice === 'all') {
                const series = getSeriesTasks(t);
                if (!confirm(`Confirma excluir ${series.length} tarefas recorrentes?`)) return;
                series.forEach(item => {
                    tasks = tasks.filter(x => x.id !== item.id);
                    try { db.collection('tasks').doc(item.id).delete(); } catch (e) { /* ignore */ }
                    selectedTaskIds.delete(item.id);
                });
            } else {
                if (!confirm('Deseja realmente excluir esta tarefa?')) return;
                tasks = tasks.filter(x => x.id !== t.id);
                try { db.collection('tasks').doc(t.id).delete(); } catch (e) { /* ignore */ }
                selectedTaskIds.delete(t.id);
            }
        } else {
            if (!confirm('Deseja realmente excluir esta tarefa?')) return;
            tasks = tasks.filter(x => x.id !== t.id);
            try { db.collection('tasks').doc(t.id).delete(); } catch (e) { /* ignore */ }
            selectedTaskIds.delete(t.id);
        }

        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    function renderTasksOverview() {
        const container = document.getElementById('tasksOverview');
        if (!container) return;

        const visible = sortTasks(getVisibleTasks());

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa cadastrada.</p>';
            return;
        }

        let html = '<table><thead><tr><th>Data</th><th>Título</th><th>Resp.</th>' +
            '<th>Empresa</th><th>Status</th><th>Prioridade</th></tr></thead><tbody>';

        visible.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;
            html += `<tr>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.title}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderInProgressTasks() {
        const container = document.getElementById('inProgressList');
        if (!container) return;

        const list = sortTasks(
            getVisibleTasks().filter(t => t.status === 'Em andamento')
        );

        if (!list.length) {
            container.innerHTML = 'Nenhuma tarefa em andamento.';
            return;
        }

        let html = '<table><thead><tr>' +
            '<th>Título</th><th>Data</th><th>Responsável</th><th>Empresa</th><th>Status</th><th>Prioridade</th>' +
            '</tr></thead><tbody>';

        list.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;

            html += `<tr>
                <td>${t.title}</td>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ========================== CALENDÁRIO ==========================
    function renderCalendar() {
        const calendarDiv = document.getElementById('calendar');
        const monthLabel = document.getElementById('monthLabel');
        const today = new Date();
        const todayStr = getTodayStr();

        if (currentMonth === undefined || currentYear === undefined) {
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
        }

        const firstDay = new Date(currentYear, currentMonth, 1);
        const startingDay = firstDay.getDay();
        const monthLength = new Date(currentYear, currentMonth + 1, 0).getDate();

        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        monthLabel.innerText = `${monthNames[currentMonth]} de ${currentYear}`;

        const visibleTasks = getVisibleTasks();
        const tasksByDay = {};
        visibleTasks.forEach(t => {
            if (!t.date) return;
            const d = parseLocalDate(t.date);
            if (!d) return;
            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                const day = d.getDate();
                if (!tasksByDay[day]) tasksByDay[day] = [];
                tasksByDay[day].push(t);
            }
        });

        let html = '<table><thead><tr>' +
            '<th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th>' +
            '<th>Qui</th><th>Sex</th><th>Sáb</th></tr></thead><tbody><tr>';

        let day = 1;
        for (let i = 0; i < startingDay; i++) html += '<td></td>';

        for (let i = startingDay; i < 7; i++) {
            html += buildCalendarDayCell(day, monthLength, tasksByDay, todayStr);
            day++;
        }
        html += '</tr>';

        while (day <= monthLength) {
            html += '<tr>';
            for (let i = 0; i < 7 && day <= monthLength; i++) {
                html += buildCalendarDayCell(day, monthLength, tasksByDay, todayStr);
                day++;
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        calendarDiv.innerHTML = html;
    }

    function buildCalendarDayCell(day, monthLength, tasksByDay, todayStr) {
        if (day > monthLength) return '<td></td>';
        const d = new Date(currentYear, currentMonth, day);
        const dateStr = dateToISO(d);
        const isToday = dateStr === todayStr;
        const hasTasks = !!tasksByDay[day];
        const isSelected = selectedDate === dateStr;

        let classes = [];
        if (isToday) classes.push('today');
        if (isSelected) classes.push('selected');

        let html = `<td class="${classes.join(' ')}" onclick="selectDate('${dateStr}')">`;
        html += day;
        if (hasTasks) html += '<div class="dot"></div>';
        html += '</td>';
        return html;
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        selectedDate = null;
        document.getElementById('dayTasksTitle').innerText = 'Tarefas do dia';
        document.getElementById('dayTasksList').innerHTML =
            '<span class="small-text">Selecione um dia no calendário para ver as tarefas.</span>';
        renderCalendar();
        renderInProgressTasks();
    }

    function selectDate(dateStr) {
        selectedDate = dateStr;
        renderCalendar();
        renderDayTasks(dateStr);
    }

    function setDayTasksSort(field) {
        if (dayTasksSortField === field) {
            dayTasksSortDirection = (dayTasksSortDirection === 'asc') ? 'desc' : 'asc';
        } else {
            dayTasksSortField = field;
            dayTasksSortDirection = 'asc';
        }
        if (selectedDate) renderDayTasks(selectedDate);
    }

    // ==========================
    // Helper: mapeia status para classes / cores (mantém as cores originais)
    // ==========================
    const STATUS_META = {
        'Aberto': { cls: 'tag-Aberto', bg: '#17a2b8', color: '#fff' },
        'Em andamento': { cls: 'tag-Em-andamento', bg: '#6f42c1', color: '#fff' },
        'Concluído': { cls: 'tag-Concluído', bg: '#28a745', color: '#fff' },
        'Pendente': { cls: 'tag-Pendente', bg: '#fd7e14', color: '#000' }
    };

    // ==========================
    // Dropdown menu: abre ao clicar na tag (apenas 1 clique) — agora com toggle ao clicar novamente
    // ==========================
    function closeStatusDropdown() {
        if (__openStatusDropdown) {
            __openStatusDropdown.remove();
            __openStatusDropdown = null;
        }
        // reset anchor ref as well
        __openStatusDropdownAnchor = null;

        if (__outsideClickHandler) {
            document.removeEventListener('click', __outsideClickHandler);
            __outsideClickHandler = null;
        }
        if (__escapeHandler) {
            document.removeEventListener('keydown', __escapeHandler);
            __escapeHandler = null;
        }
    }

    function openStatusDropdown(taskId, anchorEl) {
        // If the same anchor was clicked and a dropdown is open, toggle/close it
        if (__openStatusDropdown && __openStatusDropdownAnchor === anchorEl) {
            closeStatusDropdown();
            return;
        }

        // fecha qualquer dropdown aberto antes de abrir um novo (se for outro anchor)
        closeStatusDropdown();

        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        if (!currentUser) {
            alert('Faça login para alterar o status.');
            return;
        }
        if (currentUser.role !== 'Gestor' && currentUser.username !== task.responsible) {
            alert('Você não tem permissão para alterar o status desta tarefa.');
            return;
        }

        const dropdown = document.createElement('div');
        dropdown.className = 'status-dropdown';

        const statuses = ['Aberto', 'Em andamento', 'Concluído', 'Pendente'];

        statuses.forEach(s => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.innerText = s;
            // color the option to match status color (small square + bold text)
            const meta = STATUS_META[s] || { bg: '#fff', color: '#000' };
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.gap = '8px';

            const colorBox = document.createElement('span');
            colorBox.style.display = 'inline-block';
            colorBox.style.width = '12px';
            colorBox.style.height = '12px';
            colorBox.style.borderRadius = '3px';
            colorBox.style.background = meta.bg;
            colorBox.style.border = '1px solid rgba(0,0,0,0.06)';
            btn.prepend(colorBox);

            btn.addEventListener('click', function (ev) {
                ev.stopPropagation();
                updateTaskStatus(taskId, s);
            });
            dropdown.appendChild(btn);
        });

        document.body.appendChild(dropdown);
        __openStatusDropdown = dropdown;
        // Remember which anchor opened this dropdown (for toggle behavior)
        __openStatusDropdownAnchor = anchorEl;

        // Positioning: below the anchorEl if possible; otherwise adjust to fit viewport
        const rect = anchorEl.getBoundingClientRect();
        const ddRect = dropdown.getBoundingClientRect();
        const margin = 8;

        // initial top/left
        let top = rect.bottom + margin;
        let left = rect.left;

        // If dropdown would overflow right, adjust
        if (left + ddRect.width > window.innerWidth - 8) {
            left = Math.max(8, window.innerWidth - ddRect.width - 8);
        }

        // If dropdown would overflow bottom, try place above anchor
        // recalc ddRect after appended (height known)
        const ddHeight = dropdown.getBoundingClientRect().height;
        if (top + ddHeight > window.innerHeight - 8) {
            top = rect.top - ddHeight - margin;
            if (top < 8) top = 8;
        }

        dropdown.style.left = left + 'px';
        dropdown.style.top = top + 'px';

        // close when clicking outside
        __outsideClickHandler = function (e) {
            if (!dropdown.contains(e.target) && !anchorEl.contains(e.target)) {
                closeStatusDropdown();
            }
        };
        document.addEventListener('click', __outsideClickHandler);

        // close on escape
        __escapeHandler = function (e) {
            if (e.key === 'Escape') closeStatusDropdown();
        };
        document.addEventListener('keydown', __escapeHandler);
    }

    // ==========================
    // RENDER DAY TASKS MODIFIED
    // ==========================
    function renderDayTasks(dateStr) {
        const container = document.getElementById('dayTasksList');
        const title = document.getElementById('dayTasksTitle');
        title.innerText = 'Tarefas em ' + formatDateBR(dateStr);

        let visible = getVisibleTasks().filter(t => t.date === dateStr);

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa para este dia.</p>';
            return;
        }

        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };

        if (dayTasksSortField) {
            visible.sort((a, b) => {
                let valA, valB;

                switch (dayTasksSortField) {
                    case 'title':
                        valA = (a.title || '').toUpperCase();
                        valB = (b.title || '').toUpperCase();
                        break;
                    case 'responsible':
                        valA = (a.responsible || '').toUpperCase();
                        valB = (b.responsible || '').toUpperCase();
                        break;
                    case 'company':
                        valA = (getCompanyNameById(a.companyId) || '').toUpperCase();
                        valB = (getCompanyNameById(b.companyId) || '').toUpperCase();
                        break;
                    case 'status':
                        valA = (a.status || '').toUpperCase();
                        valB = (b.status || '').toUpperCase();
                        break;
                    case 'priority':
                        valA = priorityOrder[a.priority] || 999;
                        valB = priorityOrder[b.priority] || 999;
                        break;
                    default:
                        valA = 0;
                        valB = 0;
                }

                let compare = 0;
                if (dayTasksSortField === 'priority') {
                    compare = valA - valB;
                } else {
                    if (valA < valB) compare = -1;
                    else if (valA > valB) compare = 1;
                    else compare = 0;
                }

                return (dayTasksSortDirection === 'asc') ? compare : -compare;
            });
        } else {
            visible = sortTasks(visible);
        }

        const titleArrow    = (dayTasksSortField === 'title')       ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const respArrow     = (dayTasksSortField === 'responsible') ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const companyArrow  = (dayTasksSortField === 'company')     ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const statusArrow   = (dayTasksSortField === 'status')      ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        const priorityArrow = (dayTasksSortField === 'priority')    ? (dayTasksSortDirection === 'asc' ? ' ▲' : ' ▼') : '';

        let html = '<table><thead><tr>' +
            '<th onclick="setDayTasksSort(\'title\')">Título' + titleArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'responsible\')">Resp.' + respArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'company\')">Empresa' + companyArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'status\')">Status' + statusArrow + '</th>' +
            '<th onclick="setDayTasksSort(\'priority\')">Prioridade' + priorityArrow + '</th>' +
            '</tr></thead><tbody>';

        visible.forEach(t => {
            const prClass = 'tag-' + (t.priority || '');
            const statusClass = STATUS_META[t.status]?.cls || 'tag-Aberto';

            html += `<tr>
                <td>${t.title}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td data-taskid="${t.id}" class="status-cell">` +
                    // mostra a tag colorida (clicável) — o onclick chama openStatusDropdown
                    `<span class="tag ${statusClass}" ` +
                    `onclick="(function(e){ e.stopPropagation(); const el = e.currentTarget; openStatusDropdown('${t.id}', el); })(event)">${t.status}</span>` +
                `</td>
                <td><span class="tag ${prClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function selectTaskForEdit(taskId) {
        const t = tasks.find(t => t.id === taskId);
        if (!t) return;

        editingTaskId = taskId;

        document.getElementById('taskTitle').value = t.title;
        document.getElementById('taskDate').value = t.date;
        document.getElementById('taskUser').value = t.responsible;
        document.getElementById('taskCompany').value = t.companyId;
        document.getElementById('taskStatus').value = t.status;
        document.getElementById('taskPriority').value = t.priority;
        document.getElementById('taskDescription').value = t.description || '';
        document.getElementById('taskRecurrence').value = t.recurrence || 'Nenhuma';

        document.getElementById('taskSubmitBtn').textContent = 'Atualizar tarefa';

        document.getElementById('taskDeleteBtn').style.display =
            (currentUser && currentUser.role === 'Gestor') ? 'inline-block' : 'none';

        document.getElementById('taskCancelBtn').style.display = 'inline-block';
    }

    // ========================== SENHAS ==========================
    function resetPasswordForm() {
        const form = document.getElementById('passwordForm');
        if (form) form.reset();

        const companySelect = document.getElementById('passwordCompanySelect');
        if (companySelect && companySelect.options.length > 0) {
            companySelect.selectedIndex = 0;
        }

        editingPasswordId = null;
        const submitBtn = document.getElementById('passwordSubmitBtn');
        if (submitBtn) submitBtn.textContent = 'Salvar senha';
        const cancelBtn = document.getElementById('passwordCancelBtn');
        const deleteBtn = document.getElementById('passwordDeleteBtn');
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (deleteBtn) deleteBtn.style.display = 'none';
    }

    function cancelPasswordEdit() {
        resetPasswordForm();
    }

    function deleteCurrentEditingPassword() {
        if (!editingPasswordId) return;
        deletePassword(editingPasswordId);
        resetPasswordForm();
    }

    function handlePasswordForm(event) {
        event.preventDefault();

        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem gerenciar senhas.');
            return;
        }

        const companyId = document.getElementById('passwordCompanySelect').value;
        const name = document.getElementById('passwordName').value.trim();
        const site = document.getElementById('passwordSite').value.trim();
        const username = document.getElementById('passwordUser').value.trim();
        const pass = document.getElementById('passwordPass').value.trim();
        const observation = document.getElementById('passwordObservation').value.trim();

        if (!companyId || !name || !username || !pass) {
            alert('Preencha os campos obrigatórios (empresa, nome, usuário e senha).');
            return;
        }

        if (editingPasswordId) {
            const p = passwords.find(p => p.id === editingPasswordId);
            if (!p) {
                alert('Registro de senha não encontrado para edição.');
            } else {
                p.companyId = companyId;
                p.name = name;
                p.site = site;
                p.username = username;
                p.password = pass;
                p.observation = observation;
                try { db.collection('passwords').doc(p.id).set(p); } catch (e) { /* ignore */ }
            }
        } else {
            const newPassword = {
                id: generateId(),
                companyId,
                name,
                site,
                username,
                password: pass,
                observation
            };
            passwords.push(newPassword);
            try { db.collection('passwords').doc(newPassword.id).set(newPassword); } catch (e) { /* ignore */ }
        }

        resetPasswordForm();
        renderPasswordsTable();
    }

    function renderPasswordCompanySelect() {
        const selectForm = document.getElementById('passwordCompanySelect');
        const selectFilter = document.getElementById('passwordCompanyFilter');

        // Select do formulário
        if (selectForm) {
            selectForm.innerHTML = '';

            if (!companies.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Cadastre empresas primeiro';
                opt.disabled = true;
                opt.selected = true;
                selectForm.appendChild(opt);
                selectForm.disabled = true;
            } else {
                selectForm.disabled = false;

                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Selecione a empresa';
                placeholder.disabled = true;
                placeholder.selected = true;
                selectForm.appendChild(placeholder);

                companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    selectForm.appendChild(opt);
                });
            }
        }

        // Select de filtro
        if (selectFilter) {
            const current = selectFilter.value || '';
            selectFilter.innerHTML = '';

            const optAll = document.createElement('option');
            optAll.value = '';
            optAll.textContent = 'Todas';
            selectFilter.appendChild(optAll);

            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                selectFilter.appendChild(opt);
            });

            selectFilter.value = current;
        }
    }

    function showCopyToast(message) {
        const toast = document.getElementById('copyToast');
        if (!toast) return;
        toast.textContent = message || 'Copiado!';
        toast.classList.add('show');
        clearTimeout(window.__copyToastTimeout);
        window.__copyToastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, 1500);
    }

    function copyToClipboard(text) {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showCopyToast('Copiado!');
                })
                .catch(() => {
                    fallbackCopy(text);
                });
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
            document.execCommand('copy');
            showCopyToast('Copiado!');
        } catch (e) {
            console.error('Falha ao copiar texto:', e);
        }
        document.body.removeChild(textarea);
    }

    function handleCopyClick(el) {
        const encoded = el.getAttribute('data-copy') || '';
        const text = decodeURIComponent(encoded);
        copyToClipboard(text);
    }

    function renderPasswordsTable() {
        const container = document.getElementById('passwordsTable');
        if (!container) return;

        if (!currentUser) {
            container.innerHTML = '<p class="small-text">Faça login para visualizar as senhas.</p>';
            return;
        }

        if (!passwords.length) {
            container.innerHTML = '<p class="small-text">Nenhuma senha cadastrada.</p>';
            return;
        }

        const filterSelect = document.getElementById('passwordCompanyFilter');
        const filterCompanyId = filterSelect ? (filterSelect.value || '') : '';

        let list = passwords.slice();
        if (filterCompanyId) {
            list = list.filter(p => p.companyId === filterCompanyId);
        }

        if (!list.length) {
            container.innerHTML = '<p class="small-text">Nenhuma senha encontrada para o filtro selecionado.</p>';
            return;
        }

        list.sort((a, b) => {
            const compA = (getCompanyNameById(a.companyId) || '').toUpperCase();
            const compB = (getCompanyNameById(b.companyId) || '').toUpperCase();
            if (compA < compB) return -1;
            if (compA > compB) return 1;
            const nameA = (a.name || '').toUpperCase();
            const nameB = (b.name || '').toUpperCase();
            if (nameA < nameB) return -1;
            if (nameA > nameB) return 1;
            return 0;
        });

        const isGestor = currentUser && currentUser.role === 'Gestor';

        let html = '<table><thead><tr>' +
            '<th>Empresa</th><th>Nome</th><th>Site</th><th>Usuário</th><th>Senha</th><th>Observação</th>';
        if (isGestor) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        list.forEach(p => {
            const companyName = getCompanyNameById(p.companyId);
            const siteLink = p.site
                ? `<a href="${p.site}" target="_blank">${p.site}</a>`
                : '-';

            const encodedUser = encodeURIComponent(p.username || '');
            const encodedPass = encodeURIComponent(p.password || '');

            html += `<tr>
                <td>${companyName}</td>
                <td>${p.name}</td>
                <td>${siteLink}</td>
                <td><span class="copyable" data-copy="${encodedUser}" onclick="handleCopyClick(this)">${p.username}</span></td>
                <td><span class="copyable" data-copy="${encodedPass}" onclick="handleCopyClick(this)">${p.password}</span></td>
                <td>${p.observation || ''}</td>`;
            if (isGestor) {
                html += `<td class="actions">
                    <button onclick="editPassword('${p.id}')">Editar</button>
                    <button onclick="deletePassword('${p.id}')">Excluir</button>
                </td>`;
            }
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function editPassword(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem editar senhas.');
            return;
        }

        const p = passwords.find(p => p.id === id);
        if (!p) return;

        editingPasswordId = id;

        document.getElementById('passwordCompanySelect').value = p.companyId;
        document.getElementById('passwordName').value = p.name || '';
        document.getElementById('passwordSite').value = p.site || '';
        document.getElementById('passwordUser').value = p.username || '';
        document.getElementById('passwordPass').value = p.password || '';
        document.getElementById('passwordObservation').value = p.observation || '';

        document.getElementById('passwordSubmitBtn').textContent = 'Atualizar senha';
        document.getElementById('passwordCancelBtn').style.display = 'inline-block';
        document.getElementById('passwordDeleteBtn').style.display = 'inline-block';
    }

    function deletePassword(id) {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem excluir senhas.');
            return;
        }
        if (!confirm('Deseja realmente excluir esta senha?')) return;

        passwords = passwords.filter(p => p.id !== id);
        try { db.collection('passwords').doc(id).delete(); } catch (e) { /* ignore */ }
        renderPasswordsTable();
    }

    // ========================== INICIALIZAÇÃO ==========================
    document.addEventListener('DOMContentLoaded', async function () {
        await loadData();
        ensureDefaultAdmin();

        const savedUser = localStorage.getItem('miniERP_currentUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                applyAutoCarryOver();
                showApp();
            } catch (e) {
                console.error('Erro ao restaurar sessão:', e);
            }
        } else {
            showLogin();
        }

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('userForm').addEventListener('submit', handleUserForm);
        document.getElementById('companyForm').addEventListener('submit', handleCompanyForm);
        document.getElementById('taskForm').addEventListener('submit', handleTaskForm);

        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.addEventListener('submit', handlePasswordForm);
        }

        const taskDateInput = document.getElementById('taskDate');
        function fillTodayIfEmpty() {
            if (!taskDateInput.value) taskDateInput.value = getTodayStr();
        }
        taskDateInput.addEventListener('focus', fillTodayIfEmpty);
        taskDateInput.addEventListener('click', fillTodayIfEmpty);
        taskDateInput.value = getTodayStr();

        const recurrenceSelect = document.getElementById('taskRecurrence');
        if (recurrenceSelect) recurrenceSelect.value = 'Nenhuma';

        renderPasswordCompanySelect();
        renderCompaniesTable();
        renderUsersTable();
        renderTaskFilterOptions();
    });
</script>

</body>
</html>

