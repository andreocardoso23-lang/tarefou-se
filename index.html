<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Tarefou-se! - Tarefas</title>

    <!-- Firebase (versão compat para uso simples em HTML) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
        }

        h1, h2, h3 {
            margin: 0 0 10px;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* LOGIN */
        #loginView {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 320px;
        }

        .login-card h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .small-text {
            font-size: 12px;
            color: #666;
        }

        .error {
            color: #b00020;
            font-size: 13px;
            margin-bottom: 8px;
        }

        /* APP */
        #appView {
            display: none;
            min-height: 100vh;
        }

        header {
            background: #343a40;
            color: #fff;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header .logo {
            font-weight: bold;
            font-size: 18px;
        }

        nav a {
            margin-right: 12px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }

        nav a.active {
            text-decoration: underline;
            font-weight: bold;
        }

        .user-info {
            font-size: 13px;
        }

        main {
            padding: 15px 20px 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: 1.1fr 1.2fr;
            gap: 20px;
        }

        .card {
            background: #fff;
            padding: 12px 14px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

        .card h2 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .card h3 {
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            border-bottom: 1px solid #ddd;
            padding: 6px 4px;
            text-align: left;
        }

        th {
            background: #f8f9fa;
        }

        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #fff;
        }

        .tag-Alta { background: #dc3545; }
        .tag-Média { background: #ffc107; color:#000; }
        .tag-Baixa { background: #28a745; }

        .tag-Aberto { background: #17a2b8; }
        .tag-Em-andamento { background: #6f42c1; }
        .tag-Concluído { background: #28a745; }
        .tag-Pendente { background: #fd7e14; }

        .actions button {
            font-size: 11px;
            padding: 4px 8px;
            margin-right: 4px;
            margin-top: 2px;
        }

        .calendar-container {
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .calendar-header span {
            font-weight: bold;
        }

        .calendar {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            padding: 10px;
        }

        .calendar table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .calendar th, .calendar td {
            width: 14.28%;
            text-align: center;
            padding: 6px 0;
            border-bottom: none;
            border-right: none;
        }

        .calendar th {
            font-weight: bold;
        }

        .calendar td {
            cursor: pointer;
            border-radius: 4px;
            position: relative;
        }

        .calendar td:hover {
            background: #e9ecef;
        }

        .calendar .today {
            border: 1px solid #007bff;
        }

        .calendar .selected {
            background: #007bff;
            color: #fff;
        }

        .calendar .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #000;
            margin: 2px auto 0;
        }

        .flex-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .flex-1 {
            flex: 1;
        }

        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background: #f1f3f5;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
            main {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginView">
    <div class="login-card">
        <h1>Tarefou-se!</h1>
        <form id="loginForm">
            <div class="error" id="loginError" style="display:none;"></div>
            <label for="loginUser">Usuário</label>
            <input type="text" id="loginUser" required>
            <label for="loginPass">Senha</label>
            <input type="password" id="loginPass" required>
            <button type="submit" style="width:100%; margin-top:5px;">Entrar</button>
        </form>
    </div>
</div>

<!-- APP -->
<div id="appView">
    <header>
        <div class="logo">Tarefou-se! - Tarefas</div>
        <nav>
            <a id="nav-dashboard" onclick="showSection('dashboardSection')" class="active">Dashboard</a>
            <a id="nav-companies" onclick="showSection('companiesSection')">Empresas</a>
            <a id="nav-tasks" onclick="showSection('tasksSection')">Tarefas</a>
            <a id="nav-users" onclick="showSection('usersSection')">Usuários</a>
        </nav>
        <div class="user-info">
            Logado como: <span id="currentUserInfo"></span>
            &nbsp;|&nbsp;
            <button class="btn-secondary" onclick="logout()">Sair</button>
        </div>
    </header>

    <main>
        <!-- DASHBOARD -->
        <section id="dashboardSection" class="section active">
            <div class="grid">
                <!-- Calendário + Tarefas em andamento -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn-secondary" onclick="changeMonth(-1)">&lt;</button>
                        <span id="monthLabel"></span>
                        <button class="btn-secondary" onclick="changeMonth(1)">&gt;</button>
                    </div>
                    <div class="calendar" id="calendar"></div>

                    <!-- Tarefas em andamento -->
                    <div class="card" style="margin-top:10px;">
                        <h2>Tarefas em andamento</h2>
                        <div id="inProgressList" class="small-text">
                            Nenhuma tarefa em andamento.
                        </div>
                    </div>
                </div>

                <!-- Lado direito: Cadastro + Tarefas do dia -->
                <div>
                    <div class="card">
                        <h2>Cadastro de tarefas</h2>
                        <form id="taskForm">
                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskTitle">Título</label>
                                    <input type="text" id="taskTitle" required>
                                </div>
                                <div style="width:160px;">
                                    <label for="taskDate">Data</label>
                                    <input type="date" id="taskDate" required>
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskUser">Responsável (usuário)</label>
                                    <select id="taskUser" required></select>
                                </div>
                                <div class="flex-1">
                                    <label for="taskCompany">Empresa relacionada</label>
                                    <select id="taskCompany" required></select>
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="flex-1">
                                    <label for="taskStatus">Status</label>
                                    <select id="taskStatus" required>
                                        <option value="Aberto">Aberto</option>
                                        <option value="Em andamento">Em andamento</option>
                                        <option value="Concluído">Concluído</option>
                                        <option value="Pendente">Pendente</option>
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="taskPriority">Prioridade</label>
                                    <select id="taskPriority" required>
                                        <option value="Alta">Alta</option>
                                        <option value="Média">Média</option>
                                        <option value="Baixa">Baixa</option>
                                    </select>
                                </div>
                            </div>

                            <label for="taskRecurrence">Recorrência</label>
                            <select id="taskRecurrence">
                                <option value="Nenhuma">Nenhuma</option>
                                <option value="Diária">Diária (seg a sex)</option>
                                <option value="Semanal">Semanal (seg a sex)</option>
                                <option value="Mensal">Mensal (seg a sex)</option>
                            </select>

                            <label for="taskDescription">Descrição</label>
                            <textarea id="taskDescription"></textarea>

                            <button type="submit" id="taskSubmitBtn">Salvar tarefa</button>
                            <button type="button" id="taskCancelBtn" class="btn-secondary"
                                    style="display:none; margin-left:8px;"
                                    onclick="cancelTaskEdit()">
                                Voltar
                            </button>
                            <button type="button" id="taskDeleteBtn" class="btn-secondary"
                                    style="display:none; margin-left:8px;"
                                    onclick="deleteCurrentEditingTask()">
                                Excluir tarefa
                            </button>
                        </form>
                    </div>

                    <div class="card">
                        <h2 id="dayTasksTitle">Tarefas do dia</h2>
                        <div id="dayTasksList" class="small-text">
                            Selecione um dia no calendário para ver as tarefas.
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- EMPRESAS -->
        <section id="companiesSection" class="section">
            <div class="card">
                <h2>Cadastro de empresas</h2>
                <form id="companyForm">
                    <label for="companyName">Nome da empresa</label>
                    <input type="text" id="companyName" required>
                    <button type="submit" id="companySubmitBtn">Adicionar empresa</button>
                </form>
            </div>

            <div class="card">
                <h2>Empresas cadastradas</h2>
                <div id="companiesTable"></div>
            </div>
        </section>

        <!-- TAREFAS (apenas Gestor) -->
        <section id="tasksSection" class="section">
            <div class="card">
                <h2>Todas as tarefas (apenas Gestor)</h2>

                <!-- Filtro de período + botões -->
                <div class="flex-row" style="margin-bottom:10px; flex-wrap:wrap; align-items:flex-end;">
                    <div class="flex-1">
                        <label for="filterStartDate">Data inicial</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div class="flex-1">
                        <label for="filterEndDate">Data final</label>
                        <input type="date" id="filterEndDate">
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <button type="button" onclick="applyTaskDateFilter()">Filtrar</button>
                        <button type="button" class="btn-secondary" onclick="clearTaskDateFilter()">Limpar</button>
                        <button type="button" onclick="exportTasksToExcel()">Baixar Excel</button>
                    </div>
                </div>

                <div id="tasksTable"></div>
            </div>
        </section>

        <!-- USUÁRIOS -->
        <section id="usersSection" class="section">
            <div class="card">
                <h2>Cadastro de usuários</h2>
                <p class="small-text">
                    Somente Gestores devem cadastrar usuários.<br>
                    O usuário padrão <b>admin</b> (Gestor) já existe com senha <b>123</b>.
                </p>
                <form id="userForm">
                    <div class="flex-row">
                        <div class="flex-1">
                            <label for="userName">Usuário</label>
                            <input type="text" id="userName" required>
                        </div>
                        <div class="flex-1">
                            <label for="userPassword">Senha</label>
                            <input type="text" id="userPassword" required>
                        </div>
                        <div class="flex-1">
                            <label for="userRole">Perfil</label>
                            <select id="userRole" required>
                                <option value="Gestor">Gestor</option>
                                <option value="Operador">Operador</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="userSubmitBtn">Salvar usuário</button>
                </form>
            </div>

            <div class="card">
                <h2>Usuários cadastrados</h2>
                <div id="usersTable"></div>
            </div>
        </section>
    </main>
</div>

<script>
    // ========================== FIREBASE CONFIG ==========================

    const firebaseConfig = {
        apiKey: "AIzaSyAtUE0oNAyM4_ZGqqAPdCyEKTsCh9Zxz2o",
        authDomain: "tarefou-se.firebaseapp.com",
        databaseURL: "https://tarefou-se-default-rtdb.firebaseio.com",
        projectId: "tarefou-se",
        storageBucket: "tarefou-se.firebasestorage.app",
        messagingSenderId: "967193019294",
        appId: "1:967193019294:web:7b029d1027633c52d48c8f",
        measurementId: "G-MTQ1H1QQSX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ========================== DADOS & UTILITÁRIOS ==========================

    let users = [];
    let companies = [];
    let tasks = [];
    let currentUser = null;

    let currentMonth;
    let currentYear;
    let selectedDate = null;

    let editingUserId = null;
    let editingCompanyId = null;
    let editingTaskId = null;

    // Filtro de período na página Tarefas
    let taskFilterStart = null; // 'YYYY-MM-DD' ou null
    let taskFilterEnd = null;

    function saveUsers() {
        users.forEach(u => {
            db.collection('users').doc(u.id).set(u);
        });
    }
    function saveCompanies() {
        companies.forEach(c => {
            db.collection('companies').doc(c.id).set(c);
        });
    }
    function saveTasks() {
        tasks.forEach(t => {
            db.collection('tasks').doc(t.id).set(t);
        });
    }

    async function loadData() {
        const usersSnapshot = await db.collection('users').get();
        users = [];
        usersSnapshot.forEach(doc => users.push(doc.data()));

        const companiesSnapshot = await db.collection('companies').get();
        companies = [];
        companiesSnapshot.forEach(doc => companies.push(doc.data()));

        const tasksSnapshot = await db.collection('tasks').get();
        tasks = [];
        tasksSnapshot.forEach(doc => tasks.push(doc.data()));
    }

    function parseLocalDate(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        if (parts.length !== 3) return null;
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const day = parseInt(parts[2], 10);
        return new Date(year, month - 1, day);
    }

    function dateToISO(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function ensureDefaultAdmin() {
        if (!users.some(u => u.username === 'admin')) {
            users.push({
                id: generateId(),
                username: 'admin',
                password: '123',
                role: 'Gestor'
            });
            saveUsers();
        }
    }

    function generateId() {
        return Date.now().toString(36) + Math.random().toString(16).slice(2);
    }

    function formatDateBR(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${y}`;
    }

    function getTodayStr() {
        const d = new Date();
        return dateToISO(d);
    }

    function formatTimeSpent(ms) {
        if (!ms || ms <= 0) return '-';
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        if (hours > 0) {
            return `${hours}h ${minutes}min`;
        }
        return `${minutes}min`;
    }

    function applyStatusChange(task, newStatus) {
        const now = Date.now();

        if (typeof task.timeSpentMs !== 'number') {
            task.timeSpentMs = 0;
        }
        if (typeof task.currentStart !== 'number') {
            task.currentStart = null;
        }

        const oldStatus = task.status || 'Aberto';
        if (oldStatus === newStatus) return;

        if (oldStatus === 'Em andamento' && task.currentStart) {
            task.timeSpentMs += now - task.currentStart;
            task.currentStart = null;
        }

        if (newStatus === 'Em andamento') {
            task.currentStart = now;
        }

        task.status = newStatus;
    }

    function applyAutoCarryOver() {
        const todayStr = getTodayStr();
        const todayDate = parseLocalDate(todayStr);
        let changed = false;

        tasks.forEach(task => {
            if (task.status !== 'Concluído' && task.date && task.date < todayStr) {
                let d = parseLocalDate(task.date);
                if (!d) return;
                while (d < todayDate) {
                    d.setDate(d.getDate() + 1);
                }
                const newDateStr = dateToISO(d);
                task.date = newDateStr;

                applyStatusChange(task, 'Pendente');
                changed = true;
            }
        });

        if (changed) {
            saveTasks();
        }
    }

    function getVisibleTasks() {
        if (!currentUser) return [];
        if (currentUser.role === 'Gestor') return tasks.slice();
        return tasks.filter(t => t.responsible === currentUser.username);
    }

    function sortTasks(list) {
        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
        return list.sort((a, b) => {
            if (a.date === b.date) {
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            }
            return (a.date || '').localeCompare(b.date || '');
        });
    }

    // ============================== FORM DE TAREFA ============================

    function resetTaskForm() {
        const form = document.getElementById('taskForm');
        if (form) form.reset();

        const taskDateInput = document.getElementById('taskDate');
        if (taskDateInput) taskDateInput.value = getTodayStr();

        const recurrenceSelect = document.getElementById('taskRecurrence');
        if (recurrenceSelect) recurrenceSelect.value = 'Nenhuma';

        const userSelect = document.getElementById('taskUser');
        if (userSelect && userSelect.options.length > 0) {
            userSelect.selectedIndex = 0;
        }

        const companySelect = document.getElementById('taskCompany');
        if (companySelect && companySelect.options.length > 0) {
            companySelect.selectedIndex = 0;
        }

        editingTaskId = null;

        const submitBtn = document.getElementById('taskSubmitBtn');
        if (submitBtn) submitBtn.textContent = 'Salvar tarefa';

        const delBtn = document.getElementById('taskDeleteBtn');
        if (delBtn) delBtn.style.display = 'none';

        const cancelBtn = document.getElementById('taskCancelBtn');
        if (cancelBtn) cancelBtn.style.display = 'none';
    }

    function cancelTaskEdit() {
        resetTaskForm();
    }

    // ============================== LOGIN / SESSÃO ============================

    function showLogin() {
        document.getElementById('loginView').style.display = 'flex';
        document.getElementById('appView').style.display = 'none';
    }

    function showApp() {
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('appView').style.display = 'block';
        document.getElementById('currentUserInfo').innerText =
            currentUser.username + ' (' + currentUser.role + ')';

        document.getElementById('nav-users').style.display =
            currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        document.getElementById('nav-tasks').style.display =
            currentUser.role === 'Gestor' ? 'inline-block' : 'none';

        selectedDate = getTodayStr();
        resetTaskForm();
        refreshAllUI();
    }

    async function handleLogin(event) {
        event.preventDefault();
        const user = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value;

        const found = users.find(u => u.username === user && u.password === pass);
        const errorDiv = document.getElementById('loginError');

        if (!found) {
            errorDiv.style.display = 'block';
            errorDiv.innerText = 'Usuário ou senha inválidos.';
            return;
        }

        currentUser = { id: found.id, username: found.username, role: found.role };
        localStorage.setItem('miniERP_currentUser', JSON.stringify(currentUser));
        errorDiv.style.display = 'none';

        applyAutoCarryOver();
        showApp();
    }

    function logout() {
        currentUser = null;
        editingUserId = null;
        editingCompanyId = null;
        editingTaskId = null;
        localStorage.removeItem('miniERP_currentUser');
        showLogin();
    }

    // ============================== NAVEGAÇÃO ================================

    function showSection(sectionId) {
        if (sectionId === 'tasksSection' && (!currentUser || currentUser.role !== 'Gestor')) {
            alert('Apenas Gestores podem visualizar a página de tarefas.');
            sectionId = 'dashboardSection';
        }

        const sections = document.querySelectorAll('.section');
        sections.forEach(sec => sec.classList.remove('active'));

        const navLinks = document.querySelectorAll('nav a');
        navLinks.forEach(link => link.classList.remove('active'));

        document.getElementById(sectionId).classList.add('active');

        if (sectionId === 'dashboardSection') {
            document.getElementById('nav-dashboard').classList.add('active');
        } else if (sectionId === 'companiesSection') {
            document.getElementById('nav-companies').classList.add('active');
        } else if (sectionId === 'tasksSection') {
            document.getElementById('nav-tasks').classList.add('active');
        } else if (sectionId === 'usersSection') {
            document.getElementById('nav-users').classList.add('active');
        }

        refreshAllUI();
    }

    function refreshAllUI() {
        renderUserSelect();
        renderCompanySelect();
        renderTasksTable();
        renderTasksOverview();
        renderCompaniesTable();
        renderUsersTable();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) {
            renderDayTasks(selectedDate);
        }
    }

    // ============================ USUÁRIOS ===================================

    function renderUsersTable() {
        const container = document.getElementById('usersTable');
        if (!container) return;

        if (!users.length) {
            container.innerHTML = '<p class="small-text">Nenhum usuário cadastrado.</p>';
            return;
        }

        const isAdmin = currentUser && currentUser.username === 'admin';

        let html = '<table><thead><tr><th>Usuário</th><th>Perfil</th>';
        if (isAdmin) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        users.forEach(u => {
            html += `<tr><td>${u.username}</td><td>${u.role}</td>`;
            if (isAdmin) {
                if (u.username === 'admin') {
                    html += '<td>-</td>';
                } else {
                    html += `<td class="actions">
                        <button onclick="editUser('${u.id}')">Editar</button>
                        <button onclick="deleteUser('${u.id}')">Excluir</button>
                    </td>`;
                }
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderUserSelect() {
        const select = document.getElementById('taskUser');
        if (!select) return;
        select.innerHTML = '';

        if (!currentUser) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Faça login para selecionar';
            opt.disabled = true;
            opt.selected = true;
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        if (!users.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre usuários primeiro';
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione o responsável';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        if (currentUser.role === 'Operador') {
            const u = users.find(u => u.id === currentUser.id || u.username === currentUser.username);
            if (u) {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = `${u.username} (${u.role})`;
                select.appendChild(opt);
            }
        } else {
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.username;
                opt.textContent = `${u.username} (${u.role})`;
                select.appendChild(opt);
            });
        }
    }

    function handleUserForm(event) {
        event.preventDefault();
        const nameInput = document.getElementById('userName');
        const passwordInput = document.getElementById('userPassword');
        const roleSelect = document.getElementById('userRole');
        const submitBtn = document.getElementById('userSubmitBtn');

        const name = nameInput.value.trim();
        const password = passwordInput.value;
        const role = roleSelect.value;

        if (editingUserId) {
            if (!currentUser || currentUser.username !== 'admin') {
                alert('Somente o usuário admin pode alterar usuários.');
                return;
            }
            const u = users.find(u => u.id === editingUserId);
            if (u) {
                u.password = password;
                u.role = role;
                db.collection('users').doc(u.id).set(u);
            }
            editingUserId = null;
            nameInput.disabled = false;
            submitBtn.textContent = 'Salvar usuário';
            document.getElementById('userForm').reset();
            renderUsersTable();
            renderUserSelect();
            return;
        }

        if (currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem cadastrar usuários.');
            return;
        }

        if (!name || !password) {
            alert('Preencha usuário e senha.');
            return;
        }

        if (users.some(u => u.username === name)) {
            alert('Já existe um usuário com esse nome.');
            return;
        }

        const newUser = {
            id: generateId(),
            username: name,
            password: password,
            role: role
        };
        users.push(newUser);
        db.collection('users').doc(newUser.id).set(newUser);

        document.getElementById('userForm').reset();
        renderUsersTable();
        renderUserSelect();
    }

    function editUser(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode editar usuários.');
            return;
        }
        const u = users.find(u => u.id === id);
        if (!u) return;

        editingUserId = id;
        const nameInput = document.getElementById('userName');
        const passwordInput = document.getElementById('userPassword');
        const roleSelect = document.getElementById('userRole');
        const submitBtn = document.getElementById('userSubmitBtn');

        nameInput.value = u.username;
        nameInput.disabled = true;
        passwordInput.value = u.password || '';
        roleSelect.value = u.role;
        submitBtn.textContent = 'Atualizar usuário';
    }

    function deleteUser(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode excluir usuários.');
            return;
        }
        const u = users.find(u => u.id === id);
        if (!u) return;
        if (u.username === 'admin') {
            alert('Você não pode excluir o usuário admin.');
            return;
        }
        if (!confirm('Deseja realmente excluir este usuário?')) return;

        users = users.filter(us => us.id !== id);
        db.collection('users').doc(id).delete();
        renderUsersTable();
        renderUserSelect();
    }

    // ============================ EMPRESAS ===================================

    function handleCompanyForm(event) {
        event.preventDefault();
        const nameInput = document.getElementById('companyName');
        const submitBtn = document.getElementById('companySubmitBtn');
        const name = nameInput.value.trim();

        if (!name) {
            alert('Digite o nome da empresa.');
            return;
        }

        if (editingCompanyId) {
            if (!currentUser || currentUser.username !== 'admin') {
                alert('Somente o usuário admin pode alterar empresas.');
                return;
            }
            const c = companies.find(c => c.id === editingCompanyId);
            if (c) {
                c.name = name;
                db.collection('companies').doc(c.id).set(c);
            }
            editingCompanyId = null;
            submitBtn.textContent = 'Adicionar empresa';
        } else {
            const newCompany = {
                id: generateId(),
                name: name
            };
            companies.push(newCompany);
            db.collection('companies').doc(newCompany.id).set(newCompany);
        }

        document.getElementById('companyForm').reset();
        renderCompaniesTable();
        renderCompanySelect();
    }

    function renderCompaniesTable() {
        const container = document.getElementById('companiesTable');
        if (!container) return;

        if (!companies.length) {
            container.innerHTML = '<p class="small-text">Nenhuma empresa cadastrada.</p>';
            return;
        }

        const isAdmin = currentUser && currentUser.username === 'admin';

        let html = '<table><thead><tr><th>Nome</th>';
        if (isAdmin) html += '<th>Ações</th>';
        html += '</tr></thead><tbody>';

        companies.forEach(c => {
            html += `<tr><td>${c.name}</td>`;
            if (isAdmin) {
                html += `<td class="actions">
                    <button onclick="editCompany('${c.id}')">Editar</button>
                    <button onclick="deleteCompany('${c.id}')">Excluir</button>
                </td>`;
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderCompanySelect() {
        const select = document.getElementById('taskCompany');
        if (!select) return;
        select.innerHTML = '';

        if (!companies.length) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Cadastre empresas primeiro';
            select.appendChild(opt);
            select.disabled = true;
            return;
        }

        select.disabled = false;

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Selecione a empresa';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.appendChild(placeholder);

        companies.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
        });
    }

    function getCompanyNameById(id) {
        const c = companies.find(c => c.id === id);
        return c ? c.name : '-';
    }

    function editCompany(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode editar empresas.');
            return;
        }
        const c = companies.find(c => c.id === id);
        if (!c) return;

        editingCompanyId = id;
        const nameInput = document.getElementById('companyName');
        const submitBtn = document.getElementById('companySubmitBtn');

        nameInput.value = c.name;
        submitBtn.textContent = 'Atualizar empresa';
    }

    function deleteCompany(id) {
        if (!currentUser || currentUser.username !== 'admin') {
            alert('Somente o usuário admin pode excluir empresas.');
            return;
        }
        if (!confirm('Deseja realmente excluir esta empresa?')) return;
        companies = companies.filter(c => c.id !== id);
        db.collection('companies').doc(id).delete();
        renderCompaniesTable();
        renderCompanySelect();
    }

    // ============================ TAREFAS ====================================

    function createTaskClone(baseTask, dateStr) {
        const clone = {
            id: generateId(),
            title: baseTask.title,
            date: dateStr,
            responsible: baseTask.responsible,
            companyId: baseTask.companyId,
            status: baseTask.status,
            priority: baseTask.priority,
            description: baseTask.description,
            recurrence: baseTask.recurrence,
            timeSpentMs: 0,
            currentStart: null
        };
        tasks.push(clone);
        db.collection('tasks').doc(clone.id).set(clone);
    }

    function generateRecurrenceTasks(baseTask) {
        const recurrence = baseTask.recurrence || 'Nenhuma';
        if (recurrence === 'Nenhuma') return;
        if (!baseTask.date) return;

        const startDate = parseLocalDate(baseTask.date);
        if (!startDate) return;

        const year = startDate.getFullYear();

        function isWeekday(d) {
            const day = d.getDay();
            return day >= 1 && day <= 5;
        }

        if (recurrence === 'Diária') {
            let d = new Date(startDate);
            while (true) {
                d.setDate(d.getDate() + 1);
                if (d.getFullYear() !== year) break;
                if (isWeekday(d)) {
                    createTaskClone(baseTask, dateToISO(d));
                }
            }
        } else if (recurrence === 'Semanal') {
            let d = new Date(startDate);
            while (true) {
                d.setDate(d.getDate() + 7);
                if (d.getFullYear() !== year) break;
                if (isWeekday(d)) {
                    createTaskClone(baseTask, dateToISO(d));
                }
            }
        } else if (recurrence === 'Mensal') {
            const originalDay = startDate.getDate();
            let month = startDate.getMonth() + 1;
            while (true) {
                const d = new Date(year, month, originalDay);
                if (d.getFullYear() !== year) break;
                if (d.getMonth() !== month) {
                    month++;
                    if (month > 11) break;
                    continue;
                }
                if (isWeekday(d)) {
                    createTaskClone(baseTask, dateToISO(d));
                }
                month++;
                if (month > 11) break;
            }
        }
    }

    function handleTaskForm(event) {
        event.preventDefault();
        const title = document.getElementById('taskTitle').value.trim();
        let date = document.getElementById('taskDate').value;
        const responsible = document.getElementById('taskUser').value;
        const companyId = document.getElementById('taskCompany').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        const description = document.getElementById('taskDescription').value.trim();
        const recurrence = document.getElementById('taskRecurrence').value || 'Nenhuma';

        if (!title || !date || !responsible || !companyId) {
            alert('Preencha todos os campos obrigatórios.');
            return;
        }

        if (editingTaskId) {
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) {
                alert('Tarefa não encontrada para edição.');
            } else {
                applyStatusChange(task, status);

                task.title = title;
                task.date = date;
                task.responsible = responsible;
                task.companyId = companyId;
                task.priority = priority;
                task.description = description;
                task.recurrence = recurrence;

                db.collection('tasks').doc(task.id).set(task);
            }
        } else {
            const now = Date.now();
            const baseTask = {
                id: generateId(),
                title,
                date,
                responsible,
                companyId,
                status,
                priority,
                description,
                recurrence,
                timeSpentMs: 0,
                currentStart: null
            };

            if (status === 'Em andamento') {
                baseTask.currentStart = now;
            }

            tasks.push(baseTask);
            db.collection('tasks').doc(baseTask.id).set(baseTask);

            generateRecurrenceTasks(baseTask);
        }

        resetTaskForm();
        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) {
            renderDayTasks(selectedDate);
        }
    }

    function deleteCurrentEditingTask() {
        if (!editingTaskId) return;
        deleteTask(editingTaskId);
        resetTaskForm();
    }

    // Aplica filtro de período na lista de tarefas (para página Tarefas / export)
    function getFilteredTasksList() {
        let visible = sortTasks(getVisibleTasks());

        if (taskFilterStart || taskFilterEnd) {
            visible = visible.filter(t => {
                if (!t.date) return false;
                if (taskFilterStart && t.date < taskFilterStart) return false;
                if (taskFilterEnd && t.date > taskFilterEnd) return false;
                return true;
            });
        }

        return visible;
    }

    function applyTaskDateFilter() {
        const startInput = document.getElementById('filterStartDate');
        const endInput = document.getElementById('filterEndDate');
        taskFilterStart = startInput.value || null;
        taskFilterEnd = endInput.value || null;
        renderTasksTable();
    }

    function clearTaskDateFilter() {
        taskFilterStart = null;
        taskFilterEnd = null;
        const startInput = document.getElementById('filterStartDate');
        const endInput = document.getElementById('filterEndDate');
        if (startInput) startInput.value = '';
        if (endInput) endInput.value = '';
        renderTasksTable();
    }

    // Exportar tarefas para "Excel" (arquivo .xls com tabela HTML)
    function exportTasksToExcel() {
        if (!currentUser || currentUser.role !== 'Gestor') {
            alert('Apenas Gestores podem exportar as tarefas.');
            return;
        }

        const list = getFilteredTasksList();
        if (!list.length) {
            alert('Não há tarefas para exportar nesse período.');
            return;
        }

        let tableHtml = '<table border="1"><thead><tr>' +
            '<th>Título</th>' +
            '<th>Data</th>' +
            '<th>Responsável</th>' +
            '<th>Empresa</th>' +
            '<th>Status</th>' +
            '<th>Prioridade</th>' +
            '<th>Recorrência</th>' +
            '<th>Tempo Em andamento</th>' +
            '<th>Descrição</th>' +
            '</tr></thead><tbody>';

        list.forEach(t => {
            const companyName = getCompanyNameById(t.companyId);
            const timeText = formatTimeSpent(t.timeSpentMs || 0);

            tableHtml += '<tr>' +
                `<td>${(t.title || '').replace(/<\/?[^>]+(>|$)/g, '')}</td>` +
                `<td>${formatDateBR(t.date || '')}</td>` +
                `<td>${t.responsible || ''}</td>` +
                `<td>${companyName || ''}</td>` +
                `<td>${t.status || ''}</td>` +
                `<td>${t.priority || ''}</td>` +
                `<td>${t.recurrence || 'Nenhuma'}</td>` +
                `<td>${timeText}</td>` +
                `<td>${(t.description || '').replace(/<\/?[^>]+(>|$)/g, '')}</td>` +
                '</tr>';
        });

        tableHtml += '</tbody></table>';

        const htmlFile =
            `<html><head><meta charset="UTF-8"></head><body>${tableHtml}</body></html>`;

        const blob = new Blob([htmlFile], {
            type: 'application/vnd.ms-excel'
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tarefas_${getTodayStr()}.xls`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Tabela de "Todas as tarefas" (página Tarefas)
    function renderTasksTable() {
        const container = document.getElementById('tasksTable');
        if (!container) return;

        if (!currentUser || currentUser.role !== 'Gestor') {
            container.innerHTML = '<p class="small-text">Apenas Gestores podem visualizar todas as tarefas.</p>';
            return;
        }

        const visible = getFilteredTasksList();

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa cadastrada nesse período.</p>';
            return;
        }

        let html = '<table><thead><tr>' +
            '<th>Título</th><th>Data</th><th>Responsável</th><th>Empresa</th>' +
            '<th>Status</th><th>Prioridade</th><th>Tempo Em andamento</th><th>Ações</th></tr></thead><tbody>';

        visible.forEach(t => {
            const canDelete = currentUser.role === 'Gestor';
            const statusClass = 'tag-' + (t.status || '').replace(/\s+/g, '-');
            const priorityClass = 'tag-' + (t.priority || '');

            html += `<tr>
                <td>${t.title}</td>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
                <td>${formatTimeSpent(t.timeSpentMs || 0)}</td>
                <td class="actions">
                    ${canDelete ? `<button onclick="deleteTask('${t.id}')">Excluir</button>` : ''}
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function updateTaskStatus(id, newStatus) {
        const t = tasks.find(t => t.id === id);
        if (!t) return;

        applyStatusChange(t, newStatus);
        db.collection('tasks').doc(t.id).set(t);

        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        renderTasksTable();
    }

    function updateTaskPriority(id, newPriority) {
        const t = tasks.find(t => t.id === id);
        if (!t) return;
        t.priority = newPriority;
        db.collection('tasks').doc(t.id).set(t);
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
        renderTasksTable();
    }

    function deleteTask(id) {
        if (currentUser.role !== 'Gestor') {
            alert('Somente Gestores podem excluir tarefas.');
            return;
        }
        if (!confirm('Deseja realmente excluir esta tarefa?')) return;

        const t = tasks.find(t => t.id === id);
        if (t) {
            applyStatusChange(t, 'Pendente');
        }

        tasks = tasks.filter(t => t.id !== id);
        db.collection('tasks').doc(id).delete();
        renderTasksTable();
        renderTasksOverview();
        renderCalendar();
        renderInProgressTasks();
        if (selectedDate) renderDayTasks(selectedDate);
    }

    function renderTasksOverview() {
        const container = document.getElementById('tasksOverview');
        if (!container) return;

        const visible = sortTasks(getVisibleTasks());

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa cadastrada.</p>';
            return;
        }

        let html = '<table><thead><tr><th>Data</th><th>Título</th><th>Resp.</th>' +
            '<th>Empresa</th><th>Status</th><th>Prioridade</th></tr></thead><tbody>';

        visible.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;
            html += `<tr>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.title}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ============================ LISTA EM ANDAMENTO =========================
    // Colunas: Título, Data, Responsável, Empresa, Status, Prioridade
    function renderInProgressTasks() {
        const container = document.getElementById('inProgressList');
        if (!container) return;

        const list = sortTasks(
            getVisibleTasks().filter(t => t.status === 'Em andamento')
        );

        if (!list.length) {
            container.innerHTML = 'Nenhuma tarefa em andamento.';
            return;
        }

        let html = '<table><thead><tr>' +
            '<th>Título</th><th>Data</th><th>Responsável</th><th>Empresa</th><th>Status</th><th>Prioridade</th>' +
            '</tr></thead><tbody>';

        list.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;

            html += `<tr class="clickable-row" onclick="selectTaskForEdit('${t.id}')">
                <td>${t.title}</td>
                <td>${formatDateBR(t.date)}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ============================ CALENDÁRIO ================================

    function renderCalendar() {
        const calendarDiv = document.getElementById('calendar');
        const monthLabel = document.getElementById('monthLabel');
        const today = new Date();
        const todayStr = getTodayStr();

        if (currentMonth === undefined || currentYear === undefined) {
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
        }

        const firstDay = new Date(currentYear, currentMonth, 1);
        const startingDay = firstDay.getDay();
        const monthLength = new Date(currentYear, currentMonth + 1, 0).getDate();

        const monthNames = [
            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        monthLabel.innerText = `${monthNames[currentMonth]} de ${currentYear}`;

        const visibleTasks = getVisibleTasks();
        const tasksByDay = {};
        visibleTasks.forEach(t => {
            if (!t.date) return;
            const d = parseLocalDate(t.date);
            if (!d) return;
            if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                const day = d.getDate();
                if (!tasksByDay[day]) tasksByDay[day] = [];
                tasksByDay[day].push(t);
            }
        });

        let html = '<table><thead><tr>' +
            '<th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th>' +
            '<th>Qui</th><th>Sex</th><th>Sáb</th></tr></thead><tbody><tr>';

        let day = 1;
        for (let i = 0; i < startingDay; i++) {
            html += '<td></td>';
        }

        for (let i = startingDay; i < 7; i++) {
            html += buildCalendarDayCell(day, monthLength, tasksByDay, todayStr);
            day++;
        }
        html += '</tr>';

        while (day <= monthLength) {
            html += '<tr>';
            for (let i = 0; i < 7 && day <= monthLength; i++) {
                html += buildCalendarDayCell(day, monthLength, tasksByDay, todayStr);
                day++;
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        calendarDiv.innerHTML = html;
    }

    function buildCalendarDayCell(day, monthLength, tasksByDay, todayStr) {
        if (day > monthLength) return '<td></td>';
        const d = new Date(currentYear, currentMonth, day);
        const dateStr = dateToISO(d);
        const isToday = dateStr === todayStr;
        const hasTasks = !!tasksByDay[day];
        const isSelected = selectedDate === dateStr;

        let classes = [];
        if (isToday) classes.push('today');
        if (isSelected) classes.push('selected');

        let html = `<td class="${classes.join(' ')}" onclick="selectDate('${dateStr}')">`;
        html += day;
        if (hasTasks) {
            html += '<div class="dot"></div>';
        }
        html += '</td>';
        return html;
    }

    function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        selectedDate = null;
        document.getElementById('dayTasksTitle').innerText = 'Tarefas do dia';
        document.getElementById('dayTasksList').innerHTML =
            '<span class="small-text">Selecione um dia no calendário para ver as tarefas.</span>';
        renderCalendar();
        renderInProgressTasks();
    }

    function selectDate(dateStr) {
        selectedDate = dateStr;
        renderCalendar();
        renderDayTasks(dateStr);
    }

    function renderDayTasks(dateStr) {
        const container = document.getElementById('dayTasksList');
        const title = document.getElementById('dayTasksTitle');
        title.innerText = 'Tarefas em ' + formatDateBR(dateStr);

        const visible = sortTasks(
            getVisibleTasks().filter(t => t.date === dateStr)
        );

        if (!visible.length) {
            container.innerHTML = '<p class="small-text">Nenhuma tarefa para este dia.</p>';
            return;
        }

        let html = '<table><thead><tr><th>Título</th><th>Resp.</th><th>Empresa</th><th>Status</th><th>Prioridade</th></tr></thead><tbody>';

        visible.forEach(t => {
            const statusClass = 'tag-' + t.status.replace(/\s+/g, '-');
            const priorityClass = 'tag-' + t.priority;
            html += `<tr class="clickable-row" onclick="selectTaskForEdit('${t.id}')">
                <td>${t.title}</td>
                <td>${t.responsible}</td>
                <td>${getCompanyNameById(t.companyId)}</td>
                <td><span class="tag ${statusClass}">${t.status}</span></td>
                <td><span class="tag ${priorityClass}">${t.priority}</span></td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function selectTaskForEdit(taskId) {
        const t = tasks.find(t => t.id === taskId);
        if (!t) return;

        editingTaskId = taskId;

        document.getElementById('taskTitle').value = t.title;
        document.getElementById('taskDate').value = t.date;
        document.getElementById('taskUser').value = t.responsible;
        document.getElementById('taskCompany').value = t.companyId;
        document.getElementById('taskStatus').value = t.status;
        document.getElementById('taskPriority').value = t.priority;
        document.getElementById('taskDescription').value = t.description || '';
        document.getElementById('taskRecurrence').value = t.recurrence || 'Nenhuma';

        document.getElementById('taskSubmitBtn').textContent = 'Atualizar tarefa';

        const delBtn = document.getElementById('taskDeleteBtn');
        if (currentUser && currentUser.role === 'Gestor') {
            delBtn.style.display = 'inline-block';
        } else {
            delBtn.style.display = 'none';
        }

        const cancelBtn = document.getElementById('taskCancelBtn');
        if (cancelBtn) cancelBtn.style.display = 'inline-block';
    }

    // ============================ INICIALIZAÇÃO ==============================

    document.addEventListener('DOMContentLoaded', async function () {
        await loadData();
        ensureDefaultAdmin();

        const savedUser = localStorage.getItem('miniERP_currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            applyAutoCarryOver();
            showApp();
        } else {
            showLogin();
        }

        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('userForm').addEventListener('submit', handleUserForm);
        document.getElementById('companyForm').addEventListener('submit', handleCompanyForm);
        document.getElementById('taskForm').addEventListener('submit', handleTaskForm);

        const taskDateInput = document.getElementById('taskDate');
        function fillTodayIfEmpty() {
            if (!taskDateInput.value) {
                taskDateInput.value = getTodayStr();
            }
        }
        taskDateInput.addEventListener('focus', fillTodayIfEmpty);
        taskDateInput.addEventListener('click', fillTodayIfEmpty);
        taskDateInput.value = getTodayStr();

        const recurrenceSelect = document.getElementById('taskRecurrence');
        if (recurrenceSelect) recurrenceSelect.value = 'Nenhuma';
    });
</script>

</body>
</html>
